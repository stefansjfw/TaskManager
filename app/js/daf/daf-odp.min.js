/*!
* Data Aquarium Framework - Offline Data Processor
* Copyright 2017-2024 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function k(n,t){t.forEach(function(t){var i=n[t];t in n&&(i==null||i===!1&&t!=="OldValue"||i===""||Array.isArray(i)&&!i.length)&&delete n[t]})}function o(n){return JSON.stringify({d:n})}function d(){return!n.offline()&&t.online()}function ct(n){return typeof n=="number"&&n<0||typeof n=="string"&&n.match(/^0{8}-0{4}-0{4}-0{4}-([\da-f]){12}$/)}function f(n){var i,t=[];return typeof n=="string"?t.push(n):Array.isArray(n)?t=n:i=n,{Tag:null,Errors:t,Values:[],Canceled:!1,NavigateUrl:null,ClientScript:null,RowsAffected:i||0,Filter:null,SortExpression:null,RowNotFound:!1}}function v(){var n=this,t=n.ItemsStyle;return n.ItemsDataController&&!(t==="AutoComplete"||t==="Lookup")}function s(n){return JSON.parse(JSON.stringify(n))}function y(n,i,r){var u=new t.OfflineDataProcessor(n,i);return r&&(u._enabled=r),u}function l(t,i){var f=this,r,u=t.ItemsTargetController;return u?(i||(i=f.Controller),r=$.Deferred(),n.getControllers(u).then(function(n){var e,f,u;n=n[0];n.fields.every(function(n){return n.items&&n.items.dataController===i&&(e=n),!e});n.fields.every(function(n){return n.items&&n.items.dataController===t.ItemsDataController&&(f=n),!f});u=f.items;u&&(t.ItemsDataValueField=u.dataValueField,t.ItemsDataTextField=u.dataTextField,t.ItemsDataView=u.dataView);r.resolve({targetForeignKey1:e.name,targetForeignKey2:f.name})}),r.promise()):$.when(!0)}function g(t){for(var f=n.controllers[t.Controller],e=t.Values,u=[],i,r=e.length-1;r>=0&&u.length<f.key.length;)i=e[r],f._map.key[i.Name]&&u.push(i.OldValue==null?i.NewValue:i.OldValue),r--;return JSON.stringify(u)}function lt(n,t){for(var u,r,f=n.Values,i=0;i<f.length;i++)if(r=f[i],r.Name===t){u=r;break}return u}function at(t,i){for(var f=0,h=n.controllers[i.Controller],r,e,u=i.Values,s=0,o;f<u.length;)r=u[f],o=!0,e=lt(t,r.Name),e?(r.Modified&&(e.NewValue=r.NewValue,e.Modified=!0),h._map.key[r.Name]&&s++):t.Values.push(r),u.splice(f,1),o=!1,o&&f++;u.length<=s&&u.splice(0)}function nt(n,t){for(var i,u,r,f,y,s,h,c,l,a,v,p,o;e.compressLog!==!1&&t&&t<n.length;){if(o=!0,f=null,i=n[t].args,y=i.Controller,view=i.View,s=i.CommandName,h=s==="Update",c=s==="Delete",p=i.SelectedValues||[],p.length<=1&&(h||c))for(r=t-1;r>=0;){if(u=n[r].args,l=u.CommandName,a=l==="Update",v=l==="Insert",u.Controller===y&&(f||(f=g(i)),g(u)===f))if(h&&(v||a)){at(u,i);i.Values.length||(n.splice(t,1),o=!1);break}else if(c)if(a)n.splice(r,1),t--;else if(v){n.splice(r,1);t--;n.splice(t,1);o=!1;break}r--}o&&t++}}function p(){if(!p.done){p.done=!0;var i=n.offline()?24:1;setTimeout(function(){var n=!1;for(var u in r)((new Date).getTime()-r[u])/1e3>3600*i&&(delete r[u],n=!0);n&&t.userVar("blobChangeLog",r)})}}var t=$app,u,n,tt=window,e,w=2147483647,b=Sys.CultureInfo.CurrentCulture.dateTimeFormat,h=Sys.CultureInfo.CurrentCulture.numberFormat,c=Web.DataViewResources.ODP,it=[{_m:"GetPage",_r:"request",Me:["SortExpression","FilterIsExternal","LookupContextFieldName","LookupContextController","LookupContextView","LookupContext","Inserting","LastCommandName","DoesNotRequireData","LastView","RequiresFirstLetters","SupportsCaching","SystemFilter","RequiresRowCount","RequiresPivot","PivotDefinitions","Filter","ExternalFilter","SyncKey","Tag"]},{_m:"Execute",_r:"args",Me:["CommandArgument","LastCommandName","LastCommandArgument","SaveLEVs","ContextKey","LastView","Filter","SortExpression","SelectedValues","ExternalFilter"],Values:["OldValue","ReadOnly","Error"]}],a=t.findDataView,r,rt=["None","Sum","Count","Average","Max","Min"],ut=["Thumbnail","Link","Signature"],ft=["Text","Password","RichText","Note","Static"],et=["Default","Required","Suggested","Allowed","Forbidden"],ot=/([\w\,\.]+):([\s\S]*)/,st=/^(_match_|_donotmatch_)\:(\$all\$|\$any\$)$/,ht=/(\*|\$\w+\$|=|~|<(=|>){0,1}|>={0,1})([\s\S]*?)(\0|$)/;n=t.odp={toDataUrl:function(n){return $.when(n)},toOriginalUrl:function(n){return $.when(n+"&_ticks="+(new Date).getTime())},download:function(n){u.openHref(n)},toThumbnail:function(n,t){var r={thumbnail:t};for(var i in n)i.match(/promise/)||(r[i]=n[i]);return r},convertBlob:function(n,t,i){function w(){var t=v.toDataURL(k,1),u,r,f;if(a.remove(),delete n.file,n.promise=null,p)n.dataUrl=t;else{for(u=atob(t.substring(t.indexOf("base64")+7)),f=new Uint8Array(new ArrayBuffer(u.length)),r=0;r<u.length;r++)f[r]=u.charCodeAt(r);t=f.buffer}s.resolve(t,k,i)}var c=n.file,l=n.promise,p=t==="dataurl",a,v,r,u,s,y,h;if(!l)if(s=$.Deferred(),l=n.promise=s.promise(),i){var b=n.file.type,k=n.type="image/png",f=80,e=80,o;a=$('<canvas width="'+f+'" height="'+e+'px"><\/canvas>');v=a[0];r=v.getContext("2d");b&&b.match(/^image\//)?(r.fillStyle="rgba(0,0,0,0)",r.fillRect(0,0,f,e),u=new Image,u.onload=function(){var n={w:f,h:e},h=u.width,s=u.height,t=n.h/n.w;h<n.w&&s<n.h?(n.w=h,n.h=s):h>s?(n.h=n.w*t,n.w=n.h*h/s):s>h?(t=n.w/n.h,n.w=n.h*t,n.h=n.w*s/h):(n.w=s*t,n.h=n.w);t=f/n.w;n.w<=n.h&&(t=e/n.h);t>1&&(t=1);n.w=n.w*t;n.h=n.h*t;o=n.w;i<2&&(o>n.h?(n.w+=(o-n.h)*2,n.h+=(o-n.h)*t*2):(n.w+=(n.h-o)*t*2,n.h+=(n.h-o)*2));r.drawImage(u,(f-n.w)/2,(e-n.h)/2,n.w,n.h);w();URL.revokeObjectURL(u.src)},u.src=URL.createObjectURL(n.file)):(r.fillStyle="#fff",r.fillRect(0,0,f,e),r.fillStyle="#000",r.font="20px arial",r.textAlign="center",y=(n.file.name||"").match(/(\..+)$/),r.fillText(y?y[1]:"",f/2,e/2+10),w())}else h=new FileReader,h.onload=function(t){n.promise=null;s.resolve(t.target.result,c.type,i)},p?h.readAsDataURL(c):h.readAsArrayBuffer(c);return l},blob:function(i,f){function w(){c.resolve(f)}function l(n,t){t||(t=u.dataView());var r,i=t&&t.odp;return i&&(r=i._files[n],r||(i=i._master,i&&(r=i._files[n]))),r}function b(t){var i=$.Deferred(),r=t.dataUrl;return r?i.resolve(r):t.file.type.match(/^image\//)&&n.convertBlob(s,"dataurl",t.thumbnail).done(function(n){i.resolve(n)}),i.promise()}var o,c,y,e;switch(i){case"init":var k=__baseUrl,d=f.field,nt=d._dataView,a=d.OnDemandHandler,tt=f.crop,it=f.format||"t",v=f.key,s,h=f.image,g=f.link;c=$.Deferred();f.href=String.format("{0}blob.ashx?{1}=o|{2}",k,a,v);g&&g.attr("data-href",f.href);f.src=String.format("{0}blob.ashx?{1}={4}|{2}{3}",k,a,v,tt!==!0?"&_nocrop":"",it);h&&h.attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7");s=l(f.src,nt);s?b(s).done(function(n){f.src=n;h&&h.attr(h.attr("data-observe")?"data-src":"src",n);w()}):(h&&(y=f.src,(n.offline("toDataUrl",y)||n.toDataUrl(y)).done(function(n){if(r=r||t.userVar("blobChangeLog"),r){var i=r[a+v];i&&(n+="&t="+i);p()}h.attr(h.attr("data-observe")?"data-src":"src",n)})),w());o||(o=c.promise());break;case"url":typeof f=="string"&&(f={href:f});e=f.href;e.match(/^data\:/)?o=$.when(e):(s=l(e,f.dataView),s?o=b(s):(o=n.offline("toDataUrl",e),o||(o=f.original?n.toOriginalUrl(e):n.toDataUrl(e))));break;case"download":typeof f=="string"&&(f={href:f});e=f.href;s=l(e,f.dataView);s?t.saveBlob(e):(o=n.offline("toDataUrl",{url:e,blob:!0}),o?o.done(t.saveBlob):n.download(e))}return o},blobUrlFormatStrings:function(n){var t=__baseUrl,i=[t+"blob.ashx?{0}=o|{1}"];return(typeof n=="string"&&n!=="Link"||n===0||n===2)&&i.push(t+"blob.ashx?{0}=t|{1}",t+"blob.ashx?{0}=t|{1}&_nocrop"),i},uploadFile:function(i){var f=n.offline("saveBlob",i),u=i.handler;return u||(u=i.field.OnDemandHandler),f||(f=t.uploadFileAjax({url:String.format("~/blob.ashx?{0}=u|{1}&_v={2}",u,i.key,i.apiVer),files:i.file||i.files,progress:i.progress})),r=r||t.userVar("blobCache")||{},r[u+i.key]=(new Date).getTime(),t.userVar("blobChangeLog",r),f},updateBlob:function(t,i){var r=i.controller,u=i.key,f=$.Deferred();return t.is("active"),t.tracking(r,!0),$.when(n.getControllers(r)).done(function(){t.getData(r,[{Name:i.keyField,Value:u}]).done(function(){t.select({from:r,where:{filter:"(this."+i.keyField+"===params.p0)",params:{p0:u}}}).then(function(n){var r,t;n.length&&(r=i.field,"new"in i||(t=n[0][r],i.new=t==null||typeof t=="string"&&!!t.match(/^null\|/)),n[0][r]=i.file.size?u.toString():null);f.resolve(i)})})}),f.promise()},upload:function(t){var r=t.field,e=r._dataView,u=e._controller,i=e.odp,s=i&&i._master,o=r.OnDemandHandler,f;return s?(f=$.Deferred(),i.is("active"),i.tracking(u,!0),$.when(n.getControllers(u)).done(function(){var l=t.key,a=n.controllers[u].key[0].name,h=t.files,e={file:h.length?h[0]:h,field:r.Name,keyField:a,controller:u,key:l,handler:o,apiVer:t.apiVer},v=!e.file.size,s=i._files,c=s.list,y=n.blobUrlFormatStrings(r.OnDemandStyle);c.every(function(n,t){var i=n.handler===e.handler&&n.key===e.key;return i&&c.splice(t,1),!i});y.forEach(function(t,i){var r=String.format(t,o,l),u=s[r],f;delete s[r];v||(s[r]=e);i?s[r]=n.toThumbnail(e,i):u&&(f=e.new=u.new);i||c.push(e)});f.resolve()}),result=f.promise()):result=n.uploadFile(t),result},enabled:function(t){var i=this,r=i._checkedSettings;return arguments.length&&(i._enabled=t===!0,r=!0),i._checkedSettings=!0,r||(typeof __settings!="undefined"&&(e=__settings&&__settings.odp),e||(e={}),$("body").data("offline")&&(e.enabled=!0),i._enabled=e.enabled===!0,n._pageSize=e.pageSize||100),u&&this._enabled===!0},offline:function(){return!1},get:function(n){var i=null,t;return u&&(t=n||u.dataView(),t&&(t._survey&&(t=a(t._survey.parent)),t&&(i=t.odp))),i},start:function(){n.controllers={};n._controllers={};n.functions={};n._pk={};n._sequence=0;n._pendingResponses={}},response:function(t,i){var r=n._pendingResponses;if(!r)return null;if(arguments.length===2)r[t]=i;else return i=r[t],i&&(r[t]=null),i},invoke:function(i,r){function b(){$.ajax(r).done(function(n){o.resolve(n)}).fail(function(n,t,i){o.reject(n,t,i)})}function p(){var u,c,s,l,v;t.odp.enabled()&&(f=i.odp,!f&&f!==!1&&e.match(/GetPage|GetListOfValues|Execute/)&&(u=i.tagged(/\odp\-enabled\-(\w+)\b/),u=u?u[1]:"auto",u!=="none"&&(i._dataViewFieldParentId?(c=a(i._filterSource),c&&(f=c.odp)):(s=i.get_parentDataView(),s?(i._filterSource&&(f=s.odp),f||(f=s.odp?s.odp:y(i,null,u))):n.offline("sync",{controller:i._controller})&&(f=y(i,null,u))),!f&&i._isModal&&(l=$app.touch.dataView(),l&&(f=l.odp))),i.odp=f),f&&f.invoke({method:e,dataView:i,params:r,deferred:o})&&(h=!1),h||(v=r.data.args,v&&v.CommandName==="AutoFill"&&(h=!0)))}var nt=this,rt=i.get_servicePath(),e=r.url.substring(rt.length+1),o=$.Deferred(),f,w=n.response(e),l="_"+i._id+"_prefetch",v=tt[l],h=!0,s,c;if(r.processData=!1,v&&e==="GetPage"&&(s=v.innerHTML.replace(/\]\_\[(\/?script.)\]\^\[/gi,"<$1"),c=s.match(/\"TimeStamp\"\:\"ts(\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2})\"/),c&&(i.pageProp(l)===c[1]?s=null:i.pageProp(l,c[1])),$(v).remove()),s)p(),o.resolve(s);else if(w)p(),o.resolve(w);else if(it.forEach(function(n){var i,t;if(JSON&&n._m===e)for(i in n)t=r.data,n._r&&(t=t[n._r]),t&&!i.match(/^_/)&&(i!=="Me"&&(t=t[i]),t&&(Array.isArray(t)?t.forEach(function(t){k(t,n[i])}):k(t,n[i])))}),p(),h){var ut=(e==="GetPage"||e==="Execute")&&!(i._api&&i._api.background),d=location.href,g=u?u.startUrl():d;r.data=t.toAjaxData(r.data);g!==d&&(r.headers||(r.headers={}),r.headers["X-Start-Url"]=g);ut?nt.ensureData().then(b):b()}return o.promise()},ensureData:function(){return n.offline("ensureData")||$.when(!0)},verify:function(t){var i=t.odp,r=t.get_isForm(),u;i&&(i.root(t)&&i.enabled()?($(t._fields).each(function(){if(this.Type==="DataView")return u=!0,!1}),(u||n.offline("sync",{controller:t._controller}))&&r||(t.odp=null)):r&&i.root()!==t&&(t.odp=y(t,i)))},getControllers:function(t){function o(){var n=[];t.forEach(function(t){n.push(r[t])});e.resolve(n)}function s(n){n.forEach(function(n){var t=n.dataController,i,u;r[t.name]=t;i=t._map={key:{},fields:{},views:{}};u=t.key=[];t.fields.forEach(function(n){i.fields[n.name]=n;n.isPrimaryKey&&(u.push(n),i.key[n.name]=n)});t.views.forEach(function(n){i.views[n.id]=n})});o();n.forEach(function(n){u[n.dataController.name].resolve()})}Array.isArray(t)||(t=[t]);var i=[],f=[],e=$.Deferred(),r=n.controllers,u=n._controllers;return t.forEach(function(n){if(!r[n]){var t=u[n];t||(i.push(n),t=u[n]=$.Deferred());f.push(t.promise())}}),i.length?n.offline("sync",{controller:i})?n.offline("query",{controller:i}).then(s):$.ajax({url:__servicePath+"/GetControllerList",method:"POST",cache:!1,dataType:"text",authorize:!0,data:JSON.stringify({controllers:i})}).then(function(n){var t=JSON.parse(JSON.parse(n).d);s(t)}):$.when.apply($,f).done(o),e.promise()},parseMap:function(i,r){function c(n){n.fieldName===h&&(u=n.aliasFieldName)}var s=n.controllers[i.controller],h=i.field,o=s._map.fields[h],e=o.items||{},f=e._copy,u;f||(f=e._copy=[],s.views.every(function(n){return n.categories&&n.categories.every(function(n){return n.dataFields.every(function(n){return c(n),!u}),!u}),n.dataFields&&n.dataFields.every(function(n){return c(n),!u}),!u}),u&&f.push({t:u,f:e.dataTextField||e.dataValueField}),t.parseMap(o,function(n,t){f.push({t:n,f:t})}));f.forEach(function(n){r.call(o,n.t,n.f)})},commit:function(i){function l(){a._busy(!1);r||(r=f(1));y.resolve(r);var n=i.deferred;n&&n.resolve(o(r))}function w(){var i;do i=a.uploadNextBlob(a._lastArgs.Values,r?r.Values:[]),i&&s.push(i);while(i);return e._files.list.forEach(function(t){t.new&&(!t.file.size||t.key.toString().match(/^\-/))||s.push(n.uploadFile(t))}),a._busy(!0),s.length?(u.notify({text:String.format(c.UploadingFiles,s.length)}),$.when.apply($,s).done(l).fail(function(){t.alert(c.UploadFailed).done(l)})):l(),s.length}var v=i.controller,e=i.odp,h=e._log,a=e._dataView,y=$.Deferred(),r,s=[],p;return h.length?(p=v===h[0].controller,$.ajax({url:__servicePath+"/commit",method:"POST",authorize:!0,cache:!1,dataType:"text",processData:!1,data:JSON.stringify({log:h})}).done(function(n){if(n=n?JSON.parse(n).d:{},n.Success){if(r=f(1),p&&h[0].args.CommandName==="Insert"&&n.Values.length){var t=n.Values[0];t.Controller===v&&r.Values.push({Name:t.Name,NewValue:t.Value,Modified:!0})}h.splice(0);e._files.list.forEach(function(t){n.Values.every(function(n){var i=n.Controller===t.controller&&n.Name===t.keyField&&n.OldValue===t.key;return i&&(t.key=n.NewValue),!i})});w()}else e.snapshot("restore"),r=f(n.Errors),l()}).fail(function(){e.snapshot("restore");r=f(c.UnableToSave);l()})):w(),y.promise()},func:function(t){var u,i,r;return t.match(/\)$/)||(t.match(/\bthis\./)&&(u=t.indexOf("{"),i=t.substring(0,u),i+="{var t=this",t.match(/\$app\.odp\.filters\./)&&(i+=",f=$app.odp.filters"),i+=";",t=i+t.substring(u+1).replace(/\bthis\./g,"t.").replace(/\$app\.odp\.filters\./g,"f.")),t="(function"+t+")"),r=n.functions[t],r||(r=n.functions[t]=eval(t)),r},compare:function(n,t){return n==null?t==null?0:-1:t==null?1:(typeof n=="string"&&(n=n.toUpperCase()),typeof t=="string"&&(t=t.toUpperCase()),n<t)?-1:n>t?1:0},filters:{_regexCache:{},_inrange:function(n,t){return n===t},_eq:function(n,t){return n==null||t==null?!1:n==t},_like:function(t,i){if(t==null||i==null)return!1;var r=n.filters._regexCache[i],u;return r||(u=i,i.match(/^\%/)?(i=i.substring(1),i.match(/\%$/)?(i=i.substring(0,i.length-1),r=new RegExp(RegExp.escape(i),"i")):r=new RegExp(RegExp.escape(i)+"$","i")):i.match(/\%$/)?(i=i.substring(0,i.length-1),r=new RegExp("^"+RegExp.escape(i),"i")):r=new RegExp("^"+RegExp.escape(i)+"$","i"),n.filters._regexCache[u]=r),typeof t!="string"&&(t=t.toString()),t.match(r)!=null},beginswith:function(n,t){return n==null||t==null?!1:(typeof n!="string"&&(n=n.toString()),typeof t!="string"&&(t=t.toString()),n=n.toUpperCase(),t=t.toUpperCase(),!n.indexOf(t))},doesnotbeginwith:function(){return!1},contains:function(){return!1},doesnotcontain:function(){return!1},endswith:function(){return!1},doesnotendwith:function(){return!1},between:function(){return!1},"in":function(n,t){if(n==null)return!1;Array.isArray(t)||(t=[t]);var i=!1;return t.every(function(t){return n==t&&(i=!0),!i}),i},notin:function(n,t){return!this.in(n,t)},month1:function(){return!1},month2:function(){return!1},month3:function(){return!1},month4:function(){return!1},month5:function(){return!1},month6:function(){return!1},month7:function(){return!1},month8:function(){return!1},month9:function(){return!1},month10:function(){return!1},month11:function(){return!1},month12:function(){return!1},thismonth:function(){return!1},nextmonth:function(){return!1},lastmonth:function(){return!1},quarter1:function(){return!1},quarter2:function(){return!1},quarter3:function(){return!1},quarter4:function(){return!1},thisquarter:function(){return!1},lastquarter:function(){return!1},nextquarter:function(){return!1},thisyear:function(){return!1},nextyear:function(){return!1},lastyear:function(){return!1},yeartodate:function(){return!1},thisweek:function(){return!1},nextweek:function(){return!1},lastweek:function(){return!1},today:function(){return!1},yesterday:function(){return!1},tomorrow:function(){return!1},past:function(){return!1},future:function(){return!1},"true":function(){return!1},"false":function(){return!1},isempty:function(n){return n==null},isnotempty:function(n){return n!=null}},pk:function(t,i){var r=n.offline("pk",{controller:t});return r===!1&&(r=n._pk[t],r==null&&(r=n._pk[t]=0),r--,n._pk[t]=r),i.match(/(Guid|String)/)&&(r="000000000000"+(r*-1).toString(16),r="00000000-0000-0000-0000-"+r.substr(r.length-12)),r}};t.OfflineDataProcessor=function(t,i){var r=this,f,e,u,o;if(r._cache={},r._sequence=n._sequence++,r._date=new Date,r._dataView=t,r._state="inactive",r._data={},r._log=[],r._dataLoadMap={},r._dataLoadedKeys={},r._dataLoadAll={},r._tracking={},f=r._files={},r._master=i,i){e=i._files;for(u in e)o=e[u],f[u]=u==="list"?o.slice(0):o;r._tracking=s(i._tracking)}else f.list=[]};t.OfflineDataProcessor.prototype={is:function(n){var t=this,i;if(arguments.length){if(n.match(/^:/))return n===":dirty"?(i=t._files.list,t._log.length>0||t._dataView._pendingUploads!=null||i.length&&i._dirty):t._state===n.substring(1);t._state=n}else return t._state},enabled:function(){return this._enabled!=="none"},root:function(n){return arguments.length===1?this._dataView===n:this._dataView},snapshot:function(n){var t=this,i=t._snapshot;n==="restore"?i&&(t._log=JSON.parse(i)):t._snapshot=JSON.stringify(t._log)},invoke:function(i){function g(n){var u=i.params.data,f=u.args;return f.Date=t.stringifyDate(arguments.length?n:new Date),f.Sequence=r._sequence,u}function rt(n){var i,t;if(w||(w=$.Deferred(),i=!0),d||(d=n),t=it[ot++],t){var r=t.args,f=t.controller,e=$.Deferred(),o={deferred:e,method:"Execute",params:{data:t}};r.Sequence=u._sequence;u.tracking(f,!0);$.when(u.getData(f,r.ExternalFilter)).done(function(){u.execute(o)});$.when(e.promise()).then(rt)}else w.resolve(d);return i?w.promise():null}function ut(){var t,l,s;u.snapshot();t=u._log;l=t.length;h.forEach(function(n){t.push(n)});s=e.get_parentDataView()._dataViewFieldOwnerId;s&&h.forEach(function(n){n.owner=s});it=h.slice(0);$.when(rt()).done(function(s){var y=c?s:o(f(1)),p=JSON.parse(y).d;if(p.Errors.length)r.snapshot("restore"),u.snapshot("restore"),i.deferred.resolve(y);else{var b=[],w=u._files,a=w.list,v;do v=e.uploadNextBlob(k.Values,p?p.Values:[]),v&&(b.push(v),a._dirty=!0);while(v);$.when.apply($,b).then(function(){var f,s,c;e._busy(!1);var o=r._files,v=o.list,p=[];for(f in o)f!=="list"&&(s=w[f],s&&(c=a.indexOf(s),c!==-1&&a.splice(c,1)),w[f]=o[f]);v.forEach(function(t){if(a.indexOf(t)===-1){var i=!0;a.every(function(n){return n.controller===t.controller&&n.field===t.field&&n.key===t.key&&(n.file=t.file,i=!1),i});i&&a.push(t);p.push(n.updateBlob(u,t))}});v._dirty&&(a._dirty=!0);$.when.apply($,p).then(function(){h.splice(0);o.list=[];nt(t,l);i.deferred.resolve(y)})})}})}function ft(){l.match(/^(GetPage|Execute|GetListOfValues)$/)&&r.tracking(e)&&(s=i.params.data.controller,$.when(n.getControllers(s)).done(function(){!p.inserting()||l!=="GetPage"||i.params.data.request.ExternalFilter||r._dataLoadAll[s]||(r._dataLoadAll[s]=!0);$.when(r.ensureData(s,l)).done(function(){p.inserting()&&r._dataLoadAll[s]||l==="Execute"&&v==="Insert"?r.execute(i):$.when(r.getData(s,e.get_externalFilter())).done(function(){r.execute(i)})})}),tt=!0)}var r=this,u=r._master,h=r._log,tt,e=i.dataView,s=e._controller,k=e._lastArgs,v=k?k.CommandName:"",p=r._dataView,et=p===e,l=i.method,ot=0,it,w,d,b,c,y;if(et){if(l==="GetPage"&&e.get_lastCommandName()==="New")r.is("active");else if(l==="Execute"){if(r.snapshot(),c=v==="Insert"||v==="Delete"&&u,c||i.params.data.args.Values.every(function(n){var t=!0;return n.Modified&&(c=!0,t=!1),t}),!u&&n.offline("sync",{controller:s}))return b=i.deferred,i.deferred=$.Deferred(),v!=="Update"||c?(c=!0,ft(),i.deferred.done(function(t){var i=JSON.parse(t).d;i.Errors.length?(r.snapshot("restore"),e.get_parentDataView()||(e.odp=null),b.resolve(t)):n.offline("commit",{dataView:e,changes:g(r._date)}).then(function(){b.resolve(t)})})):n.offline("commit",{dataView:e}).then(function(){b.resolve(o(f(1)))}),!0;if(v.match(/^(Insert|Update|Delete)$/)){if(c||r.is(":dirty")){if(c){for(y=0;y<h.length&&h[y].owner!==e._id;)y++;h.splice(y,0,g(r._date))}return u?(u.is("active"),executeDeferredList=[],c?$.when(n.getControllers(s)).done(ut):ut()):n.commit({odp:r,controller:s,deferred:i.deferred}),!0}return v==="Update"?(i.deferred.resolve(o(f(1))),!0):!1}}}else if(l==="Execute"&&v.match(/^(Insert|Update|Delete)$/))r.is("active"),h.push(g()),nt(h,h.length-1),r.tracking(s,!0),e._filterSource||r._dataLoadAll[s]!=null||(r._dataLoadAll[s]=!0);else if(l==="GetPage"&&p.inserting()){for(u=e;u&&u._filterSource;)u=a(u._filterSource);u&&u!==e&&u.inserting()&&r.tracking(s,!0)}return ft(),!!tt},tracking:function(t){var r=arguments.length===1,i;if(typeof t!="string"&&(t=t._controller),r&&n.offline("sync",{controller:t}))return!0;if(i=this._tracking,r)return!!i[t];i[t]=arguments[1]},ensureData:function(t,i){var u=this,r=$.Deferred();return i!=="Execute"&&u._dataLoadAll[t]||n.offline("sync",{controller:t})?u.getData(t).done(function(){r.resolve()}):r.resolve(),r.promise()},_borrowData:function(n){var i=this,t=i._master,r;if(!i._data[n])while(t)if(r=t._data[n],r){i._data[n]=s(r);i._dataLoadMap[n]=s(t._dataLoadMap[n]||{});i._dataLoadedKeys[n]=s(t._dataLoadedKeys[n]||{});i._dataLoadAll[n]=s(t._dataLoadAll[n]||{});break}else t=t._master},getData:function(i,r){function c(){var n=u._data[i];y.resolve(n)}function p(e){var s=n._pageSize;t.execute({controller:i,view:"offline",pageSize:s,pageIndex:e,requiresRowCount:!e,externalFilter:r,odp:!1,nativeDates:!1,background:!0}).done(function(n){var t=n[i];f||(f=l[a]=[]);f.push(JSON.stringify(t));e||(o=n.totalRowCount);u.addData(i,t);o-=s;o<0?c():p(e+1)})}var u=this,y=$.Deferred(),o,l,s,h,a,f,v,e;if(u._borrowData(i),e=u._dataLoadMap[i],e||(e=u._dataLoadMap[i]={}),h=r&&r.length?JSON.stringify(r):"_all",a=i+"$"+h,e._all||e[h])c();else if(n.offline("sync",{controller:i}))e._all=!0,n.offline("query",{data:i}).then(function(n){u.addData(i,n);c()});else{for(e[h]=!0,s=u;s._master;)s=s._master;l=s._cache;f=l[a];f?(o=0,f.forEach(function(n){n=JSON.parse(n);o+=n.length;u.addData(i,n)}),c()):(h==="_all"&&(e._all=!0),v=!0,r&&r.every(function(n){var t=n.Value;return typeof t=="string"&&(t=t.match(/^%js%/)?JSON.parse(t.substring(4)):parseInt(t)),ct(t)&&(v=!1),v}),v?p(0):(u.addData(i,[]),f||(f=l[a]=[]),c()))}return y.promise()},addData:function(t,i){var r=this,e=n.controllers[t].key,u=r._dataLoadedKeys[t],f=r._data[t],o=(r._dataLoadMap[t]||{})._all;o&&!f?r._data[t]=i:(u||(u=r._dataLoadedKeys[t]={}),f||(f=r._data[t]=[]),i.forEach(function(n){var t=[];e.forEach(function(i){t.push(n[i.name])});t=t.join(",");u[t]||(u[t]=!0,f.push(n))}))},execute:function(i){function s(n){i.deferred.resolve(o(n))}function ut(n){var t=f();t.Errors=[n];s(t)}function ti(i){function r(){f.resolve()}function s(){var h=e[0];if(h){var o=h.dataView,v=o&&o.filterFields,l,a=[];v?(e.splice(0,1),i.forEach(function(n){a.push(n[w.key[0].name])}),l=o.controller,t.execute({odp:u,background:!0,controller:l,pageSize:1,_filter:[o.filterFields+":$in$"+a.join("$or$")]}).then(function(t){var i=t.totalRowCount,r=n.controllers[l];i?(u._log.splice(0,1),f.reject(String.format(c.UnableToDelete,h.label,i))):s()})):r()}else r()}var f=$.Deferred(),e=[],o=[];return y&&i.length&&w.key.length===1?(w.fields.forEach(function(n){var t=n.dataView;n.type==="DataView"&&t&&!t.filterSource&&(e.push(n),o.push(t.controller))}),o.length?n.getControllers(o).then(s):r()):r(),f.promise()}function dt(i){function a(n){var e=n&&n.errors||[],i;e.length?o.reject(e):(i=f[0],i?(f.splice(0,1),i.odp=u,i.background=!0,t.execute(i).then(a)):(y&&h&&r.length!==s&&r.indexOf(h)>=0&&(r.splice(s-1,1),r.push(h)),o.resolve()))}var o=$.Deferred(),c=[],f=[],v=w.key[0].name,r=u._log,s=r.length,h=r[y?s-1:0];return w.fields.forEach(function(r){var k=r.items,a=k&&k.targetController,p,d,g=r.name,s,o,h,w,nt;a&&(b.every(function(n){return n.Name===g&&(s=n),!s}),s&&s.Scope!=="client"?s.Scope="client":s={Name:g},o=s.OldValue,(lt||rt)&&(h=s.Modified?s.NewValue:s.OldValue),o=o==null?[]:o.toString().split(/,/g),h=h==null?[]:h.toString().split(/,/g),w=o.length!==h.length,w||h.every(function(n){return o.indexOf(n)===-1&&(w=!0),!w}),w&&(d=$.Deferred(),c.push(d.promise()),p=k.dataController,nt={ItemsDataController:p,ItemsTargetController:a,ItemsDataValueField:k.dataValueField},n.getControllers([p,a]).then(function(r){var s=r[1];l(nt,e).then(function(r){var b=[],c=r.targetForeignKey1,e=r.targetForeignKey2,l=[],k=[],w;i.forEach(function(t){var i=t[v];y&&(o=t[g],o=o==null?[]:o.toString().split(/,/g));o.forEach(function(n){h.indexOf(n)===-1&&f.push({controller:a,command:"Delete",LastCommandName:"Select",values:[{Name:c,OldValue:i},{Name:e,OldValue:n},{Name:"_SurrogatePK",OldValue:[r.targetForeignKey1,r.targetForeignKey2]}]})});h.forEach(function(r){if(o.indexOf(r)===-1){var u=[{Name:c,Modified:!0,NewValue:i},{Name:e,Modified:!0,NewValue:r}];n.parseMap({controller:a,field:c},function(n,i){var r={Name:n,NewValue:t[i]},f=s._map.fields[n];f&&f.readOnly&&(r.ReadOnly=!0);u.push(r)});l.push(u);k.push(r)}})});l.length&&(w=$.Deferred(),b.push(w.promise()),t.execute({odp:u,controller:p,_filter:[e+":$in$"+k.join("$or$")]}).then(function(t){var i={};t[p].forEach(function(n){i[n[e]]=n});l.forEach(function(t){var r=i[t[1].NewValue];n.parseMap({controller:a,field:e},function(n,i){var u={Name:n,NewValue:r[i]},f=s._map.fields[n];f&&f.readOnly&&(u.ReadOnly=!0);t.push(u)});f.push({controller:a,command:"Insert",LastCommandName:"New",values:t})});w.resolve()}));$.when.apply($,b).then(function(){d.resolve()})})})))}),$.when.apply($,c).then(a),o.promise()}var u=this,ot=i.method,g=i.params.data,yt=g.request,e=g.controller,w=n.controllers[e],it=g.args||{},b=it.Values,nt=it.CommandName,rt=nt==="Update",y=nt==="Delete",lt=nt==="Insert",pt=it.SelectedValues||[],wt=it.LastCommandName==="BatchEdit"&&rt||y&&pt.length>1,st=w._map,a=[],p={},bt=0,kt,ht,r,ft,tt,gt,k,et,at,ni,ct,h,vt;if(u._borrowData(e),ot==="Execute")if(r=f(),ft=[],(rt||y||lt)&&n.offline("forget",{controller:e}),rt||y)b.every(function(n){var t=n.Name;return st.key[t]?ft.push(t):t==="_SurrogatePK"&&(ft=n.OldValue),ft.length<w.key.length}),b.forEach(function(n){var t=n.Name;ft.indexOf(t)>=0&&(a.length&&a.push("&&"),a.push("(this."+t+"==params.p"+bt+")"),p["p"+bt++]=n.OldValue)}),wt&&(kt=a.join(""),a=[],pt.forEach(function(n,t){var i=String.format("{0:d4}",t);a.length&&a.push("||");a.push(kt.replace(/(==params\.p)(\d+)/g,"$1"+i+"$2"));n=n.split(/,/g).forEach(function(n,t){p["p"+i+t]=n})})),u.select({from:e,where:{filter:a.join(""),params:p},limit:y||wt?Number.MAX_VALUE:1}).done(function(n){ti(n).then(function(){dt(n).then(function(){var t=n.length;r.RowsAffected=t;r.RowNotFound=!t;t?rt?(n.forEach(function(n){b.forEach(function(t){t.Modified?n[t.Name]=t.NewValue:t.ReadOnly&&(n[t.Name]=t.OldValue)})}),s(r)):u.select({from:e,where:{filter:a.join(""),params:p},limit:Number.MAX_VALUE,remove:y}).done(function(){s(r)}).fail(ut):s(r)}).fail(ut)}).fail(ut)}).fail(function(n){i.dataView&&u._log.splice(u._log.length-1);ut(n)});else if(lt){tt={};gt=st.fields.Status;ht=u._data[e];b.forEach(function(n){(n.Name!=="Status"||gt)&&(tt[n.Name]=n.NewValue)});ht||(ht=u._data[e]=[]);ht.push(tt);r.RowsAffected=1;for(k in st.key)if(tt[k]==null){et=n.pk(e,st.key[k].type);tt[k]=et;r.Values.push({Name:k,NewValue:et,Modified:!0});b.every(function(n){return n.Name===k&&(n.NewValue=et,n.Modified=!0,at=n),!at});at||b.push({Name:k,NewValue:et,Modified:!0});break}dt([tt]).then(function(){s(r)}).fail(ut)}else nt==="Calculate"?w.calculateOnServer&&d()?(p=i.params,p.data=t.toAjaxData(p.data),p.processData=!1,$.ajax(p).done(function(n){r=JSON.parse(n).d;s(r)}).fail(function(){s(r)})):s(r):nt==="PopulateDynamicLookups"?(ni={Controller:e,View:g.view,RequiresMetaData:!0,MetadataFilter:["items","fields"]},u._viewPage(ni,{contextValues:it.Values}).done(function(n){n.Fields.forEach(function(n){n.ContextFields&&v.call(n)&&r.Values.push({Name:n.Name,NewValue:n.Items})});s(r)})):t.alert("Unsupported command "+nt,function(){s(r)});else ot==="GetPage"?(ct=yt,ct.Controller=e,ct.View=g.view,u._viewPage(ct).done(function(n){delete n._fieldMap;delete n._metadataFilter;s(n)})):ot==="GetListOfValues"?(h=yt,h.Controller=e,h.View=g.view,h.Distinct=!0,h.PageSize=Number.MAX_VALUE,h.PageIndex=0,vt=h.FieldName,h.FieldFilter=[vt],h.MetadataFilter=["fields"],h.DoesNotRequireAggregates=!0,h.SortExpression=vt,u._viewPage(h).done(function(n){var t=[];n.Rows.every(function(n){return t.push(n[0]),t.length<1e3});s(t)})):t.alert("Unknown method: "+ot)},select:function(t){function b(){v.resolve(r,l)}var u=this,v=$.Deferred(),h=t.from,c=t.where,w=t.remove,f=c?c.filter:null,y=t.sort,e=typeof h=="string"?u._data[h]||[]:h,r=[],o=[],l=t.index?[]:null,p,s,i,a;if(t.yield)r=t.yield;else{if(s=$.Event("viewfilter.odp.app",{odp:u,controller:u._dataView._controller,view:u._dataView._viewId}),$(document).trigger(s),s.filter&&(f=(f?"("+f+")&&":"")+("("+s.filter+")")),f){for(p=n.func("(params,rowIndex){return "+f+"}"),i=0;i<e.length;i++)if(a=e[i],p.call(a,c.params,i+1)&&(r.push(a),l&&l.push(i+1),w&&o.push(i),t.limit===r.length))break;if(o.length)for(i=o.length-1;i>=0;i--)e.splice(o[i],1)}else r=e.slice(0);y&&r.sort(n.func(u._sortFunc(y)))}return b(),v.promise()},key:function(t){var r=[],u=t._controller,i=t.inserting()?t._newRow:t._rows[0];return i&&t._keyFields.forEach(function(t){var f=t.Type,e=t.Index,o=f==="Guid"||t.Len===36,s;(f!=="String"||o)&&(s=i[e],s==null&&(t.isReadOnly()||o)&&(i[e]=n.pk(u,f)));r.push(i[t.Index])}),r},_sortFunc:function(n){var t=["(a,b){"],r=/(\w+)(\s+(asc|desc))?/ig,i=r.exec(n),u=!0;for(t.push("var result=0;");i;)u?u=!1:t.push("if (result != 0) return result;"),t.push(String.format("result = ($app.odp.compare(a.{0},b.{0}))",i[1])),i[3]&&i[3].match(/^desc/i)&&t.push("if (result != 0) result *=-1;"),i=r.exec(n);return t.push("return result;"),t.push("}"),t.join("\n")},_viewPage:function(r,u){function wt(){f=n.controllers[nt];y?e=f._map.views[y]:(e=f.views[0],y=r.View=e.id)}function bt(n){var t=this;t.PageSize!==1e3||t.SortExpression||(t.SortExpression=n.sortExpression)}function kt(n){var t=this,i,r;t.Tag=n.Tag;t.DistinctValueFieldName=n.FieldName;t.PageOffset=n.PageOffset||0;t.RequiresMetaData=n.PageIndex===-1||n.RequiresMetaData;t.RequiresRowCount=n.PageIndex<0||n.RequiresRowCount;t.PageIndex=0;n.PageIndex===-2&&(n.PageIndex=0);t.PageSize=n.PageSize;n.RequiresPivot&&(t.RequiresPivot=!0,t.RequiresMetaData=!1,t.RequiresRowCount=!1,t.PageSize=Number.MAX_VALUE);n.PageIndex>0&&(t.PageIndex=n.PageIndex);t.Rows=[];t.Fields=[];t.SortExpression=n.SortExpression;t.GroupExpression=n.GroupExpression;t.Filter=n.Filter;t.SystemFilter=n.SystemFilter;t.TotalRowCount=-1;t.Views=[];t.ActionGroups=[];t.Categories=[];t.Controller=n.Controller;t.View=n.View;t.LastView=n.LastView;t.ViewType=n.ViewType;t.SupportsCaching=n.SupportsCaching;t.QuickFindHint=n.QuickFindHint;t.InnerJoinPrimaryKey=n.InnerJoinPrimaryKey;t.InnerJoinForeignKey=n.InnerJoinForeignKey;t.RequiresSiteContentText=n.RequiresSiteContentText;t.FieldFilter=n.FieldFilter;t._metadataFilter=n.MetadataFilter;t.Distinct=n.Distinct;i="Form";r=n.Tag;r&&r.match(/\bview\-type\-inline\-editor\b/)&&(i="Grid");t._staticLookupViewTypeFilter=i}function s(n){var t=this._metadataFilter;return t==null||t.indexOf(n)!==-1}function tt(){var n=this,t=[];return n.Distinct||n.Fields.forEach(function(n){n.IsPrimaryKey&&t.push(n)}),t}function gt(n){var t=n.Expressions=[];s.call(n,"expressions")&&f.expressions.forEach(function(i){(i.ViewId==null||i.ViewId===n.View)&&t.push(i)})}function it(n){var t=this,i=t.HeaderText||t.Label||t.Name;return i=i.replace(/\s/g,""),n=new RegExp("^"+RegExp.escape(n.replace(/\s/g,"")),"i"),i.match(n)}function ni(n){var t=e.categories||[];t.forEach(function(t,i){n.Categories.push({Id:t.id,Index:i,HeaderText:t.headerText,Description:t.description?t.description["@value"]:null,Tab:t.tab,Wizard:t.wizard,Flow:t.flow,Wrap:t.wrap===!0,Floating:t.floating===!0,Collapsed:t.collpased===!0})});t.length||n.Categories.push({Id:null,Index:0})}function ti(){}function p(n){var r=n,t,u,i;if(n!=null){for(typeof n=="string"?(t=n.split(/(?:\$(?:and|or)\$)/g),u=t.length>1):t=[n],i=0;i<t.length;i++)n=t[i],n!=null&&n.match(/^%js%/)&&(t[i]=n.length>4?JSON.parse(n.substring(4)):null);r=u?t:t[0]}return r}function ct(n){return n==="null"||n==="%js%null"}function lt(i,r){var e={},s=0,c=r.QuickFindHint,f=!0,o=0,v=!0,l="&&",a=!1,y=r.Filter,u=[];return r.Fields.every(function(n){var t=n.SearchOptions;if(t&&t.match(/\$quickfind(?!disabled)/))return a=!0,!1}),y&&y.forEach(function(i){var pt=i.match(st),gt,rt,ft,wt,et,bt,ut,vt,kt,dt,tt,yt,nt,ui,d;if(pt&&(gt=pt[1]==="_donotmatch_",gt&&v&&(v=!1,f||u.push(")\n"),o>0&&u.push(")\n"),(!f||o>0)&&u.push("&&\n"),o=0,u.push(" !\n"),f=!0),o?(u.push(")\n"),u.push("||\n")):(f||u.push(") &&\n"),u.push("(\n")),l=pt[2]==="$all$"?" && ":" || ",o++,f=!0),rt=i.match(ot),rt&&(ft=!0,wt=" || ",rt[2].match(/>\|</)&&(wt=" && "),et=rt[2].match(ht),et)){var w=rt[1],y=et[1],k=et[3];if(y==="~"&&w==="_quickfind_"&&(w=r.Fields[0].Name),bt=w.match(/,/),ut=n.controllers[r.Controller]._map.fields[w],(ut!=null&&ut.allowQBE!==!1||y==="~")&&(r.DistinctValueFieldName!==ut.name||o>0||y==="~"||r.AllowDistinctFieldInFilter)||bt)if(ft?(f?(u.push("(\n"),f=!1):u.push(l),u.push("("),ft=!1):u.push(wt),bt){var ni=w.substring(0,w.indexOf(",")),fi=w.substring(ni.length+1),ei=ni+i.indexOf(":");ti(fi,r,u,ei)}else if(y==="~"){k=p(k);for(var lt=[],ii=[lt],oi=new RegExp(RegExp.escape(h.NumberGroupSeparator+h.CurrencyGroupSeparator+h.CurrencySymbol),"gi"),si="\\p{L}\\d"+RegExp.escape(b.DateSeparator+b.TimeSeparator+h.NumberDecimalSeparator),ri=new RegExp('\\s*(((")(.+?)")|((\\u{27})(.+?)\\u{27})|(,|;|(^|\\s+)-)|(['+si+"]+))","giu"),g=ri.exec(k),at=!1;g;)vt=g[1].trim(),vt===","||vt===";"?(lt=[],ii.push(lt),at=!1):vt==="-"?at=!0:(kt="=",g[3]||g[6]||(kt=" "),dt=" ",at&&(dt="-",at=!1),tt=g[4],tt==null&&(tt=g[7]),tt==null&&(tt=g[10]),lt.push(dt+kt+tt)),g=ri.exec(k);yt=!0;ii.forEach(function(n){yt?yt=!1:u.push("||\n");u.push("(\n");var i=!0;n.forEach(function(n){var h=n.charAt(0)==="-",l=n.charAt(1)==="=",w="like",f,v,y,b,p,g,nt;l&&(w="=");f=n.substring(2);y=f.match(/^(.+)\:(.+)$/);y&&(v=y[1],b=!1,r.Fields.every(function(n){if(n.AllowQBE!==!1&&!n.AliasName||!(n.IsPrimaryKey&&n.Hidden&&it.call(n))){b=!0;return}}),b?f=y[2]:v=null);var tt=Date.tryParseFuzzyDate(f),ut=tt!=null,rt=!0,o,k,d=f;d=d.replace(oi,"");k=parseFloat(d);p=!isNaN(k);l||f.match(/%/)||(f="%"+f+"%");i?i=!1:u.push("&&");h&&u.push("!");u.push("(");g=!1;c&&c.match(/^;/)||r.Fields.forEach(function(n){var r=n.SearchOptions,c,y,i;n.AllowQBE===!1||n.AliasName||n.IsPrimaryKey&&n.Hidden&&(!n.Type.match(/^Date/)||ut)||(!v||it.call(n,v))&&((a||r)&&r.match(/\$quickfinddisabled/)&&(!a||r||!r.match(/\$quickfind/))||(g=!0,o||(o="p"+s++,e[o]=f),l&&p&&(e[o]=k),l&&(!n.Type.match(/String/)&&!p||n.Type.match(/String/)&&p)||(rt?rt=!1:u.push("||"),n.Type.match(/^Date/)?(c="p"+s++,e[c]=t.stringifyDate(tt),h&&u.push("(",n.Name," != null)&&"),u.push("$app.odp.filters._eq(this.",n.Name,",","params.",c,',"',n.Type,'")')):(y=!1,w!=="="&&n.Type==="String"&&n.Len>0&&n.Len<f.length&&(i=f,i=i.substring(1),n.Len<i.length&&(i=i.substring(0,i.length-1)),i.length>n.Len?y=!0:(nt=o,o="p"+s++,e[o]=i)),h&&u.push("(this.",n.Name,"!= null)&&"),w==="="?u.push("$app.odp.filters._eq(this.",n.Name,",","params.",o,',"',n.Type,'")'):u.push("$app.odp.filters._like(this.",n.Name,",","params.",o,',"',n.Type,'")')),nt&&(o=nt))))});c&&c.match(/\;/);g||(h&&c.match(/^\;/)?u.push("1==1"):u.push("1==0"));u.push(")\n")});u.push(")\n")});yt&&u.push("1==1")}else y.match(/^$/)?(nt="p"+s++,k=p(k),e[nt]=k,u.push("($app.odp.filters.",y.substring(y.length-1),"(this.",w,",params.",nt,")")):(nt="p"+s++,e[nt]=p(k),ui=y==="="&&ut.type.match(/^DateTime/)&&k,y==="<>"&ct(k)?u.push("this.",w," != null"):y==="="&&ct(k)?u.push("this.",w," == null"):(d=y,y==="*"?d="_like":ui?d="_inrange":y==="<>"?y="!=":y==="="&&(y="=="),d.match(/\$/)&&(d=d.substring(1,d.length-1)),d in n.filters?u.push("$app.odp.filters.",d,"(this.",w,",params.",nt,")"):u.push("this.",w,y+"params.",nt)))}ft||u.push(")\n")}),o&&(u.push(")\n"),u.push(")\n"),f=!0),f||u.push(")\n"),{filter:u.join(""),params:e}}function at(n){var t=n.SortExpression||"",i=tt.call(n);return i.forEach(function(n){n.IsPrimaryKey&&(t.length&&(t+=","),t+=n.Name)}),t}function ii(n,t){var i=$.Deferred(),u;if(n.SyncKey==null||!n.SyncKey.length||t.PageSize<0)return i.resolve(t),i.promise();if(k(t),u=tt.call(t),u.length===n.SyncKey.length){var r=[],f={},e=0;u.forEach(function(t,i){r.length&&r.push("&&");r.push("(this."+t.Name+"==params.p"+e+")");f["p"+e++]=n.SyncKey[i]});c.select({from:t.Controller,where:lt(n,t),sort:at(t)}).done(function(n){c.select({from:n,where:{filter:r.join(""),params:f},index:!0,limit:1}).done(function(r,u){r.length&&(t.PageIndex=Math.floor((u[0]-1)/t.PageSize),t.PageOffset=0);i.resolve(t,n)})})}else i.resolve(t);return i.promise()}function k(n){ri(n);ui(n);n.SortExpression||(n.SortExpression=e.sortExpression)}function g(n,t){var i={Name:n.name,Type:n.type},r,u;return t&&(i.Hidden=t===!0),n.length!=null&&(i.Len=n.length),n.label&&(i.Label=n.label),n.isPrimaryKey!=null&&(i.IsPrimaryKey=n.isPrimaryKey===!0),n.readOnly!=null&&(i.ReadOnly=n.readOnly===!0),n.onDemand!=null&&(i.OnDemand=n.onDemand===!0),n.default!=null&&(i.HasDefaultValue=!0),n.allowNulls!==!1&&(i.AllowNulls=!0),n.hidden!=null&&(i.Hidden=n.hidden===!0),n.allowQBE!=null&&(i.AllowQBE=n.allowQBE!==!1),n.allowLEV!=null&&(i.AllowLEV=n.allowLEV===!0),n.allowSorting!=null&&(i.AllowSorting=n.allowSorting!==!1),n.sourceFields!=null&&(i.SourceFields=n.sourceFields),n.onDemandStyle&&(i.OnDemandStyle=ut.indexOf(n.onDemandStyle)),n.onDemandHandler&&(i.OnDemandHandler=n.onDemandHandler),n.contextFields&&(i.ContextFields=n.contextFields),n.showInSummary!=null&&(i.ShowInSummary=n.showInSummary),n.htmlEncode!=null&&(i.htmlEncode=n.htmlEncode!==!1),n.calculated!=null&&(i.Calculated=n.calculated),n.causesCalculate!=null&&(i.CausesCalculate=n.causesCalculate===!0),n.isVirtual!=null&&(i.IsVirtual=n.isVirtual===!0),n.configuration&&(i.Configuration=n.configuration["@value"]),n.dataFormatString&&(i.DataFormatString=n.dataFormatString),n.formatOnClient!=null&&(i.FormatOnClient=n.formatOnClient===!0),r=n.items,r&&(r.dataController&&(i.ItemsDataController=r.dataController),r.targetController&&(i.ItemsTargetController=r.targetController)),u=n.dataView,u&&(i.DataViewController=u.controller,i.DataViewId=u.view,i.DataViewFilterFields=u.filterFields,i.DataViewFilterSource=u.filterSource,i.AllowQBE=!0,i.AllowSorting=!0,i.Len=0,i.Columns=0,i.HtmlEncode=!0),i}function ri(n){if(!n.Fields.length){var t=e.dataFields,i={};e.categories&&e.categories.length&&(t=[],(e.categories||[]).forEach(function(n,r){(n.dataFields||[]).forEach(function(n){t.push(n);i[n.fieldName]=r})}));t||(t=[]);t.forEach(function(t){var s=f._map.fields[t.fieldName],r,e,o,u;s&&(r=g(s),t.hidden!=null&&(r.Hidden=t.hidden===!0),t.dataFormatString!=null&&(r.DataFormatString=t.dataFormatString),t.formatOnClient!=null&&(r.FormatOnClient=t.formatOnClient!==!1),t.dataFormatString&&!r.DataFormatString&&(r.DataFormatString=dt.dataFormatString),t.headerText&&(r.HeaderText=t.headerText["@value"]),t.footerText&&(r.FooterText=t.footerText["@value"]),t.toolTip&&(r.toolTip=t.toolTip),t.watermark&&(r.Watermark=t.watermark),t.hyperlinkFormatString&&(r.HyperlinkFormatString=t.hyperlinkFormatString),t.aliasFieldName&&(r.AliasName=t.aliasFieldName),t.tag&&(r.Tag=t.tag),t.AllowQBE!=null&&(r.AllowQBE=t.allowQBE===!0),t.AllowSorting!=null&&(r.AllowSorting=t.allowSorting===!0),i[r.Name]!=null&&(r.CategoryIndex=i[r.Name]),t.columns!=null&&(r.Columns=t.columns),t.rows!=null&&(r.Rows=t.rows),t.textMode!=null&&(r.TextMode=ft.indexOf(t.textMode)),t.readOnly!=null&&(r.ReadOnly=t.readOnly),t.aggregate&&(r.Aggregate=rt.indexOf(t.aggregate)),t.search&&(r.Tag=(r.Tag?r.Tag+" ":"")+"search-mode-"+et.indexOf(t.search).ToLowerCase()),t.searchOptions&&(r.SearchOptions=t.searchOptions),e=t.items||s.items,e!=null&&(e.dataController&&(r.ItemsDataController=e.dataController),e.dataView&&(r.ItemsDataView=e.dataView),e.dataValueField&&(r.ItemsDataValueField=e.dataValueField),e.dataTextField&&(r.ItemsDataTextField=e.dataTextField),e.style&&(r.ItemsStyle=e.style),e.newDataView&&(r.ItemsNewDataView=e.newDataView),e.targetController&&(r.ItemsTargetController=e.targetController),e.copy&&(r.Copy=e.copy),e.pageSize&&(r.ItemsPageSize=e.pageSize),e.letters!=null&&(r.ItemsLetters=e.letters===!0),o=e.list,o&&o.length&&(r.Items=[],o.forEach(function(n){r.Items.push([n.value,n.text])})),e.autoSelect!=null&&(r.AutoSelect=e.autoSelect===!0),e.searchOnStart!=null&&(r.SearchOnStart=e.searchOnStart===!0),e.description&&(r.ItemsDescription=e.description)),n.Fields.push(r),u=t.dataView,u&&(u.showInSummary!=null&&(r.DataViewShowInSummary=u.showInSummary===!0),u.showActionBar!=null&&(r.DataViewShowActionBar=u.showActionBar!==!1),u.showActionButtons&&(r.DataViewShowActionButtons=u.showActionButtons),u.showDescription!=null&&(r.DataViewShowDescription=!0),u.showViewSelector!=null&&(r.DataViewShowViewSelector=u.showViewSelector!==!1),u.showModalForms!=null&&(r.DataViewShowModalForms=u.showModalForms===!0),u.searchByFirstLetter!=null&&(r.DataViewSearchByFirstLetter=u.searchByFirstLetter===!0),u.searchOnStart!=null&&(r.SearchOnStart=u.searchOnStart===!0),u.pageSize!=null&&(r.DataViewPageSize=u.pageSize),u.multiSelect&&(r.DataViewMultiSelect=u.multiSelect===!0),u.showPager!=null&&(r.DataViewShowPager=u.showPager===!0),u.showPageSize!=null&&(r.DataViewShowPageSize=u.showPageSize!==!1),u.showSearchBar!=null&&(r.DataViewShowSearchBar=u.showSearchBar!==!1),u.showQuickFind!=null&&(r.DataViewShowQuickFind=u.showQuickFind!==!1),u.showRowNumber!=null&&(r.DataViewShowRowNumber=u.showRowNumber===!0),u.autoSelectFirstRow!=null&&(r.DataViewAutoSelectFirstRow=u.autoSelectFirstRow===!0),u.autoHighlightFirstRow!=null&&(r.DataViewAutoHighlightFirstRow=u.autoHighlightFirstRow===!0)),n.RequiresPivot)})}}function ui(n){function u(n){typeof n=="string"&&(n=f._map.fields[n]);n&&!r[n.name]&&(i.push(g(n,!0)),r[n.name]=i[i.length-1])}var s;f.statusBar&&(n.statusBar=f.startBar);var o=f.fields,i=n.Fields,r=n._fieldMap={};o.length||o.forEach(function(n){i.push(g(n))});i.forEach(function(n){r[n.Name]=n});o.forEach(function(n){(n.isPrimaryKey||n.hidden)&&!r[n.name]&&u(n)});i.forEach(function(n){var t=n.AliasName,i;t&&(i=r[t],i?i.Hidden=!0:u(t))});s=e.groupExpression;s&&s.split($app._simpleListRegex).forEach(function(n){u(n)});i.forEach(function(n){t.parseMap(n,function(n){u(n)});t.parseMap(n.Configuration,function(n,t){u(t)})})}function fi(n,t){if(t.Distinct){for(var i=0;i<t.Fields.length;)t.Fields[i].IsPrimaryKey?t.Fields.splice(i,1):i++;t.Fields.push({Name:"group_count_",Type:"Double"})}}function ei(n,i){var r="",u=i[n.Name],f;return typeof u=="string"?r=u:(u==null&&(r="null"),f=n.SourceFields.split(t._simpleListRegex),f.forEach(function(n){r.length&&(r+="|");var t=i[n];r+=t==null?"null":t.toString()})),r}function oi(){}function si(){for(var n=0;n<o.Fields.length;n++)if(o.Fields[n].Aggregate)return!0;return!1}function hi(n){var i=$.Deferred(),r=[],t;return n.Fields.forEach(function(i){var f=i.ItemsTargetController,u,e,o;f&&(u=$.Deferred(),e=v.call(i),r.push(u.promise()),t||e||(t=[],n.Fields.every(function(n,t){return n.IsPrimaryKey&&(o=t),o==null}),n.Rows.forEach(function(n){t.push("%js%"+JSON.stringify(n[o]))})),l(i,nt).then(function(n){e?u.resolve():$.when(c.getData(f)).done(function(){c._viewPage({Controller:f,PageIndex:0,PageSize:w,Filter:[n.targetForeignKey1+":$in$"+t.join("$or$")],RequiresMetaData:!0}).done(function(t){var e=yt.call(t),r=-1,s=e[n.targetForeignKey2],o={},f=i.Items;t.Fields.every(function(t){return t.Name===n.targetForeignKey2&&(r=e[t.AliasName||t.Name]),r<0});t.Rows.forEach(function(n){var u=n[s],t=n[r],e;u!=null&&(e=u.toString(),e in o||(o[e]=!0,f||(i.Items=f=[]),t==null&&(t=u),f.push([u,typeof t=="string"?t:t.toString()])))});u.resolve()})})}))}),$.when.apply($,r).done(function(){i.resolve()}),i.promise()}function vt(n){var t={Id:n.id,Type:n.type,Label:n.label};return n.headerText&&(t.HeaderText=n.headerText["@value"]),n.group!=null&&(t.Group=n.group),n.tags&&(t.Tags=n.tags),n.showInSelector===!1&&(t.ShowInSelector=!1),t}function ci(n){var t={Id:n.id};return n.commandName&&(t.CommandName=n.commandName),n.commandArgument!=null&&(t.CommandArgument=n.commandArgument),n.headerText&&(t.HeaderText=n.headerText),n.description&&(t.Description=n.description),n.cssClass&&(t.CssClass=n.cssClass),n.confirmation&&(t.Confirmation=n.confirmation),n.notify&&(t.Notify=n.notify),n.whenLastCommandName&&(t.WhenLastCommandName=n.whenLastCommandName),n.whenLastCommandArgument&&(t.WhenLastCommandArgument=n.whenLastCommandArgument),n.causesValidation!=null&&(t.CausesValidation=n.causesValidation!==!1),n.whenKeySelected!=null&&(t.WhenKeySelected=n.whenKeySelected===!0),n.whenTag&&(t.WhenTag=n.whenTag),n.whenHRef&&(t.WhenHRef=n.whenHRef),n.whenView&&(t.WhenView=n.whenView),n.whenClientScript&&(t.WhenClientScript=n.whenClientScript),n.key&&(t.key=n.key),t}function li(n){var t={Id:n.id,Actions:[],Scope:n.scope};return n.headerText&&(t.HeaderText=n.headerText),n.flat===!0&&(t.Flat=!0),n.actionGroup&&n.actionGroup.forEach(function(n){t.Actions.push(ci(n))}),t}function ai(){var n=this,r=n.Fields,i=n.FieldFilter,t;i&&i.length&&(t=[],r.forEach(function(i){(i.IsPrimaryKey||pi.call(n,i.Name))&&t.push(i)}),n.Fields=t,n.FieldFilter=null)}function vi(t,i){var f=this,u,r;return s("items")?(u=v.call(t),u)?(r=$.Deferred(),l.call(f,t).then(function(){var y,a=t.ContextFields,o,u,w,s,v,l,b;if(a){for(var e=[],p=/(\w+)\s*=\s*(.+?)($|,)/g,f=p.exec(a),h={};f;)o=f[2].match(/^(\'(.+?)\'|(\d+))$/),o?(u=h[o[1]],u||(u=h[o[1]]=[]),u.push(o[2])):i&&(i.every(function(n){if(n.Name===f[2]){w=n;var t="NewValue"in n?n.NewValue:"OldValue"in n?n.OldValue:n.Value;return t===undefined&&(t=null),e.push(f[1]+":=%js%"+JSON.stringify(t)),!1}return!0}),w||e.push(f[1]+":=%js%null")),f=p.exec(a);for(fieldName in h){for(u=h[fieldName],s=0;s<u.length-1;s++)u[s]=JSON.stringify(u[s]);u.length===1?e.push(fieldName+":="+u[0]):e.push(fieldName+":$in$"+u.join("$or$"))}y=e}v=null;t.ItemsTargetController||t.ItemsDataView||(v=t.ItemsDataTextField);l=t.ItemsDataController;b=t.ItemsDataView;$.when(n.getControllers(l)).done(function(){$.when(c.getData(l)).done(function(){c._viewPage({Controller:l,View:b,PageIndex:0,PageSize:1e3,SortExpression:v,Filter:y,RequiresMetaData:!0,MetadataFilter:["fields"]}).done(function(n){r.resolve(t,n)})})})}),r.promise()):!1:!1}function yt(){var n={},t=this.Fields;for(i=0;i<t.length;i++)n[t[i].Name]=i;return n}function yi(n,i){var u,e;n.Items||(n.Items=[]);var s=this,f=n.ItemsDataValueField,r=n.ItemsDataTextField,o=n.Items;f||i.Fields.every(function(n){if(n.IsPrimaryKey)return f=n.Name,!1});r||i.Fields.every(function(n){if(n.Type==="String")return r=n.Name,!1});r||(r=i.Fields[0].Name);u=yt.call(i);e=[u[f],u[r]];t.parseMap(n,function(n,t){var i=u[t];i!=null&&e.push(i)});i.Rows.forEach(function(n){var t=[];e.forEach(function(i){t.push(n[i])});o.push(t)})}function pi(n){var t=this.FieldFilter;return!t||t.indexOf(n)!==-1}function pt(n,i){function v(){var c=$.Deferred(),a;if(s.call(r,"views")&&n.views&&n.views.forEach(function(n){if(!n.virtualViewId){var t=vt(n);r.Views.push(vt(n));t.Id===r.View&&(r.ViewHeaderText=t.HeaderText)}}),s.call(r,"layouts")&&e.layout&&(r.ViewLayout=e.layout["@value"]),s.call(r,"actions")&&n.actions&&n.actions.forEach(function(n){r.ActionGroups.push(li(n))}),s(r,"items")){var t=i?i.contextValues:null,l=t,h=r.NewRow;u.forEach(function(n){if((n.ItemsStyle==="CheckBoxList"||n.ItemsTargetController||e.type===r._staticLookupViewTypeFilter||l)&&(t||(t=[],!h&&r.Rows.length&&(h=r.Rows[0]),h!=null&&u.forEach(function(n,i){t.push({Name:n.Name,Value:h[i]})})),!l||n.ContextFields)){var i=vi.call(r,n,t);typeof i!="boolean"&&f.push(i)}});a=f.length;$.when.apply($,f).done(function(){var n=arguments,t;for(a===1&&(n=[n]),t=0;t<n.length;t++)yi.call(o,n[t][0],n[t][1]);c.resolve()})}else c.resolve();return c.promise()}var r=this,u=r.Fields,h=$.Deferred(),f=[],c=[],a=!0;return r.RequiresMetaData?a=v():(u=[],r.Expressions=null),$.when(a).then(function(){s.call(r,"fields")?u.forEach(function(n){n.Formula&&delete n.Formula;n.ItemsTargetController&&c.push(l.call(r,n))}):u.splice(0,u.length);r.Filter&&r.Filter.every(function(n,t){var i=n.match(/_match_/);return i&&r.Filter.splice(t),!i});r.IsAuthenticated=!!t.userName();$.when.apply($,c).then(function(){h.resolve(r)})}),h.promise()}function wi(n){for(var i=this.Fields,t=0;t<i.length;t++)if(i[t].Name===n)return t;return-1}function bi(){function i(t){for(var i,e=0;e<f.fields.length;e++)u[e]=null;if(t)for(i in f._map.fields)i in t&&(u[wi.call(n,i)]=t[i]);r.resolve(n)}var r=$.Deferred(),n=this,u=n.NewRow=[],e=n.Controller,o;for(pkFieldName in f._map.key)f._map.fields[pkFieldName].calculated&&(o=!0);return(o||f.newOnServer)&&d()?t.execute({controller:e,view:n.View,requiresNewRow:!0,odp:!1,nativeDates:!1}).done(function(n){i(n[e][0])}).fail(i):i(),r.promise()}var c=this,o={},a=$.Deferred(),nt=r.Controller,f,y=r.View,e;return wt(),bt.call(r,o),kt.call(o,r),gt.call(f,o),o.RequiresMetaData&&s.call(o,"categories")&&ni(o),u?u.contextValues?(k(o),pt.call(o,f,{contextValues:u.contextValues}).done(function(n){a.resolve(n)})):a.resolve(o):ii(r,o).done(function(n,t){k(n);ai.call(n);fi(r,n);var u=n.SupportsCaching&&n.PageSize!==w,i=n.PageSize*n.PageIndex+n.PageOffset,o=n.PageSize,s=2;e.type.match(/Grid|DataSheet/)||(u=n.SupportsCaching=!1);u&&(i>=n.PageSize&&(i-=n.PageSize,s=3),o=n.PageSize*s);c.select({from:n.Controller,where:lt(r,n),sort:at(n),yield:t}).done(function(t){function b(){if(n.Distinct){var t=[],i={};n.Rows.forEach(function(n){var r=n.toString(),u=i[r];u==null?(i[r]=t.length,t.push(n),n[n.length-1]=0):n=t[u];n[n.length-1]++});n.Rows=t}pt.call(n,f).done(function(n){a.resolve(n)})}for(var l,s,u,h,p,w,v,y,c,e=i;e<i+o&&e<t.length;e++){for(l=t[e],s=[],u=0;u<n.Fields.length;u++)h=n.Fields[u],s[u]=l[h.Name],h.SourceFields&&(s[u]=ei(h,l));n.RequiresPivot?oi.call(n,s):n.Rows.push(s)}p=n.RequiresRowCount&&!(r.Inserting||r.DoesNotRequireData);p&&(n.TotalRowCount=t.length);!r.DoesNotRequireAggregates&&si.call(n)&&(w=n.Aggregates=[],v=[],n.Fields.forEach(function(n,t){n.Aggregate&&v.push({field:n,index:t,map:{},sum:0,count:0,min:null,max:null})}),t.forEach(function(n){v.forEach(function(t){var u=t.field,i=n[u.Name],r;switch(u.Aggregate){case 1:i!=null&&(r=t.sum+=i);break;case 2:i==null||t.map[i]||(r=++t.count,t.map[i]=!0);break;case 3:i!=null&&(t.sum+=i,r=t.sum/++t.count);break;case 4:i!=null&&(t.max==null||t.max<i)&&(r=t.max=i);break;case 5:i!=null&&(t.min==null||t.min>i)&&(r=t.min=i)}r!=null&&(w[t.index]=r)})}));r.RequiresFirstLetters&&n.ViewType!=="Form"&&(n.RequiresRowCount?(y={},c=[],letterField=n.Fields[0],t.forEach(function(n){var t=n[letterField.Name],i;t!=null&&(typeof t!="string"&&(t=t.toString()),t.length&&(i=t.substring(0,1),y[i]||(c.push(i),y[i]=!0)))}),c.sort(),n.FirstLetters=c.join(",")):n.FirstLetters="");r.Inserting?bi.call(n).done(b):hi(n).done(b)})}),a.promise()}};$(document).on("starting.app",function(i){u=t.touch;i.namespace==="app"&&n.start()})})()