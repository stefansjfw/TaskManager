/*!
* Data Aquarium Framework - One Time Password Authentication
* Copyright 2021-2023 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function s(n){n||(n=this);var t=n.fieldValue("Methods");return t!=null&&t.match(/app/)}function y(n,t){var e=n.data(),o=n.data("survey"),r,s=e.BackupCode,f={};return t==null&&(t=e.Passcode),(t==null||t.length===o.codeLength&&t.toString().match(/^\d+$/))&&(t!=null||s!=null)||(t!=null&&(r=t.replace(/\D/g,""),r!==t&&(t=r,u.execute({values:{Passcode:r},raiseCalculate:!1}))),f.error=String.format(i.Messages.EnterCode,o.codeLength)),f.value=t,f}function p(i){for(var e=o.state.userCodeLength,u="",s=0;s<e;s++)u+="X";u=u.substring(0,Math.floor(e/2))+"-"+u.substring(Math.floor(e/2));i==null&&(i=location.search.match(/(\?|&)user_code=(.+)(&|$)/),i&&(i=i[2]),i==="deny"&&(i=null));t.whenPageShown(function(){var r=t.pageInfo().dataView;t.whenPageCanceled(function(){c();i=r._survey.context.userCode;i.length&&i!=="allow"?n.restful({url:"~/oauth2/v2/auth/device/"+i,method:"POST"}).then(function(t){n.cookie(".oauth2",t.code,0,0,Math.round(t.expiresIn/60));location.replace(t._links.redirect.href)}).catch(function(n){t.progress("hide");p("");t.notify({text:n.errors[0].message,duration:"long"})}):(n.cookie(".oauth2","",-10),location.replace(__baseUrl))})});i==="allow"?n.survey({context:{userCode:i},text:r.ConnectDevice,text2:t.appName(),topics:[{wrap:!0,questions:[{name:"label1",mode:"static",text:!1,value:r.ReturnToDevice,options:{mergeWithPrevious:!0,textStyle:"primary"}},{name:"label2",mode:"static",text:!1,value:"",options:{mergeWithPrevious:!0}}]}],options:{modal:{fitContent:!0,max:"xxs",always:!0},form:{max:"xs"},contentStub:!1,materialIcon:"devices",discardChangesPrompt:!1},submitText:f.ModalPopup.Close,submit:"oauth2device_submit.app",cancel:!1}):n.survey({context:{userCode:""},text:r.ConnectDevice,text2:t.appName(),topics:[{wrap:!0,questions:[{name:"label1",mode:"static",text:!1,value:r.EnterUserCode,options:{mergeWithPrevious:!0,textStyle:"primary"}},{name:"UserCode",text:!1,placeholder:u,required:!0,value:i,options:{mergeWithPrevious:!0,textStyle:"large"}},{name:"label2",mode:"static",text:!1,value:"",options:{mergeWithPrevious:!0}},{name:"label3",mode:"static",text:!1,value:"",options:{mergeWithPrevious:!0}}]}],options:{modal:{fitContent:!0,max:"xxs",always:!0},form:{max:"xs"},contentStub:!1,materialIcon:"devices",discardChangesPrompt:!1},submitText:f.Mobile.Next,submit:"oauth2device_submit.app",cancel:!1})}function w(i){n.restful({url:"~/oauth2/v2/auth",method:"POST",body:{request_id:o.state.request_id,timezone:Intl?Intl.DateTimeFormat().resolvedOptions().timeZone:null,consent:i},hypermedia:"redirect-uri"}).then(function(n){var t=n.href;t&&(t.match(/^http/)?v(t):location.href=n.href)}).catch(function(n){t.progress("hide");t.notify({text:n.errors[0].reason+": "+n.errors[0].message,duration:"long"})})}function v(n){location.replace(n||location.href)}function b(){return t.settings("membership.accountManager.enabled")!==!1}function a(){return o.state&&o.state.trusted}function k(){var e=o.state,l=r.Connect.replace("XXXXX","<b>{0}<\/b>").replace("YYYYY","{1}"),y=(e.scope||"").split(/\s+|,/g),i,s,u;t.whenPageShown(function(){var u=t.pageInfo(),f=u.dataView,i=t.activePage(".app-icon-avatar"),r=n.AccountManager.avatar(n.userName(),i);i.parent().toggleClass("app-has-avatar-with-picture",r!=null);r||i.text(t.initials(n.userName()));t.whenPageCanceled(function(){c();s?(n.cookie(".oauth2",o.state.request_id,0,0,5),b()?v():n.logout(v)):w(f._survey.context.allow?"allow":"deny")})});i=["<div>",'<p style="margin-top:0">',l,"<\/p>"];a()||y.forEach(function(n){if(n&&n!="openid"){u=!0;var r=h[n];r||(r={hint:n,description:String.format("This scope is not known to {0} application.",t.appName())});r.icon||(r.icon="privacy_tip");i.push("<hr/>",'<p style="display:flex;padding: 0 1em">','<i class="material-icon" style="user-select:none">',r.icon,'<\/i> <span style="padding:0 0 0 1em;line-height:24px">',r.hint,"<\/span><\/p>")}});u&&i.push("<hr/>");i.push('<p style="display:flex;',u?"padding:0 1em":"",'">','<span class="app-avatar app-avatar-valign" ',u?'style="margin:0 -5px"':"",'><i class="app-icon-avatar"><\/i><\/span>','<span style="padding:0 1em;line-height:24px">',"<span>",r.SignedInAs," ","<\/span>","<b>",n.htmlEncode(n.userName()),"<\/b><\/span>","<\/p>");i.push("<\/div>");n.survey({context:{allow:!1},text:r.AccountAccess,text2:t.appName(),topics:[{wrap:!0,questions:[{name:"Consent",mode:"static",text:!1,value:String.format(i.join(""),n.htmlEncode(e.name),n.htmlEncode(e.author)),htmlEncode:!1,required:!0,options:{textStyle:"primary",mergeWithPrevious:!0}}]}],actions:[{text:a()?f.ModalPopup.CancelButton:r.Deny,position:"after",execute:function(){return d(),!1}},{text:r.SwitchAccount,position:"after",execute:function(){return s=!0,d(),!1}}],options:{modal:{fitContent:!0,max:"xxs",always:!0},form:{max:"xs"},contentStub:!1,materialIcon:"manage_accounts",discardChangesPrompt:!1},submitText:a()?r.Continue:r.Allow,submit:"oauth2consent_allow.app",cancel:!1})}function c(){t.progress("show",{text:f.Mobile.Wait})}function d(){c();setTimeout(function(){history.go(-1)})}function g(n){var f=n.keyboardPage?t.pageInfo(n.inputPage).dataView:t.dataView(),u=f._survey,i=u&&u.context,r;i&&i.otpauth&&(r=n.value,r.length==i.codeLength&&r.match(/^\d+$/)&&(n.keyboardPage?t.goBack():n.input.blur()))}var n=$app,u=n.input,t=n.touch,nt=window,l=$(document),f=Web.DataViewResources,r=f.OAuth2,o=nt.__settings,it=n.clientRect,e=n.html,rt=e.tag,ut=e.div,ft=e.span,et=e.$tag,ot=e.$p,st=e.$div,ht=e.$span,ct=e.$a,lt=e.$i,at=e.$li,vt=e.$ul,h=null,tt={profile:{icon:"account_circle"},email:{icon:"email"},phone:{icon:"local_phone"},address:{icon:"home"},offline_access:{icon:"verified_user"}},i=f.TwoFA;n.otpauth||(n.otpauth={});n.otpauth.totp={login:function(r){function e(n){n!=null&&n.forEach(function(n){u.push({value:n.type+":"+n.value,text:i.GetCode[n.type]+" "+n.text})})}var u=[];if(r.verify.app&&u.push({value:"app",text:i.AuthenticatorApp}),e(r.verify.email),e(r.verify.sms),e(r.verify.call),e(r.verify.dial),!u.length){t.notify("Verification methods are unavailable.");return}n.survey({context:r,text:i.Text,text2:t.appName(),values:{Method:u[0].value,TrustThisDevice:!1},questions:[{name:"Passcode",type:"text",text:i.VerificationCode,placeholder:new Array(r.codeLength+1).join("0"),length:r.codeLength,causesCalculate:!0,options:{kbd:"pin"}},{name:"Method",text:i.Method,type:"text",causesCalculate:!0,visibleWhen:u.length>1||u.length===1&&u[0].value!=="app",columns:1,items:{style:"RadioButtonList",list:u},options:{lookup:{nullValue:!1}}},{name:"VerificationCodeMethodActions",text:!1,items:{style:"Actions"},options:{mergeWithPrevious:!0},visibleWhen:function(){var n=this.fieldValue("Method");return n&&n.match(/sms|call|email/)}},{name:"TrustThisDevice",type:"bool",text:i.TrustThisDevice,items:{style:"CheckBox"},causesCalculate:!0,visibleWhen:function(){return r.canTrustThisDevice!==!1}},{name:"BackupCode",type:"text",text:i.BackupCode.Text,placeholder:i.BackupCode.Placeholder,footer:i.BackupCode.Footer,causesCalculate:!0,visibleWhen:function(){return r.canEnterBackupCode!==!1}},],options:{modal:{fitContent:!0,autoGrow:!0,max:"xs"},materialIcon:"dialpad",discardChangesPrompt:!1},actions:[{text:i.Actions.GetVerificationCode,execute:"otpauthtotp_getcode.app",position:"before",scope:"VerificationCodeMethodActions",when:function(){var n=this.fieldValue("Method");return n&&n.match(/sms|call|email/)}}],submitText:f.Mobile.Verify,submit:"otpauthtotp_submit.app",calculate:"otpauthtotp_calculate.app"})},setup:function(t){t?n.otpauth.totp._setup(t):n.login(n.userName(),"null;otpauth:totp;exec:setup;")},_setup:function(r){function u(n){if(r.status!=="ready")return!0;n||(n=this);var t=n.fieldValue("Consent");return t!=null&&t.match(/Enable/)}var h=[],y=r.backupCodes&&r.backupCodes.length?r.backupCodes:null,e={Consent:"Enable",AppConfig:"ScanQrCode",Url:r.url,EnterSetupKey:r.secret,BackupCodes:y?y.join(", "):null,Methods:r.methods?r.methods.replace(/\s+/g,""):null,Status:r.status},o=[],c=r.setup.authenticators,a=r.setup.methods,l,v;if(!e.Methods&&a){l=[];for(v in a)a[v]&&l.push(v);l.length&&(e.Methods=l.join(","))}c&&(Array.isArray(c)||(c=[c]),c.forEach(function(n){n.name&&n.url&&o.push({value:n.url,text:n.name})}));o.length||o.push({value:"https://apps.apple.com/us/app/google-authenticator/id388497605",text:"Google Authenticator (iOS)"},{value:"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2",text:"Google Authenticator (Android)"},{value:"https://apps.apple.com/us/app/microsoft-authenticator/id983156458",text:"Microsoft Authenticator (iOS)"},{value:"https://play.google.com/store/apps/details?id=com.azure.authenticator",text:"Microsoft Authenticator (Android)"},{value:"https://apps.apple.com/us/app/salesforce-authenticator/id782057975",text:"Salesforce Authenticator (iOS)"},{value:"https://play.google.com/store/apps/details?id=com.salesforce.authenticator",text:"Salesforce Authenticator (Android)"});o.length===1&&(e.InstallApp=o[0].value,e.SelectedApp=e.InstallApp);r.verifyVia.email&&h.push({value:"email",text:i.VerifyVia.email});r.verifyVia.sms&&h.push({value:"sms",text:i.VerifyVia.sms});r.verifyVia.call&&h.push({value:"call",text:i.VerifyVia.call});r.verifyVia.app&&h.push({value:"app",text:i.VerifyVia.app});n.survey({context:r,text:i.Text,text2:t.appName(),values:e,questions:[{name:"Consent",text:i.Consent,required:r.status!=="ready",items:{style:"CheckBoxList",list:[{value:"Enable",text:i.Setup.Consent}]}},{name:"Methods",type:"text",text:i.Setup.Methods,required:!0,items:{style:"CheckBoxList",list:h},visibleWhen:u},{name:"AppConfig",required:!0,items:{style:"RadioButtonList",list:[{value:"ScanQrCode",text:i.Setup.AppConfigScanQrCode},{value:"EnterSetupKey",text:i.Setup.AppConfigEnterSetupKey},{value:"InstallApp",text:i.Setup.AppConfigInstallApp},]},visibleWhen:function(){return r.verifyVia.app&&u(this)&&s(this)}},{name:"Url",text:i.Setup.ScanQrCode,options:{input:{qrcode:{valueHidden:!0,tooltipHidden:!0,scrollIntoView:!e.Methods||!e.Methods.match(/app/),size:"192x192"}}},visibleWhen:function(){var n=this.fieldValue("AppConfig");return r.verifyVia.app&&u(this)&&s(this)&&n==="ScanQrCode"}},{name:"EnterSetupKey",text:i.Setup.EnterSetupKey,mode:"static",options:{textAction:"copy"},visibleWhen:function(){var n=this.fieldValue("AppConfig");return u(this)&&s(this)&&n==="EnterSetupKey"}},{name:"InstallApp",text:i.AuthenticatorApp,required:!0,items:{style:"RadioButtonList",list:o},columns:1,causesCalculate:!0,visibleWhen:function(){var n=this.fieldValue("AppConfig");return u(this)&&s(this)&&n==="InstallApp"&&o.length>1}},{name:"SelectedApp",text:i.Setup.ScanAppQrCode,options:{input:{qrcode:{valueHidden:!0,scrollIntoView:!0,size:"192x192"}}},visibleWhen:function(){var n=this.fieldValue("AppConfig"),t=this.fieldValue("InstallApp");return u(this)&&s(this)&&n==="InstallApp"&&t}},{name:"BackupCodes",text:i.Setup.BackupCodes.Text,mode:"static",htmlEncode:!1,footer:i.Setup.BackupCodes.Footer,options:{textAction:"copy"},visibleWhen:function(){return u(this)&&this.fieldValue("Methods")&&this.fieldValue("Status")==="ready"&&this.fieldValue("BackupCodes")}},{name:"BackupCodeActions",text:!1,rows:1,items:{style:"Actions"},options:{mergeWithPrevious:!0},visibleWhen:function(){return u(this)&&this.fieldValue("Methods")&&this.fieldValue("Status")==="ready"&&this.fieldValue("BackupCodes")}},{name:"BackupCodesUnavailable",text:i.Setup.BackupCodes.Text,rows:1,items:{style:"Actions"},footer:i.Setup.BackupCodes.Footer,visibleWhen:function(){return u(this)&&this.fieldValue("Methods")&&this.fieldValue("Status")==="ready"&&!this.fieldValue("BackupCodes")}},{name:"Status",hidden:!0}],options:{modal:{fitContent:!0,autoGrow:!0,max:"sm"},materialIcon:"dialpad",discardChangesPrompt:!1},actions:[{text:f.Mobile.Next,execute:"otpauthtotpsetup_next.app",scope:"form",icon:"material-icon-arrow_forward",when:function(){return this.fieldValue("Status")!="ready"&&(!s(this)||this.fieldValue("AppConfig")!=="InstallApp")}},{text:r.status==="ready"?f.ModalPopup.SaveButton:f.Mobile.Enable,execute:"otpauthtotpsetup_save.app",scope:"form",icon:"material-icon-check",when:function(){return this.fieldValue("Status")==="ready"}},{text:f.ModalPopup.SaveButton,execute:"otpauthtotpsetup_backupcodessave.app",scope:"BackupCodeActions",causesValidation:!1},{text:f.Mobile.Generate,execute:"otpauthtotpsetup_backupcodesgenerate.app",scope:"BackupCodeActions",causesValidation:!1},{text:f.Mobile.Generate,execute:"otpauthtotpsetup_backupcodesgenerate.app",scope:"BackupCodesUnavailable",causesValidation:!1}],calculate:"otpauthtotpsetup_calculate.app"})},exec:function(r,f){function o(n,t){t!=null&&h.push(n+":"+(t==null?"null":t)+";")}var s;if(!t.busy()){var c=f.dataView||t.dataView(),e=c.data("survey"),h=[(e.password||"null")+";"];o("otpauth",e.otpauth);o("exec",r);for(s in f)o(s,f[s]);n.login(e.username,h.join(""),e.createPersistentCookie,function(n){t.busy(!0);e.callback?e.callback.success(n):n.event&&l.trigger($.Event(n.event,{args:n}))},function(){var r=t.dataView().data("survey").confirm,f=r==="verification_code"?i.Messages.InvalidVerificationCode:i.Messages.InvalidPassword;n.alert(f).then(function(){u.focus({field:r==="password"?"Password":"Passcode"})})})}}};l.on("otpauthtotp_submit.app",function(t){var f=t.dataView.data(),r=t.dataView.data("survey"),e=f.BackupCode,i=y(t.dataView);return i.error?n.alert(i.error).then(function(){u.focus({field:"Passcode"})}):(i=i.value,i==null&&(i=e),i=i.toString(),n.otpauth.totp.exec(t.dataView.data("survey").exec||"login",{passcode:i,trustThisDevice:f.TrustThisDevice,url:r.url,backupCodes:r.backupCodes,methods:r.methods})),!1}).on("otpauthtotp_getcode.app",function(r){var o;u.focus({field:"Passcode"});var e=r.dataView.data().Method.match(/^(\w+)\:(.+)$/),h=r.dataView.data("survey"),c,s=h.verify[e[1]];for(o=0;o<s.length;o++)s[o].value===e[2]&&(c=i.CodeSent[e[1]]+" "+s[o].text);return n.otpauth.totp.exec("send",{method:e[2],type:e[1],url:h.url,template:String.format(i.Messages.YourCode,t.appName()),confirmation:c}),setTimeout(function(){u.focus({field:"Passcode"})}),t.notify(f.Mobile.Wait),!1}).on("otpauthtotp_calculate.app",function(n){var i=n.rules._args.trigger,t=n.dataView,e=t.fieldValue("Passcode"),o=t.fieldValue("BackupCode"),r,f;return i==="Method"&&(r=t.fieldValue("Method"),r&&r.match(/^dial|app/)&&setTimeout(function(){u.focus({field:"Passcode"})})),i==="Passcode"&&(f=y(t),o!=null&&e!=null&&u.execute({BackupCode:null}),f.error||f.value==null||l.trigger($.Event("otpauthtotp_submit.app",{dataView:t,survey:t._survey}))),i==="BackupCode"&&o!=null&&e!=null&&u.execute({Passcode:null}),i==="TrustThisDevice"&&setTimeout(function(){u.focus({field:"Passcode"})}),!1}).on("beforefocus.input.app",'[data-field="Passcode"][data-type="pin"]',function(n){n.inputElement.data("change",g)}).on("beforefocus.keyboard.app",'[data-field="Passcode"][data-type="pin"]',function(n){n.context.change=g}).on("input",'[data-field="UserCode"] .app-data-input',function(i){var r=i.target.value.toUpperCase().replace(/[^A-Z\d]/g,""),u=o.state.userCodeLength,f=r.length===u;r.length>u&&(r=r.substring(0,u));r.length>u/2&&(r=r.substring(0,Math.floor(u/2))+"-"+r.substring(Math.floor(u/2)));r.length===Math.floor(u/2)&&i.target.value.length>r.length&&(r+="-");i.target.value=r;f&&(n.input.execute({values:{UserCode:r}}),setTimeout(function(){t.pageInfo().dataView.executeCommand({commandName:"Confirm",commandArgument:"",path:"form/submit",causesValidation:!0})}))});l.on("otpauthtotpsetup_calculate.app",function(n){var i=n.rules._args.trigger,r=n.dataView,t;return i==="InstallApp"&&(t=r.fieldValue("InstallApp"),u.execute({SelectedApp:t})),!1}).on("otpauthtotpsetup_verificationcodesent.app",function(n){return t.notify(n.args.notify),!1}).on("otpauthtotpsetup_backupcodessave.app",function(){var i=t.dataView().data("survey").backupCodes,r=t.appName()+" backup codes.txt";return n.saveFile(r,i.join("\r\n")),!1}).on("otpauthtotpsetup_backupcodesgenerate.app",function(t){var i=t.dataView.data("survey");return n.otpauth.totp.exec("generate",{url:i.url}),!1}).on("otpauthtotpsetup_backupcodesgeneratedone.app",function(n){var i=t.dataView().data("survey");return i.backupCodes=n.args.newBackupCodes,u.execute({BackupCodes:n.args.newBackupCodes.join(", ")}),setTimeout(function(){u.focus({field:"BackupCodeActions"})}),!1}).on("otpauthtotpsetup_next.app",function(n){return u.execute({Status:"ready"}),setTimeout(function(){u.focus({field:n.dataView.fieldValue("BackupCodes")?"BackupCodeActions":"BackupCodesUnavailable"})}),!1}).on("otpauthtotpsetup_save.app",function(t){function u(){n.otpauth.totp.exec("setup",{consent:r.Consent,url:f.url,backupCodes:r.BackupCodes,methods:r.Methods})}var r=t.dataView.data(),f=t.dataView.data("survey");return r.Consent?u():n.confirm(i.Messages.DisableQuestion).then(u),!1}).on("otpauthtotpsetup_confirm.app",function(r){return r.args.confirm==="verification_code"?n.otpauth.totp.login(r.args.options):r.args.confirm==="password"&&n.survey({context:r.args.options,text:i.Text,text2:t.appName(),questions:[{name:"Password",mode:"password",text:i.EnterPassword,required:!0}],options:{modal:{fitContent:!0,max:"xs"},materialIcon:"password",discardChangesPrompt:!1},submitText:f.Mobile.Next,submit:"otpauthtotppassword_submit.app"}),!1}).on("otpauthtotppassword_submit.app",function(t){return n.otpauth.totp.exec(t.dataView.data("survey").exec,{password:t.dataView.fieldValue("Password")}),!1}).on("otpauthtotpsetup.app",function(i){var r=t.dataView().data("survey");return i.args.verifyVia=r.verifyVia,i.args.setup=r.setup||{},t.goBack(function(){n.otpauth.totp.setup(i.args)}),!1}).on("otpauthtotpsetup_complete.app",function(r){var u=r.args.setupType;return t.goBack(function(){u==="none"?n.alert(i.Messages.Disabled):t.goBack(function(){n.alert(u==="new"?i.Messages.Enabled:i.Messages.Changed)})}),!1}).on("oauth2consent.app",function(){o.state.type==="device"?p():a()&&b()?(c(),w("allow")):h?k():$app.restful({url:"~/oauth2/v2"}).then(function(n){var u,i,t;h=n.scopes;for(u in r.Scopes)i=h[u],t=r.Scopes[u],t&&t.startsWith(r.WantsTo)&&(t=t.slice(r.WantsTo.length).trim(),t=t.charAt(0).toUpperCase()+t.slice(1)),i==null&&(h[u]=i={}),t&&(i.hint=t),i.icon||(i.icon=(tt[u]||{}).icon);k()})}).on("oauth2consent_allow.app",function(n){c();n.survey.context.allow=!0}).on("oauth2device_submit.app",function(n){var f=o.state.userCodeLength,t=n.dataView.data().UserCode,i=(t||"").replace(/\-/g,"");if(typeof t!="undefined"){if(i.length!=f)return u.focus({field:"UserCode",message:r.InvalidDeviceCode}),!1;n.dataView._survey.context.userCode=i}})})()