/*!
* Data Aquarium Framework - Search 
* Copyright 2021-2024 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function f(){return t.dataView()}function e(){t.resetPageHeight()}function rt(n,t){n.extension().quickFind(t)}function ut(n){var i=n.extension().filterStatus(!0,!1);t.notify({dataView:n,text:i||r.FilterCleared})}function ft(n){var r=n._hasSearchAction,u=[],f,e=n._totalRowCount,i;if(r&&(n._totalRowCount=0,f=t.contextScope(),t.contextScope(n),t.navContext(u),t.contextScope(f),n._totalRowCount=e,u.every(function(n){return n.path===r&&(i=n),i==null}),i))return n.get_searchOnStart()&&(n.set_searchOnStart(!1),n._requiresContextRefresh=!0),controllerActionCallback(i.context),!0}var n=$app,t=n.touch,b=$(document),s=Web.DataViewResources,y=s.Data,c=y.Filters,r=s.Mobile,l=s.Grid,a=l.PerformAdvancedSearch,k=s.Validator.Required,d=34,v=t.whenPageShown,g=t.whenPageCanceled,o=t.activePage,h=n.findDataView,u=n.html,et=u.tag,ot=u.div,st=u.span,ht=u.$tag,ct=u.$p,nt=u.$div,p=u.$span,lt=u.$a,tt=u.$i,w=u.$li,it=u.$ul;b.on("searchperform.dataview.app",function(i){var h=i.dataView,f=i.survey,l=f.context.field,y=f.context.start,r=h.data(),c=r.QuickFind,a=f.context.id,e,u,s;"QuickFind"in r&&(u=o("li.app-selected").attr("data-text"),u!=null&&(s=c?c.match(/(\"?(\S+)\:)\S*/):null,r.QuickFind=s?'"'+s[2]+":"+u.substring(1):u));e=n._search("parse",{id:a,data:r,field:l,showErrors:!0});e.errors.length?i.preventDefault():(t.pageInfo(h)._canceled=!0,t.transitions(!1),t.settings("ui.transitions.style","none"),v(function(){t.transitions(!0);n._search("execute",e)}))}).on("searchgenerate.dataview.app",function(t){n._search("generate",{id:t.survey.context.id,survey:t.survey})}).on("searchreset.dataview.app",function(t){return n.confirm(r.ResetSearchConfirm,function(){n._search("reset",{id:t.survey.context.id})}),!1}).on("searchcalculate.dataview.app",function(t){var u=t.rules.trigger(),e,o=t.dataView,d=t.survey,f=o.data(),i,s,r,h,c=f[u],v,w,l,y,p,b,k,a;if(u){v=[];w=o._viewId+"_"+u+"_";for(l in o._pageSession)l.match(/(_listCache|_listOfValues_)/)&&!l.startsWith(w)&&v.push(l);if(v.forEach(function(n){delete o._pageSession[n]}),u.match(/_op$/)){s=u.substring(0,u.length-3);r=f[s];i=o.findField(s);i&&(y=i.ItemsTargetController,b=i.ItemsStyle,i.ItemsStyle=i.lov("static")?i.Extended.itemsStyle:c&&c.match(/^(=|<>|\$in|\$notin)$/)&&i.FilterType==="Text"&&i.Extended.autoComplete!==!1?"AutoComplete":null,i.ItemsTargetController=c==="$in"||c==="$notin"?"_basket":null,p=i.ItemsTargetController!==y,k=i.ItemsStyle!==b,p&&(r=f[s],y?(i.Items=[],r!=null&&(r=n.csv.toArray(r),r.length&&(r=r[0]))):r!=null&&i.ItemsStyle&&(i.Items=[[r,i.format(r)]],i.is("lookup-distinct")&&i.Items[0].push(null))),(k||p)&&n.input.execute({values:{name:s,value:r}}));return}h=d.context.id;e=u.match(/^_Match(\d+)_addCondition$/);e&&setTimeout(n._search,0,"addCondition",{id:h,match:parseInt(e[1]),condition:f[u]});e=u.match(/^_Match(\d+)(_filters)?$/);e&&(a=parseInt(e[1]),setTimeout(n._search,0,"changeMatch",{id:h,match:a,type:f["_Match"+a],filters:f["_Match"+a+"_filters"]}));u==="_Match_addGroup"&&setTimeout(n._search,0,"addGroup",{id:h,type:f[u]})}}).on("quickfindshow.dataview.app",function(t){return n._search("toggle",t.survey.context.id),!1}).on("quickfindautocomplete.dataview.app",function(t){var i=t.inputData;n._search("autoComplete",{id:f().survey().context.id,dataInput:n.input.of(i.input),value:i.value,keyboard:i.keyboard})}).on("vclick",".app-bar-history",function(i){var r=$(i.target).closest("li"),u=r.data("text");return u!=null&&(t.activeElement("blur"),r.closest("ul").find(".app-selected").removeClass("app-selected"),r.addClass("app-selected"),setTimeout(n.action,d,{path:"form/submit"})),!1}).on("populateexternalfilter.dataview.app",function(n){var t=f(),r=t.survey(),i;r&&(i=r.context,i&&i.id===r.parent&&(t=h(i.id),t&&(t._externalFilter||"").forEach(function(t){n.externalFilter.push(t)})))});n._search=function(u,s){function ni(){return t.density()===12||t.screen().width<480?"xs":""}function bt(n,t){var i=t._dataView._allFields[t.OriginalIndex].SearchOptions,r={field:t.Name,operator:i?i[0]:"="};n.fields.push(r)}function wt(n){return n.is("search-mode")!=="forbidden"&&!n.OnDemand&&n.AllowQBE!==!1&&n.Type!=="DataView"}function ti(n){var t=b._allFields,i=n.fields,u=n.available,r;i.length||$(b._fields).each(function(){var r=this;if(wt(r)){if(r=t[r.AliasIndex],i.length===3)return!1;bt(n,r)}});r={};i.forEach(function(n){r[n.field]=!0});t.forEach(function(i){var e=i.is("search-mode"),f;(e&&e!=="forbidden"||!e&&!i.Hidden&&wt(i))&&(i=t[i.AliasIndex],f=i.Name,!r[f]&&u.indexOf(f===-1)&&n.available.push(f))})}function ht(n,t,i){var r={id:t,type:i||"$matchall",filters:"$showfilters",fields:[],available:[]},u=n?b._allFields[b.findField(n).AliasIndex]:null;return b._allFields.forEach(function(t){var i=t.is("search-mode");(n&&u==t||!n&&(i==="required"||i==="suggested")&&wt(t))&&(t=t._dataView._allFields[t.AliasIndex],bt(r,t))}),n||ti(r),r}function ii(n,t){var r=[],e=1,u,o,f=n["_Match1"],h=b._allFields,s,i;if(t)r.push(ht(t,1));else if(f)while(f)u={id:e,type:f,filters:"$showfilters",fields:[],available:[]},s={},h.forEach(function(t){wt(t)&&(t=h[t.AliasIndex],i=t.Name,o=n["_Match"+e+"_"+i+"_op"],o&&!s[i]&&(u.fields.push({field:i,operator:o}),s[i]=!0))}),ti(u),r.push(u),f=n["_Match"+(++e).toString()];else r.push(ht(null,1));return r}function fi(){var o=b._allFields,t=s.data,i=s.field,r={id:s.id,data:t,field:i,start:s.start,filter:[],find:t.QuickFind,errors:[]},c=r.filter,u=[],l=[],e,a,h;for(e in t)e.match(/^_match\d+$/i)?u.push(e):l.push(e);return u.length||u.push(""),u.forEach(function(r){var u=new RegExp("^("+(r?r+"_":"")+".+?)_op$"),f=t[r]||"$matchall";r||i||o.forEach(function(n){n=o[n.AliasIndex];var i=n.Name;t[i]!=null&&t[i+"_op"]==null&&(t[i+"_op"]="=")});l.forEach(function(e){var p=e.match(u),h,w,nt=1,s,l,d,g,y,v,k;if(p){for(w=p[0];t[w]!=null;)h=t[w],w=p[0]+(++nt).toString();h&&(d=n.filterOpValueRequired(h),y=p[1],s=t[y],l=t[y+"_v2"],g=r?y.substring(r.length+1):y,v=b.findField(g),!v||i&&o[v.OriginalIndex].Name!=i||d&&s==null&&l==null||(d?(h==="$between"?s==null?(h="<=",s=l):l==null?h=">=":l<s&&(l=[s,s=l][0]):s==null&&(s=l),h==="$in"||h==="$notin"?(s=n.csv.toArray(s.toString()),s.forEach(function(n,t){s[t]=b.convertFieldValueToString(v,n)}),s=s.join("$or$")):(s=b.convertFieldValueToString(v,s),h==="$between"&&(s=s+"$and$"+b.convertFieldValueToString(v,l)))):s="",h.match(/^\$/)&&(h+="$"),a!=r&&(i||(k=f.match(/(match|donotmatch)(all|any)/),k&&c.push("_"+k[1]+"_:$"+k[2]+"$")),a=r),c.push(v.Name+":"+h+s)))}})}),i||(h=f(),h!=b&&h._allFields.forEach(function(i){if(i.Extended&&i.Extended.required){var u=t[i.Name+"_op"];u&&n.filterOpValueRequired(u)&&t[i.Name]==null&&r.errors.push({field:i.Name,error:k})}})),s.showErrors&&r.errors.length&&n.input.focus({fieldName:r.errors[0].field,message:r.errors[0].error}),r}function ei(){var f=s.id,r=s.data,e=s.start,u=s.field,n=s.filter,i;u?(b.removeFromFilter(b._allFields[b.findField(u).AliasIndex]),n.forEach(function(n){b._filter.push(n)}),t.dataFilter(b)):(s.keepFilter||b.clearFilter(),n=n.length?n:null,b.asearch("filter",n),b.asearch("active",n!=null),"QuickFind"in r?(i=r.QuickFind,i==null&&e?t.sync(f):rt(b,i),ut(b)):t.dataFilter(b))}function oi(){var i=f(),u=i.survey().context,o=JSON.parse(u.base),h=u.model,r=h[s.match-1];r.available.splice(r.available.indexOf(s.condition),1);bt(r,b.findField(s.condition));s.survey=o;ct(h,i.data());n.survey("refresh",o,function(n){if(e(),!t.pointer("touch")){var r="_Match"+s.match+"_"+s.condition;i.findField(r)||(r+="_op");n.find('[data-control="label"][data-field="'+r+'"]').trigger("vclick")}})}function si(){var i=f(),r=i.survey().context,u=JSON.parse(r.base),t=r.model;t.push(ht(null,t.length+1,s.type));s.survey=u;ct(t,i.data());n.survey("refresh",u,function(n){e();kt(n,t.length)})}function ri(){var n=[],t=b._allFields;return t.forEach(function(t){t.is("search-option-top-values")&&n.push(t)}),n.length||t.forEach(function(i){var r=t[i.AliasIndex];i.ItemsDataController&&n.length<3&&r.Type=="String"&&!i.ItemsTargetController&&!(i.AllowAutoComplete==!1||i.AllowMultipleValues==!1)&&n.push(r)}),n}function hi(){var u=f(),h=u.survey().context,c=JSON.parse(h.base),l=h.model,t=l[s.match-1],r=s.filters,i,o,a;if(t.type=s.type,t.fields.forEach(function(i){var r=u.findField("_Match"+t.id+"_"+i.field);r.Extended&&r.Extended.context&&(r.ContextFields=t.type.match(/any/)?null:r.Extended.context,r._dataView.sessionRemove(n.lovKey(r)))}),r&&r!=t.filters){t.filters=r;i=u.data();for(o in i)o.startsWith("_Match"+t.id+"_")&&delete i[o];delete i["_Match"+t.id];r==="$showfilters"?(a=ht(),t.fields=a.fields):(t.fields=[],ri().forEach(function(n){t.fields.push({field:n.Name,operator:"$in"})}));s.survey=c;ct(l,i);n.survey("refresh",c,function(n){e();kt(n,t.id)})}}function kt(n,i){t.pointer("touch")||n.find('[data-field="_Match'+i+'"]').closest("[data-container]").next().find('[data-control="label"]').first().trigger("vclick")}function ci(){var t=f().survey().context,i=JSON.parse(t.base);s.survey=i;ct(t.model=[ht(null,1)],{});n.survey("refresh",i,function(n){e();kt(n,1)})}function ct(n,t){var e=s.survey,a=e.context,v=b._allFields,g=ri(),f=a.field,k,p,u=[],o=[],w,d,h;return t||(t=b.data(f?"filter":"search")),a.base||(a.base=JSON.stringify(e)),n||(n=ii(t,f),f||(w=ii({})[0],n.forEach(function(n){var t=w.fields.slice(0),r=[];for(n.fields.forEach(function(n){for(var u=!0,i=0;i<t.length;i++)if(t[i].field===n.field){t[i]=n;u=!1;break}u&&r.push(n)}),i=0;i<r.length;i++)for(j=0;j<w.available.length;j++)if(w.available[j]==r[i].field){t.push(r[i]);break}for(n.fields=t,i=0;i<t.length;i++)j=n.available.indexOf(t[i].field),j>=0&&n.available.splice(j,1)}))),a.model=n,f&&(k=t[f+"_op"],p=t[f],f&&(k==="$in"||k==="$notin")&&b.findField(f).FilterType!=="Text"&&(t[f+"_op"]="=",t[f]=p instanceof Array?p[0]:p)),u.push('<div data-layout="form" data-layout-size="tn">'),u.push('<div data-container="'+(f?"simple":"collapsible")+'" data-wrap="false" data-header-text="none">'),n.forEach(function(n){var i=f?"":"_Match"+n.id,e=n.filters,s;f||(u.push('<div data-container="row" style="padding:1em">'),u.push('<span data-control="field" data-field="'+i+'" data-size="auto" style="font-weight:bold;">[_Match]<\/span>'),g.length&&u.push('<span data-control="field" data-field="'+i+'_filters" data-size="auto" style="text-transform:lowercase">[_Match_Filters]<\/span>'),u.push("<\/div>"),o.push({name:i,required:!0,value:t[i]||n.type,text:!1,placeholder:"add matching group",causesCalculate:!0,items:{list:[{value:"$matchall",text:r.MatchAll},{value:"$matchany",text:r.MatchAny},{value:"$donotmatchall",text:r.DoNotMatchAll},{value:"$donotmatchany",text:r.DoNotMatchAny}]},options:{lookup:{openOnTap:!0,nullValue:!1}}}),g.length&&o.push({name:i+"_filters",required:!0,value:t[i+"_filters"]||n.filters,text:!1,placeholder:"filters",causesCalculate:!0,items:{list:[{value:"$showfilters",text:r.WithSpecifiedFilters},{value:"$showtop5",text:r.WithSelectedValues5},{value:"$showtop10",text:r.WithSelectedValues10}]},options:{lookup:{openOnTap:!0,nullValue:!1}}}));n.fields.forEach(function(r,s){function st(n,i){var f=0,r,u=i.items.list;return n.List.forEach(function(i){if(i){var e=i.Function,o=w.SearchOptions;e?o&&o.indexOf(e)===-1||(p!=="text"||w.AllowAutoComplete===!1||w.AllowMultipleValues===!1)&&e.match(/^\$(in|notin)$/)||(r&&(u.push({value:"$separator"}),r=!1),ct&&["=","<>","$isnotempty","$isempty","$true","$false"].indexOf(e)===-1||(u.push({value:e,text:i.Text}),f++)):i.List&&(it={name:a+"_op2",text:h.HeaderText,value:t[a+"_op2"],items:{list:[]},placeholder:n.Text.toLowerCase(),options:{openOnTap:!0,lookup:{autoCompleteAnywhere:!0,nullValue:!1},clearOnHide:!0},visibleWhen:"$row."+a+'_op=="all-dates-in-period"'},st(i,it)&&u.push({value:"all-dates-in-period",text:i.Text}))}else r=!0}),f}var h=b.findField(r.field),w=v[h.OriginalIndex],g=h.Name,et=h.FilterType,p=et.toLowerCase(),nt=p==="boolean",tt=c[et],a=i?i+"_"+g:g,rt=t[a+"_op"]||r.operator,l={name:a,type:p,text:h.HeaderText,placeholder:tt.Kind.toLowerCase(),format:h,value:t[a],extended:{required:v[h.OriginalIndex].is("search-mode")==="required"},causesCalculate:!0,visibleWhen:"["+(p==="date"?'"=","<>","<",">","<=",">=","$between","$in","$notin"':'"$isnotempty","$isempty"')+"].indexOf( $row."+a+"_op) "+(p=="date"?"!":"=")+"= -1"},ot,k={name:a+"_op",text:h.HeaderText,required:!0,items:{list:[]},value:rt,causesCalculate:!0,options:{openOnTap:!0,lookup:{autoCompleteAnywhere:!0,nullValue:!1,autoAdvance:"row"}}},it,ct=h.lov("static"),ft;if(e==="$showfilters"?(u.push('<div data-container="row" style="padding-left:3em">'),u.push(String.format('<span data-control="label" data-field="{0}" data-size="'+(f?"fit":"auto")+'">{1}<\/span>',a+(nt?"_op":""),h.HeaderText)),u.push(String.format('<span data-control="field" data-field="{0}_op" data-size="auto" style="text-transform:lowercase">{0}_op<\/span>',a)),nt||u.push(String.format('<span data-control="field" data-field="{0}" data-size="auto" data-focus="true" data-visibility="f:{0}">[{0}]<\/span>',a)),p==="date"&&u.push(String.format('<span data-control="field" data-field="{0}_op2" data-size="auto" data-focus="true" data-visibility="f:{0}_op2">{0}_op<\/span>',a)),nt||h.lov("static")||u.push(String.format('<span data-control="text" data-visibility="f:{0}_v2">{1}<\/span><span data-control="field" data-field="{0}_v2" data-size="auto" data-visibility="f:{0}_v2">[{0}]<\/span>',a,c.Labels.And)),u.push("<\/div>")):(s||u.push('<div data-container="row" style="padding-left:3em">'),u.push('<span style="display:inline-block;vertical-align:top">'),u.push(String.format('<span data-control="label" data-field="{0}" data-size="auto">{1}<\/span>',a,h.HeaderText)),u.push(String.format('<span data-control="field" data-field="{0}" data-size="auto" data-focus="true" data-visibility="f:{0}">[{0}]<\/span>',a)),u.push("<\/span>"),s===n.fields.length-1&&u.push("<\/div>")),st(tt,k),o.push(k),it&&o.push(it),p==="date"&&(l.options={smartDatesDisabled:!0,clearOnHide:!0}),p==="text"){var ht=w.AllowAutoComplete!==!1,ut=rt.match(/^(=|<>|\$in|\$notin)$/)!=null&&ht,d=h.ItemsTargetController;l.items={controller:d?h.ItemsDataController:b._controller,view:d?null:b._viewId,dataValueField:d?h.ItemsDataTextField:g,dataTextField:d?h.ItemsDataTextField:g,style:ut?"AutoComplete":null,disabled:!ut};l.context=[];d||n.fields.forEach(function(n){r!=n&&l.context.push(String.format("{1}={0}_{1}",i,n.field))});l.extended.context=l.context.join(",");ht||(l.extended.autoComplete=!1);n.type.match(/any/)&&(l.context=null);f&&(l.extended.filter=b.get_filter(),l.extended.search=b._combinedFilter([]));l.autoCompletePrefixLength=w.AutoCompletePrefixLength;l.options={lookup:{distinct:d?!1:(b._fields[0]!=h&&!h.is("lookup-distinct-none")||h.is("lookup-distinct")||h.is("search-sample-distinct")||!!v[h.OriginalIndex].ItemsStyle)&&!h.is("search-sample-all"),acceptAnyValue:!0,multiple:t[a]instanceof Array||!!rt.match(/\$(in|notin)/),autoCompleteAnywhere:ut&&w.AutoCompleteAnywhere===!0},clearOnHide:!0}}p==="number"&&(l.options={clearOnHide:!0});nt?(k.required=!1,k.options.lookup.autoCompleteAnywhere=!1,k.items.list.splice(0,0,{value:null,text:y.AnyValue}),k.placeholder=tt.Kind.toLowerCase()):(o.push(l),h.lov("static")?(ft=h.ItemsStyle,l.extended.itemsStyle=ft,l.placeholder=c.Text.Kind.toLowerCase(),l.items={style:ft,list:[]},h.Items.forEach(function(n){l.items.list.push({value:n[0],text:n[1]})}),l.options.lookup={nullValue:!1,openOnTap:!0}):(ot={name:a+"_v2",type:p,text:h.HeaderText,format:h,placeholder:tt.Kind.toLowerCase(),causesCalculate:!0,visibleWhen:"$row."+a+'_op=="$between"',value:t[a+"_v2"],options:{smartDatesDisabled:!0,clearOnHide:!0}},o.push(ot)));e!=="$showfilters"&&l.items&&l.options&&(l.items.style="CheckBoxList",l.options.lookup={distinct:!0,nullValue:"any",top:parseInt(e.substring(8))})});!f&&n.available.length&&e==="$showfilters"&&(u.push('<div data-container="row" style="padding-left:3em">'),u.push('<span data-control="field" data-field="'+i+'_addCondition" data-size="auto">[_AddCondition]<\/span>'),u.push("<\/div>"),s={name:i+"_addCondition",text:!1,placeholder:l.AddConditionText.toLowerCase(),causesCalculate:!0,items:{list:[]},options:{lookup:{nullValue:!1,openOnTap:!0,autoCompleteAnywhere:!0}}},n.available.forEach(function(n){var t=b.findField(n);t=v[t.AliasIndex];s.items.list.push({value:t.Name,text:t.HeaderText})}),o.push(s))}),f||(u.push('<div data-container="row" style="padding:1em">'),u.push('<span data-control="field" data-field="_Match_addGroup" data-size="auto">[_addGroup]<\/span>'),u.push("<\/div>"),o.push({name:"_Match_addGroup",text:!1,placeholder:r.AddMatchingGroup.toLowerCase(),causesCalculate:!0,items:{list:[{value:"$matchall",text:r.MatchAll},{value:"$matchany",text:r.MatchAny},{value:"$donotmatchall",text:r.DoNotMatchAll},{value:"$donotmatchany",text:r.DoNotMatchAny}]},options:{lookup:{nullValue:!1,openOnTap:!0}}})),u.push("<\/div>"),u.push("<\/div>"),e.questions=o,e.layout=u.join("\r\n"),e.options||(e.options={discardChangesPrompt:!1,modal:{always:!0,max:ni(),fitContent:!0,dock:"top",autoGrow:!0},materialIcon:"search"}),f?(e.submitText=r.Apply,d=e.options,d.modal={always:!0,max:"xxs",fitContent:!0,autoGrow:!0},d.materialIcon="filter-list",e.text2="Filter",e.text=b.get_view().Label):(e.text||(e.text=b.get_view().Label,e.text2=r.AdvancedSearch),h=e.actions,h||(h=e.actions=[]),h.push({id:"resetSearch",text:l.ResetAdvancedSearch,icon:"material-icon-clear-all",execute:"searchreset.dataview.app",key:"Ctrl+R"}),b.get_showQuickFind()!==!1&&h.push({},{id:"showQuickFind",position:"after",text:r.ShowLess,execute:"quickfindshow.dataview.app"})),e}function li(){var n=s.value||"",ot=/(\"?(\S+)\:)\S*/g,l=ot.exec(n),rt,o,t,v,st,y=n=="",f=y?null:new RegExp(RegExp.escape(n.toString()),"i"),ht=y?null:new RegExp("^"+RegExp.escape(n.toString()),"i"),ct=b.viewProp("quickFindHistory")||[],i,k=s.dataInput,lt=k.closest('[data-container="row"]'),h=lt.next(),ut,a=6,at=a,d=[],g=[],vt=s.keyboard,ft=b._allFields,u,et;if(k.closest(".app-bar-search").toggleClass("app-null",y).find("input"),i=[],vt?ct.forEach(function(n){(!f||n.toString().match(f))&&i.push(n)}):i=ct.splice(y?0:1),n){while(l)rt=l[1],d.indexOf(l[2])==-1&&d.push(l[2]),l=ot.exec(n);d.length&&d.forEach(function(n){var t=[],i=n.replace(/\s/g,"").toLowerCase();ft.forEach(function(n){var r=ft[n.AliasIndex],u=r.HeaderText||r.Label||"";n.AllowQBE&&!n.Hidden&&u.replace(/\s/g,"").toLowerCase().startsWith(i)&&(t.push('"'+u+'"'),o||(o=r.Name))});t.length&&g.push('"'+n+':" = '+t.join(", "))});rt&&(n=n.substring(rt.length),f=n.length?new RegExp(RegExp.escape(n.toString()),"i"):null,ht=n.length?new RegExp("^"+RegExp.escape(n.toString()),"i"):null)}if(i.length<a&&f&&!b.tagged("search-suggestions-none")&&vt){at=i.length;t=b.viewProp("searchData");t||(t={});k.data("scannedDataItems")||(v=$("#"+b._id).find(".dv-item .ui-btn"),v.length||(v=$('[data-for="'+b._id+'"]').find(".dv-item .ui-btn")),v.each(function(){var i=$(this),n=i.data("data-context");n&&b._fields.forEach(function(i){var r,u,f;i=ft[i.AliasIndex];i.AllowQBE&&i.Type=="String"&&(r||(r=t[i.Name],r||(t[i.Name]=r=[])),u=n.row[i.Index],u!=null&&(f=i.format(u),r.indexOf(f)==-1&&(r.push(f),st=!0)))})}),st&&k.data("scannedDataItems",!0),b.viewProp("searchData",t));var c=[],r=[],yt=0;for(u in t)u=="_list"||o&&u!=o||t[u].forEach(function(n){n.match(ht)&&c.indexOf(n)==-1&&c.indexOf('"'+n+'"')==-1&&c.push(n)});if(c.sort(),c.length<a){for(u in t)u=="_list"||o&&u!=o||t[u].forEach(function(n){n.match(f)&&r.indexOf(n)==-1&&r.indexOf('"'+n+'"')==-1&&r.push(n)});r.sort()}for(r=c.concat(r);yt<r.length&&i.length<a;)et=r[yt++],i.indexOf(et)==-1&&i.push(et)}i.length||g.length?(h.is(".app-bar-history")||(h=nt("app-bar-history",'data-container="row"').insertAfter(lt)),h.show().empty(),ut=it().appendTo(h),g.length&&w("app-hint").text(g.join("; ")).appendTo(ut),$(i).each(function(t){if(t==a)return!1;var i=this,e=t>=at,r=f?i.match(f):null,u=w().attr("data-text",e?'"'+i+'"':i).appendTo(ut);r?(p().appendTo(u).text(i.substring(0,r.index)),$("<b/>").appendTo(u).text(i.substring(r.index,r.index+n.length)),p().appendTo(u).text(i.substring(r.index+n.length))):u.text(i);tt("app-icon material-icon").appendTo(u).text(e?"search":"history")}),e()):h.length&&(h.remove(),e())}var d,pt,b,at,gt,vt,yt,ot,st;if(u&&typeof u=="string"||(u="show"),b=s?typeof s=="string"?h(s):s._controller?s:h(s.id):t.contextDataView(),!b||!ft(b)){if(u=="mode")return b.asearch("mode");if(u=="toggle"&&(d=n._search("mode",b),d=d=="quickfind"?"advanced":"quickfind",b.asearch("mode",d)),u=="enumerate"){var et=[],lt,dt=t.scrollable(o()),ui=dt.offset();dt.find(".app-echo").each(function(){var r=$(this),i=h(r.attr("data-for")),u=i._totalRowCount,f=r.offset(),e=i.get_view();u!=-1&&f.top>=ui.top-1&&f.top<=ui.top+dt.height()-1&&e&&et.push({text:e.Label,icon:"search",desc:n.htmlToText(i.extension().instruction(!1)),count:u,callback:function(){t.summary("focus",i);n._search("show",i)}})});et.length&&(lt=function(){et.length===1?et[0].callback():(et.splice(0,0,{text:a}),showContextPanel(et,"#app-panel-search-menu",{position:"right"}))});lt||(t.navContext(et),$(et).each(function(){var n=this;if(n.icon=="search")return lt=function(){n.callback(n.context)},!1}));lt&&setTimeout(lt);return}if(u==="generate"&&n.survey("show",ct()),u==="parse")return fi();(u==="execute"&&(s.filter||(s=search("parse",s)),ei(s)),u==="addCondition"&&oi(),u==="changeMatch"&&hi(),u==="addGroup"&&si(),u==="reset"&&ci(),u==="autoComplete"&&li(),u==="show"||u==="toggle")&&(at=b.get_searchOnStart(),gt=o(),at&&(b._totalRowCount=0,o().attr("id")!==b._id?t.summary("refreshToolbar",b):t.refreshContext(!1,0),b._requiresContextRefresh=!0,b.set_searchOnStart(!1)),d=b.asearch("mode"),s||(s={}),vt=t.contextDataView(),yt={id:b._id,start:at,search:!0,field:s.field},vt&&vt!=b&&n.read(vt,"_survey.context.search")&&(t.pageInfo().deleted=!0,yt=vt.survey().context,at=yt.start),at&&(u!=="toggle"&&(pt=b.tagged("search-on-start-simple")?"quickfind":"advanced",d!==pt&&b.asearch("mode",pt),d=pt),v(function(){var n=t.pageInfo(),i=n.dataView.survey(),r=i&&i.context;g(function(){r&&!n._canceled&&t.sync(r.id)})})),d==="advanced"||s.field?(ot={controller:b._controller+"._search",parent:b._id,context:yt,dynamic:!1},ot.submit="searchperform.dataview.app",ot.submitText=a,ot.submitIcon="material-icon-search",ot.create="searchgenerate.dataview.app",ot.calculate="searchcalculate.dataview.app",ot.tryLoad=!1,n.survey(ot)):(st=b.extension().quickFind(),st===""&&(st=null),v(function(){n._search("autoComplete",{id:b._id,dataInput:o().find('[data-field="QuickFind"]'),value:st})}),n.survey({parent:b._id,controller:b._id+"-quickfind",context:yt,topics:[{questions:[{name:"QuickFind",text:!1,placeholder:String.format(r.QuickFindDescription,b.get_view().Label),value:st}]}],options:{modal:{fitContent:!0,always:!0,max:gt.is(".app-page-modal")&&!gt.is(".app-page-modal-dock")?"":ni(),title:!1,tapOut:!0,dock:"top"},actionButtons:!1,discardChangesPrompt:!1,contentStub:!1},layout:'<div class="app-container-search" data-container="simple" data-header-text="none" data-wrap="true"><div data-container="row" class="app-bar-search'+(st==null?" app-null":"")+'" data-density="'+(t.pointer("touch")?"comfortable":"relaxed")+'"><i class="app-icon material-icon material-icon-search" title="'+a+'">search<\/i><span data-control="field" data-field="QuickFind" data-notify="quickfindautocomplete.dataview.app">[Query]<\/span><i class="app-icon material-icon material-icon-cancel" title="'+r.ClearText+'">cancel<\/i><i class="app-icon material-icon material-icon-more app-btn-more" title="'+r.ShowMore+'"><\/i><\/div><\/div>',submitText:"Search",submit:"searchperform.dataview.app"})))}}})()