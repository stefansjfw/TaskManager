/*!
* Data Aquarium Framework - Survey
* Copyright 2008-2023 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function i(n){t&&t.busy(n)}var n=$app,t=n.touch,f=window,e=$(document),c=f.Web,l=Sys,a=l.CultureInfo.CurrentCulture,b=a.dateTimeFormat,r=c.DataViewResources,u=Web.DataViewResources.Data,v=u.Filters,o=v.Labels,k=r.HeaderFilter,d=r.ModalPopup,g=r.Pager,y=r.Mobile,nt=y.Files,tt=r.Validator,it=r.Actions.Scopes,p=r.Grid,rt=r.ODP,ut=r.Editor,ft=p.PerformAdvancedSearch,et=o.Clear,ot=u.NullValueInForms,st=u.NullValue,ht=o.And,s=n.findDataView,w=__baseUrl,h=__servicePath;n.survey=function(r,u){function ht(t){g=t.tags||t.options&&n.toTags(t.options)||"";t.text||(g+=" page-header-none ");t.tags=g}function ct(t){return n.find(u.parent).get_baseUrl()+(t.match(/\//)?t:"/js/surveys/"+t)}function ut(t){function e(){et(c);c.cache===!1&&(n.survey.library[o]=null)}try{c=eval(t);var r=c.layout||"";r.match(/(#ref|\.html)$/i)?(i(!0),$.ajax({url:ct(r=="#ref"?k+".html":r),dataType:"text",cache:!1}).done(function(n){i(!1);c.layout=n;e()}).fail(function(){i(!1);typeof u.create=="function"?u.create():n.alert("Unable to load survey layout for "+o+" from the server.")})):e()}catch(s){n.alert("The definiton of "+o+" survey is invalid.\n\n"+s.message+"\n\n"+(f.location.host.match(/\localhost\b/)?n.htmlEncode(s.stack):""))}}function ft(n){!n.topics&&n.questions&&(n.topics=[{questions:n.questions}],n.questions=null)}function et(i){var c,f,e,l,r;if(ft(i),c=u.parent,f=s(c),i.controller=o,i.baseUrl=f?f.get_baseUrl():w,i.servicePath=f?f.get_servicePath():h,i.confirmContext=u.confirmContext,i.showSearchBar=!0,i.parent=c,i.context=u.context,u.options){i.options||(i.options={});for(e in u.options)i.options[e]==null&&(i.options[e]=u.options[e])}if(i.submit||(i.submit=u.submit),i.submitText||(i.submitText=u.submitText),i.cancel!==!1&&(i.cancel=u.cancel),i.init||(i.init=u.init),i.calculate||(i.calculate=u.calculate),l=i.sharedInstance,l&&(r=t.dataView(),r&&r._survey&&r._survey.sharedInstance===l)){i.init=null;i.compiled=function(f){var e,o;for(e in r._backup)o=r._backup[e],o!=null?r[e]=o:delete r[e];r._pageSession={};t.scrollable().empty();r._survey.context=i.context;r._originalRow=[];r._editRow=[];r._onGetPageComplete(f,null);r.extension().layout();(u.values||[]).forEach(n=>{var t=r.findField(n.field||n.name);t&&(r._originalRow[t.Index]=n.value,r._editRow[t.Index]=n.value)});n.input.execute({values:u.values,raiseCalculate:!1});$(document).trigger($.Event("pagereadycomplete.app",{dataView:r,reverse:!1,page:t.activePage()}));t.scrollable("refresh")};n.survey("compile",i);return}n.showModal(f,o,"form1","New","",i.baseUrl,i.servicePath,[],{confirmContext:u.confirmContext,showSearchBar:i.showSearchBar,survey:i,tags:i.tags})}function p(n,t,i,r,u,f,e){var o='function(){var r=this,dv=r.dataView(),s=dv.survey(),e=$.Event("'+(typeof i=="string"?i:t)+'",{rules:r,dataView:dv,survey:s'+(e!=null?",argument:"+JSON.stringify(e):"")+"});"+(typeof i=="string"?"$(document).trigger(e);":"s."+t+"(e);")+(r==="Calculate"?"":"if(e.isDefaultPrevented())")+"r.preventDefault();}",s=o.match(/^function\s*\(\)\s*\{([\s\S]+?)\}\s*$/);u||(u="");n.push({Scope:6,Target:null,Type:1,Test:null,Result:"<id>r"+n.length+"<\/id><command>"+r+"<\/command><argument>"+u+"<\/argument><view>form1<\/view><phase>"+f+"<\/phase><js>"+s[1]+"<\/js>",ViewId:"form1"})}function ot(n,t,i,r,u){$(n).each(function(){var n=this;r&&r(n,t);$(n.questions).each(function(){var r=this;u&&u(r,n,t,i)});n.topics&&ot(n.topics,n,i+1,r,u)})}function tt(t,r,u,f){var e=[],o=[],s=[],h=[];if($(t).each(function(t){var i=this;i.ItemsDataValueField||(i.ItemsDataValueField=n.cache[i.ItemsDataController+"_"+i.ItemsDataView+"_DataValueField"]);i.ItemsDataTextField||(i.ItemsDataTextField=n.cache[i.ItemsDataController+"_"+i.ItemsDataView+"_DataTextField"]);i.ItemsDataValueField&&i.ItemsDataTextField||s.push({controller:i.ItemsDataController,view:i.ItemsDataView,requiresData:!1,metadataFilter:["fields"],_fieldIndex:t})}),s.length){i(!0);n.execute({batch:s,success:function(i){$(i).each(function(i){var r=t[s[i]._fieldIndex],u=this.rawResponse;r.ItemsDataValueField||$(u.Fields).each(function(){var t=this;if(t.IsPrimaryKey)return r.ItemsDataValueField=t.Name,n.cache[r.ItemsDataController+"_"+r.ItemsDataView+"_DataValueField"]=t.Name,!1});r.ItemsDataTextField||(r.ItemsDataTextField=u.Fields[0].Name,n.cache[r.ItemsDataController+"_"+r.ItemsDataView+"_DataTextField"]=r.ItemsDataTextField)});tt(t,r,u,f)},error:function(){i(!1)}});return}$(t).each(function(){var t=this,i,v=t._dataView,y=[t.ItemsDataValueField,t.ItemsDataTextField],p=t.Copy,w=t.ContextFields,b={controller:t.ItemsDataController,view:t.ItemsDataView,sortExpression:t.ItemsDataTextField,fieldFilter:y,metadataFilter:["fields"],pageSize:1e3,distinct:n.is(t.Tag,"lookup-distinct")},f,s,c,a,l;if(p)while(i=n._fieldMapRegex.exec(p))y.push(i[2]);if(w){for(f=[];i=n._fieldMapRegex.exec(w);)v?s=v.findField(i[2]):$(r).each(function(){var n=this;if(n.Name==i[2])return s=n,!1}),c=u[s.Index],a=!vt(s,t),(a||c!=null)&&(c==null&&a?(t.Items=[],h.push(t)):s.ItemsTargetController||s.ItemsStyle==="CheckBoxList"?(l=n.csv.toArray(c),l.length<=1?f.push({field:i[1],value:l[0]}):f.push({field:i[1],operator:"in",values:l})):f.push({field:i[1],value:c}));f.length&&(b.filter=f)}t.skipPopulate||h.indexOf(t)!=-1||(e.push(b),o.push(t))});e.length?(i(!0),n.execute({batch:e,done:function(n){i(!1);$(o).each(function(t){var r=this,u=e[t],f=n[t].rawResponse,i={};$(f.Fields).each(function(n){i[this.Name]=n});r.Items=[];$(f.Rows).each(function(){for(var f=this,t=[],n=0;n<u.fieldFilter.length;n++)t.push(f[i[u.fieldFilter[n]]]);i.group_count_!=null&&t.push(f[i.group_count_]);r.Items.push(t)})});f&&f(o.concat(h))},fail:function(){i(!1)}})):f&&h.length&&f(o)}function lt(n){var i=t.dataView(),r=i.extension();u.compiled=function(f){var o=r._disposeForm(),e;i._views[0].Layout=u.layout;e=t.createLayout(i,t.calcWidth(o.parent()));e=e.insertAfter(o);t.prepareLayout(i,f.NewRow,e);o.remove();r._skipRefresh=!0;i._pageIndex=-1;i._editRow=null;i._onGetPageComplete(f,null);r._skipRefresh=!1;r.stateChanged(!1);n&&n(e)};st()}function at(t,i){var r=n.survey,u;return r.registrations||(r.registrations={}),u=r.registrations[t]!=!0,r.registrations[t]=!0,u&&i&&i(),u}function vt(n,t){var i=n.ContextFields,r=new RegExp("=\\s*"+t.Name+"\\s*(,|$)");return!!(i&&i.match(r))}function it(n,t){var f,r,i;return t||(t="string"),f=n,typeof n!=t&&(i=u._expr,i||(i=u._expr=[]),r=n,typeof r!="function"&&(r=function(){return n}),f="this._survey._expr["+i.length+"].call(this, this)",i.push(r)),f}function st(){function h(n,i,r){t.Expressions.push({Scope:n,Target:i,Test:r,Type:1,ViewId:"form1"})}var i=[],v={},b=0,s=u.context,r=s&&s._initData,t={Controller:o,View:"form1",TotalRowCount:-1,Fields:[{Name:"sys_pk_",Type:"Int32",Label:"",IsPrimaryKey:!0,ReadOnly:!0,Hidden:!0,AllowNulls:!0,Columns:20}],Views:[{Id:"form1",Label:u.text,Type:"Form"}],ViewHeaderText:u.description,ViewLayout:u.layout,Expressions:[],ActionGroups:[{Scope:"Form",Id:"form",Actions:[]}],Categories:[],NewRow:[1],Rows:[]},y=u.actions||u.buttons,c,l,a,w,f;return u.submit&&(c=u.submitKey,t.ActionGroups[0].Actions.push({Id:"submit",CommandName:"Confirm",WhenLastCommandName:"New",HeaderText:u.submitText,Confirmation:u.submitConfirmation,Key:c===!1?null:c||"Enter",CssClass:u.submitIcon})),u.cancel!=!1&&t.ActionGroups[0].Actions.push({Id:"a2",CommandName:"Cancel",WhenLastCommandName:"New"}),ft(u),l=0,ot(u.topics,null,0,function(n,i,r){var u=t.Categories.length,e=n.visibleWhen,f={Id:"c"+u,Index:u,HeaderText:n.text,Description:n.description,Wizard:n.wizard,Flow:n.flow=="newColumn"||l==0?"NewColumn":n.flow=="newRow"?"NewRow":"",Wrap:n.wrap!=null?n.wrap:null,Floating:!!n.floating,Collapsed:n.collapsed==!0,Tab:n.tab};e!=null&&h(2,f.Id,it(e));r>0&&(f.Depth=r);t.Categories.push(f);n._categoryIndex=u;l++},function(f,e){var a=f.type||"String",y=f.format||f.dataFormatString,et=f.mode,p=f.columns,tt=f.rows,ot=f.options,g=ot?n.toTags(ot):f.tags,c=f.items,w,rt,ut,l=f.value,nt=f.context,b=f.name||"q"+t.Fields.length,st=f.visibleWhen,ht=f.readOnlyWhen,ct=f.tooltip,lt=f.label,at=lt==null?f.text:lt,vt=f.autoCompletePrefixLength,o={Name:b,HtmlEncode:!0,AllowNulls:f.required!=!0,Label:at===!1?"&nbsp;":at||n.prettyText(f.name),Hidden:f.hidden==!0,CausesCalculate:f.causesCalculate==!0},ft,k,d;if(b){r&&(b in r?l=r[b]:"value"in f&&(r[b]=l,s._initVals.push({field:b,value:l})));f.causesCalculate&&(o.CausesCalculate=!0);switch(a.toLowerCase()){case"text":case"string":a="String";break;case"date":a="DateTime";y||(y="d",p==null&&(p=10));break;case"datetime":a="DateTime";p==null&&(p=20);break;case"time":a="DateTime";y||(y="t",p==null&&(p=8));break;case"number":a="Double";break;case"int":a="Int32";break;case"bool":case"Boolean":a="Boolean";!c&&f.required&&(c={style:"CheckBox"},l==null&&(l=!1));break;case"money":a="Currency";break;case"memo":a="String";tt==null&&(tt=5);break;case"blob":a="Byte[]";o.OnDemand=!0;o.Multiple=f.multiple}o.Type=a;a==="String"&&(o.Len=f.length||100);a!=="DateTime"||y||(y="g");a!=="Currency"||y||(y="c");y&&(typeof y=="string"?o.DataFormatString=y:(ft=y.DataFormatString,ft&&(o.DataFormatString=ft,a==="DateTime"&&(o.TimeFmtStr=y.TimeFmtStr,o.DateFmtStr=y.DateFmtStr)),delete f.format));p&&(o.Columns=p);tt&&(o.Rows=tt,a==="String"&&tt>1&&(o.Len=0));f.placeholder&&(o.Watermark=f.placeholder);vt&&(o.AutoCompletePrefixLength=vt);g&&(o.Tag=typeof g=="string"?g:g.join(","));nt&&(typeof nt!="string"&&(nt.forEach(function(n,t){n.match(/=/)||(nt[t]=n+"="+n)}),nt=nt.join(",")),o.ContextFields=nt);f.htmlEncode===!1&&(o.HtmlEncode=!1);et&&(o.TextMode=["password","rtf","note","static"].indexOf(et)+1);(u.readOnly||f.readOnly&&typeof f.readOnly!="function")&&(o.ReadOnly=!0);o.Hidden||(o.CategoryIndex=e._categoryIndex);f.extended&&(o.Extended=f.extended);f.altText&&(o.AltHeaderText=f.altText);f.footer&&(o.FooterText=f.footer);ct&&(o.ToolTip=ct);f.htmlEncode==!1&&(o.HtmlEncode=!1);k=c&&c.filter;k&&(typeof k!="string"&&(k=[],$(c.filter).each(function(){var n=this;k.push(n.match+"="+n.to)}),k=k.join(",")),o.ContextFields=k);c&&(rt=c.controller,w=c.style||(c.list||!rt?"DropDownList":"Lookup"),o.Items=[],_isTagged(g,"lookup-auto-complete-anywhere")&&(o.SearchOptions="$autocompleteanywhere"),w==="Lookup"&&_isTagged(g,"lookup-distinct")&&(w="AutoComplete"),w.match(/AutoComplete|Lookup|DropDown/)&&_isTagged(g,"lookup-multiple")&&(o.ItemsTargetController="_basket",w==="AutoComplete"&&l!=null&&(c.dataValueField===c.dataTextField?(typeof l=="string"&&(l=n.csv.toArray(l)),$(l).each(function(){var n=this;o.Items.push([n,n,null])})):i.push(o))),ut=c.targetController,ut&&(o.ItemsTargetController=ut),l!=null&&(o.ItemsTargetController||w==="CheckBoxList")&&(Array.isArray(l)?l=n.csv.toString(l):typeof l!="string"&&(l=l.toString())),c.list?$(c.list).each(function(){var n=this,t=n.value,i=n.text,r=n.count,u=[t,i==null?t:i];r!=null&&u.push(r);o.Items.push(u)}):rt&&(o.ItemsDataController=rt,o.ItemsDataView=c.view||"grid1",o.ItemsDataValueField=c.dataValueField,o.ItemsDataTextField=c.dataTextField,o.ItemsNewDataView=c.newView,w.match(/AutoComplete|Lookup/)||i.push(o),c.dataValueField!==c.dataTextField&&(o._autoAlias=!0)),o.ItemsStyle=w,c.disabled&&(o.ItemsStyle=null),d=c.copy,d&&(typeof d!="string"&&(d=[],$(c.copy).each(function(){var n=this;d.push(n.to+"="+n.from);n.from===c.dataTextField&&(o.AliasName=n.to,o._autoAlias=!1)}),d=d.join("\n")),o.Copy=d));"default"in f&&(o._defVal=f.default);st!=null&&h(3,b,it(st));ht!=null&&h(5,b,it(ht),5);t.Fields.push(o);v[o.Name]=o;typeof l!="function"&&(t.NewRow[t.Fields.length-1]=l)}}),t.Fields.forEach(function(t){var i=t.ContextFields;t.Index=b++;i&&$(i.split(n._simpleListRegex)).each(function(){var i=this.split(n._fieldMapRegex),r=i?v[i[2]]:null;if(r&&r.ItemsDataController===t.ItemsDataController)return t.requiresDynamicNullItem=!0,!1})}),u.init&&p(t.Expressions,"init",u.init,"New","form1","After"),u.submit&&p(t.Expressions,"submit",u.submit,"Confirm",null,"Before"),u.cancel&&p(t.Expressions,"cancel",u.cancel,"Cancel",null,"Before"),u.calculate&&p(t.Expressions,"calculate",u.calculate,"Calculate",null,"Execute"),y&&(a={form:t.ActionGroups[0]},w=0,u._handlers={},y.forEach(function(n,i){var r=n.scope,f,o,c=n.when,l=n.click||n.execute||n.trigger,s=n.id||"b"+i,v=n.text,y=n.position,h;r||(r="form");f=a[r];o=v?{Id:s,CommandName:s,WhenLastCommandName:"New",HeaderText:v,Key:n.key,CausesValidation:n.causesValidation,Confirmation:n.confirmation}:{Id:"div"+f.Actions.length,WhenLastCommandName:"New"};n.icon&&(o.CssClass=n.icon);c&&(o.WhenClientScript=typeof c=="function"?c:function(){var t=$.Event(c,{dataView:this,argument:n.argument});return e.trigger(t),!t.isDefaultPrevented()});f||(f={Scope:r[0].toUpperCase()+r.substring(1),Id:r,Actions:[]},t.ActionGroups.push(f),a[r]=f);h=f.Actions;r==="form"&&y!=="after"?y==="before"||u.cancel===!1?h.splice(w++,0,o):h.splice(h.length-1,0,o):h.push(o);l&&(typeof l=="function"&&(u._handlers[s]=function(n){n.preventDefault();l.call(n.dataView,n)}),p(t.Expressions,"_handlers."+s,l,s,null,"Execute",n.argument))})),ht(u),t.Tag=(u.tags||"")+" ignore-unsaved-changes",t.Fields.length===1&&(t.Fields[0].Hidden=!1),f=u.compiled,f&&(i.length?tt(i,t.Fields,t.NewRow,function(){f(t)}):f(t),u.compiled=null),t}function rt(){i(!1);var t=u.create;t?typeof t=="string"?e.trigger($.Event(t,{survey:u})):t.call(u):n.alert("Unable to load survey "+o+" from the server.")}var v,c,b,d;typeof r!="string"&&(u=arguments[0],r="show");var k=u.controller||"survey",y=k.match(/^(.+?)((.\[min\])?\.js)?$/),o=y[1].replace(/\W/g,"_"),g,l=u.values||u.data,a,nt;if(y[2])if(v=n.survey.library[y[1]+".js"],v)n.survey.library[o]=v;else{n.getScript("~/js/surveys/"+u.controller,{also:u.also}).then(function(){if(v=n.survey.library[y[1]+".js"],v)n.survey.library[o]=v;else throw new Error("Unable to load "+k+" script. Make sure to assign the survey defintion to the $app.survey.library['"+y[1]+".js'] entry.");n.survey(r,u)}).catch(()=>{t&&t.notify({text:"Unable to load ~/js/surveys/"+u.controller,duration:"long"})});return}if(r==="show"&&l){if(Array.isArray(l))u.data=a={},l.forEach(function(n){a[n.field||n.name]="newValue"in n?n.newValue:"oldValue"in n?n.oldValue:n.value});else{a=l;l=[];for(nt in a)l.push({name:nt,value:a[nt]})}u.context||(u.context={});u.values=u.context._initVals=l;u.data=u.context._initData=a}if(u.external=!(u.topics||u.questions),r==="show")u.external?(c=n.survey.library[o],c?ut(c):(i(!0),b=s(u.parent),u.tryLoad===!1||n.survey.failedToLoad[o]?rt({}):$.ajax({url:h+"/GetSurvey",data:JSON.stringify({name:k}),processData:!1,method:"POST",cache:!1}).done(function(t){i(!1);t=t.d;typeof t=="string"?(n.survey.library[o]=t,ut(t)):(rt(t),n.survey.failedToLoad[o]=!0)}).fail(rt))):et(u);else{if(r==="compile")return st();if(r==="populateItems")d=[],b=u.dataView,$(b._allFields).each(function(){var n=this;n.ItemsAreDynamic&&n.ContextFields&&!n.skipPopulate&&d.push(n)}),d.length&&tt(d,b._allFields,b.row(),u.callback);else if(r==="refresh")lt(arguments[2]);else{if(r==="register")return at(arguments[1],arguments[2]);n.alert("Unsupported survey method: "+r)}}};n.survey.library={};n.survey.failedToLoad={}})()