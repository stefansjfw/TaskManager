/*!
* Data Aquarium Framework  - Universal Scanner and Input
* Copyright 2023 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function l(n,t){var r=o[n],i;return r&&(t||(i=r.video.closest(".ui-page")),t||!i.length||i.is(".app-internal-form-scanner")&&!i.is(".ui-page-active"))?(r.controls.stop(),delete o[n],!0):!1}function p(u,f){var h=u.closest(".ui-page"),s,e,c;f?h.find('[data-input-enhancement="scanner"] [data-state="active"]').length||(u.show().attr("data-state","active"),i.resetPageHeight()):u.attr("data-state")==="active"?(s=o[r],s&&u.has(s.video)&&l(r,!0),u.attr("data-state","pending").hide(),e=h.find('[data-input-enhancement="scanner"].app-null [data-state="inactive"]').first().attr("data-state","active").show(),i.resetPageHeight(),u.attr("data-state","inactive"),e.length&&(c=t.elementToField(e),n.input.methods.scanner._read(e.find("video"),c))):u.hide()}function f(){var n=[];return new Promise(function(t,i){y.length&&(new Date).getTime()-f._lastTest<6e5?t(y):navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(u=>{var o,e;if(u.forEach(t=>{t.kind==="videoinput"&&(n.push({value:t.deviceId,text:t.label}),t.deviceId===r&&(o=!0))}),y=n,n.length){for(f._lastTest=(new Date).getTime(),e=0;e<n.length;e++)n[e].text||(n[e].text="Camera "+(e+1),f._lastTest=null);o||(r=n[n.length-1].value);t(n)}else r=null,i(new Error(v.ODP.UnableToExec))}):i(n)})}function g(i,r){var u=t.of(i),e=t.elementToField(u),f=u.find("video");(r||!f.is(":visible"))&&n.input.methods.scanner._read(f,e)}function it(n){$app.touch.notify({text:n.message,duration:"long"})}function w(t){e=t;i.activePage().addClass("app-transition-none");var u=t instanceof Array;l(r,!0);i.goBack(()=>{u?n.input.barcode.apply(n.input.barcode,t):n.input.barcode(t)})}function s(n){i.pointer("touch")||t.focus({field:n||"Result"})}var n=$app,t=n.input,i=n.touch,a=i.settings,v=Web.DataViewResources,h=v.Mobile,nt=a("barcodeReader.viewFinder.height")||"120",c,o={},y=[],r=n.userVar("scannerDeviceId"),b,e,k={"1D":"BrowserMultiFormatOneDReader",Multi:"BrowserMultiFormatReader",QRCode:"BrowserQRCodeReader",Aztec:"BrowserAztecCodeReader",DataMatrix:"BrowserDatamatrixCodeReader",PDF417:"BrowserPDF417CodeReader"},u=n.html,rt=u.tag,ut=u.div,ft=u.span,tt=u.$tag,et=u.$p,d=u.$div,ot=u.$span,st=u.$a,ht=u.$i,ct=u.$li,lt=u.$ul;setInterval(()=>{for(var n in o)if(l(n))return},2500);n.input.methods.scanner={_init:function(t,r,u,f){var e=f.find("video"),s=f.closest(".app-control-after"),l=t.tagged("input-scanner-view-finder-always")||t.tagged("input-scanner-value-hidden"),v=t._dataView.editing()&&(r==null||l),o,y;t._dataView._inlineEditor||i.uiAutomation()?s.hide():!e.length&&v?(o=d("app-enhancement-frame").appendTo(f).css({width:"100%",height:"100%",position:"relative",overflow:"hidden"}),y=n.clientRect(o),y.height<10&&o.parent().css({width:"100%",height:nt}),s.show().attr("data-state",s.closest(".ui-page").find('[data-input-enhancement="scanner"] [data-state="active"]').length?"inactive":"active"),i.icon("material-icon-more-"+(n.agent.chromeOS||n.agent.android?"vert":"horiz"),o).attr("title",h.More),e=tt("video").appendTo(o),e[0].disablePictureInPicture=!0,c?n.input.methods.scanner._read(e,t):n.getScript("~/js/lib/zxing.min.js",{also:"~/css/daf/input-scanner.[min].css"}).then(()=>{c=new ZXingBrowser[k[a("barcodeReader.format")]||k.Multi],n.input.methods.scanner._read(e,t)})):l||p(s,v)},_read:function(u,h){f().then(()=>{var a=u.closest(".app-control-after");if(c&&a.attr("data-state")!=="inactive"){if(l(r,!0)){setTimeout(n.input.methods.scanner._read,0,u,h);return}a.is(":visible")||p(a,!0);a.find(".app-scan-error").remove();c.decodeFromVideoDevice(r,u[0],(n,c,l)=>{if(o[r]||(o[r]={video:u,controls:l}),n&&!i.busy()&&!h._dataView._busy()&&u.closest(".ui-page-active").length){var v=h._dataView.data(),a=n.text;v[h.Name]!==a&&(a!=f._lastResultText||f._lastResultDate&&(new Date).getTime()-f._lastResultDate>3e3)&&(u.closest(".app-enhancement-frame").addClass("app-detected"),f._lastResultText=a,f._lastResultDate=(new Date).getTime(),e=a,setTimeout(()=>{u.closest(".app-enhancement-frame").removeClass("app-detected"),t.execute({values:{name:h.Name,value:a}}),s(h.Name)},100))}c}).catch(n=>{d("app-scan-error").insertBefore(u).text(n.message)})}}).catch(()=>{u.closest(".app-control-after").hide()})},render:function(n){t.methods.text.render(n)},focus:function(n){return t.methods.text.focus(n)},click:function(n){t.methods.text.click(n)},blur:function(n){t.methods.text.blur(n)},setup:function(n){t.methods.text.setup(n)},_showForm:function(){i.busy(!0);f().then(t=>{i.busy(!1),i.whenPageShown(()=>i.activePage().addClass("app-internal-form-scanner")),$app.survey({context:{devices:t},text:h.Scan,text2:$app.touch.appName(),values:{Source:r,InventoryMode:n.userVar("scannerInventoryMode")||!1,InventoryResult:b},topics:[{wrap:!0,questions:[{name:"Result",type:"text",text:!1,placeholder:h.ScanHint,causesCalculate:!0,options:{focus:{auto:!0},input:{scanner:{viewFinder:"always"}}}},{name:"InventoryMode",type:"boolean",text:h.ScanInvMode,items:{style:"CheckBox",list:[{value:!1,text:"No"},{value:!0,text:"Yes"},]},causesCalculate:!0},{name:"InventoryResult",text:!1,mode:"static",visibleWhen:"$row.InventoryMode",options:{mergeWithPrevious:!0,textAction:"copy"}},{name:"InventoryActions",text:!1,rows:1,items:{style:"Actions"},options:{mergeWithPrevious:!0},visibleWhen:function(){return this.fieldValue("InventoryMode")&&this.fieldValue("InventoryResult")!=null}}]}],actions:[{text:h.LookupClearAction,execute:"scannerformclear.scanner.app",scope:"InventoryActions"},{text:v.Editor.Undo,execute:"scannerformundo.scanner.app",scope:"InventoryActions",when:function(){return(this.fieldValue("InventoryResult")||"").match(/\s/)}}],options:{modal:{fitContent:!0,autoGrow:!0,max:"xxs"},materialIcon:(a("barcodeReader.icon")||"barcode-reader").replace("material-icon-",""),discardChangesPrompt:!1,internal:{form:"scanner"}},submitText:h.Send,submit:"scannerformsubmit.scanner.app",calculate:"scannerformcalculate.scanner.app.app"})}).catch(n=>{i.busy(!1),it(n)})}};$(document).on("scannerformcalculate.scanner.app.app",i=>{var u=i.dataView.data(),f,r;switch(i.rules.arguments().CommandArgument){case"Result":f=u.Result;i.survey.context._codeDetected=(new Date).getTime();u.InventoryMode?(r=u.InventoryResult||"",r.length&&(r+=" "),f==null?setTimeout(s):(r+=f,setTimeout(()=>{t.execute({values:{Result:null,InventoryResult:r}}),s()},100))):w(f);break;case"InventoryMode":n.userVar("scannerInventoryMode",u.InventoryMode?!0:null);setTimeout(s)}return!1}).on("scannerformsubmit.scanner.app",n=>{var t,i;(n.preventDefault(),(new Date).getTime()-n.survey.context._codeDetected<250)||(t=n.dataView.data(),t.InventoryMode?(i=t.InventoryResult,i==null?s():(b=i,w(i.split(/\s+/)))):t.Result==null?s():w(t.Result))}).on("scannerformclear.scanner.app",n=>{n.preventDefault(),t.execute({InventoryResult:null})}).on("scannerformundo.scanner.app",n=>{n.preventDefault();var r=n.dataView.data(),i=r.InventoryResult.split(/\s+/g);i.splice(i.length-1,1);t.execute({InventoryResult:i.join(" ")});s()}).on("setvalue.input.app",'[data-input-enhancement="scanner"]',n=>{var r=n.inputValue,i,u;r!=null&&r.length?(i=t.of(n.inputElement),u=t.elementToField(i),u.tagged("input-scanner-view-finder-always")||setTimeout(()=>{p(i.find(".app-control-after"),!1)})):g(n.target)}).on("vclick",'[data-input-enhancement="scanner"] .app-enhancement-frame .app-icon',u=>{var l=t.of(u.target),v=t.elementToField(l),h=[],c=r,a=n.clientRect(u.target);return o[c]&&o[c].video.closest(".ui-page-active").length||(c=null),f().then(f=>{f.forEach((t,i)=>{h.push({text:t.text,icon:t.value===c?"check":null,context:t,callback:t=>{r=t.value,n.userVar("scannerDeviceId",i===f.length-1?null:r),g(u.target,!0)}})}),h.length&&(e&&(h.push({}),Array.isArray(e)||(e=e.split(/\s+/g)),e.forEach(n=>{h.push({text:n,context:n,callback:n=>{var i=e;t.execute({field:l.data("field"),value:n});s(l.data("field"));e=i}})})),i.activePage().removeData("last-focused-field"),i.listPopup({arrow:"b,t,l,r",x:a.left+a.width/2,y:a.top,items:h}))}),!1})})()