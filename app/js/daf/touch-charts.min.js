/*!
* Data Aquarium Framework - Charts for Touch UI
* Copyright 2008-2023 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function h(){return n.dataView()}function v(){return c().is(".app-reading-pane-detail")?w(h()._parentDataViewId):h()}function b(t){return n.pageInfo(t).scrollable}var r=$("body"),y=$(window),t=$app,n=t.touch,c=n.activePage,p=n.scrollable,w=t.findDataView,l=n.vibrate,f=t.html,d=f.tag,g=f.div,nt=f.span,o=f.$tag,k=f.$p,i=f.$div,e=f.$span,u=f.$a,tt=f.$i,s=f.$li,a=f.$ul;(function(){function p(n){return n.match(/pie|donut/i)}function u(t,i,r,u){r||(r="visualization");u||(u="1");var e=r+u+(typeof t=="string"?t:t.join("-")),f=b[e];f&&f.loaded?i():f&&!f.loaded?f.callbacks.push(i):(n.busyIndicator(!0),f=b[e]={loaded:!1,callbacks:[i]},google.charts.load("current",{packages:[t],mapsApiKey:n.mapsApiKey(),callback:function(){n.busyIndicator(!1);f.loaded=!0;$(f.callbacks).each(function(){this()})}}))}function k(n,t){var r=i("app-chart-headerbar").appendTo(t),s=i('app-chart-mini"').appendTo(r).attr("title",h.ShowChart),c=n.Properties.title||n.Title,v=e("app-chart-header").appendTo(r),f=i("app-chart-data app-scrollable").appendTo(t),l=o("table").appendTo(f),a=!n.ChartType.match(/map|table/);a||s.hide();t.closest(".app-chart").addClass("app-chart-has-data");n.ShowData=!0;u("corechart",function(){var r=google.visualization.arrayToDataTable(n.ChartData),y=r.getNumberOfRows(),h=r.getNumberOfColumns(),e=o("tr").appendTo(l),u,i,t,f;for(v.text(c.substring(0,1).toUpperCase()+c.substring(1)),d(n,r),i=0;i<h;i++)t=r.getColumnLabel(i),f=o("th").appendTo(e),t!=null&&f.text(t).attr("title",t);for(u=0;u<y;u++)for(e=o("tr").appendTo(l),i=0;i<h;i++)t=r.getFormattedValue(u,i),f=o("td").appendTo(e),t!=null&&f.text(t=="0"?"":t).attr("title",t);a&&w(n,s)});f.height(Math.floor(t.height()-r.outerHeight(!0)));f.width(t.width())}function w(n,t){var i=g[n.ChartType];i&&i(n,t)}function f(n,t,i){var u=p(n.ChartType),s=n.Properties.title||n.Title,e,r,f,o;i||(i={});i.legend||(i.legend={});i.hAxis||(i.hAxis={});i.vAxis||(i.vAxis={});i.chartArea||(i.chartArea={});i.tooltip||(i.tooltip={});i.title=s.charAt(0).toUpperCase()+s.slice(1);i.width=Math.floor(t.width())-1;i.height=Math.floor(t.height())-1;i.tooltip.trigger="focus";n.ChartData[0].length<=2&&(u||(i.legend.position="none"),u&&(n.Properties.maximize=!0));u&&(i.sliceVisibilityThreshold=0);for(e in n.Properties)if(n.Properties.hasOwnProperty(e)){r=n.Properties[e];switch(e){case"crosshair":i.crosshair={orientation:r==0?"both":r,trigger:"both"};break;case"maximize":u?(i.chartArea.top="15%",i.chartArea.width="80%",i.chartArea.height="80%"):(i.titlePosition="in",i.chartArea.width="100%",i.chartArea.height="100%",i.legend.position||(i.legend.position="in"));i.axisTitlesPosition="in";i.hAxis.textPosition="in";i.vAxis.textPosition="in";break;case"haxistitle":i.hAxis.title=r;break;case"vaxistitle":i.vAxis.title=r;break;case"haxisformat":i.hAxis.format=r;break;case"vaxisformat":i.vAxis.format=r;break;case"region":i.region=r;break;case"displaymode":i.displayMode=r;break;case"resolution":i.resolution=r;break;case"curve":i.curveType="function";break;case"explorer":i.explorer={};break;case"maptype":i.mapType=r;break;case"enablescrollwheel":i.enableScrollWheel=!0;break;case"usemaptypecontrol":i.useMapTypeControl=!0;break;case"pointshape":i.pointShape=r;break;case"pointsize":i.pointSize=r;break;case"orientation":i.orientation=r;break;case"animation":i.animation={startup:!0,duration:500,easing:"out"};break;case"colors":f=r.split(",");for(o in f)f[o]=f[o].trim();i.colors=f}}return n.ShowData&&(i.legend.position="none",i.axisTitlesPosition="none",i.height="100%",i.titlePosition="none",i.chartArea.top="0",i.chartArea.width="100%",i.chartArea.height="100%",i.enableInteractivity=!1),$("body").hasClass("app-theme-dark")&&(i.backgroundColor="#111",i.hAxis.textStyle={color:"white"},i.hAxis.gridlines={color:"#333"},i.vAxis.textStyle={color:"white"},i.vAxis.gridlines={color:"#333"},i.legend.textStyle={color:"#999"},i.legend.scrollArrows={activeColor:"#fff",inactiveColor:"#777"},i.legend.pagingTextStyle={color:"#999"},i.titleTextStyle={color:"white"},u&&(i.pieSliceBorderColor="#111")),i}function d(n,t){var s=n.ValueFieldNames.length,u,r;for(u in n.Formats){var i=n.Formats[u],f=/(\w+)(\d)/.exec(u),h=f[1],c=f[2],e=n.ValueFieldNames.indexOf(h,c),o;if(e!=-1&&i){switch(i.toLowerCase()){case"c":i="Â¤00.00";break;case"d":i="00.00";break;case"e":i="0.######E+000";break;case"f":i="00.00";break;case"n":i="00.00";break;case"p":i="%";break;case"x":i="00.00"}for(o=new google.visualization.NumberFormat({pattern:i}),r=e+1;r<n.Data[0].length;r=r+s)o.format(t,r)}}}function s(t,i,r,u){function o(){}var f=google.visualization.arrayToDataTable(t.ChartData),e=t.ChartType.match(/geo/i);d(t,f);n.desktop()||e||o();t.Properties.animation&&!e&&t.ChartType!="map"&&r.draw(null,u);r.draw(f,u);n.desktop()&&!e&&(google.visualization.events.addListener(r,"select",function(){if(u.tooltip.trigger=="focus"){u.tooltip.trigger="selection";var n=r.getSelection();return o(),r.draw(f,u),r.setSelection(n),!1}}),google.visualization.events.addListener(r,"click",function(n){n.targetID.match(/^action/)||u.tooltip.trigger!="selection"||(u.tooltip.trigger="focus",r.removeAction("filter"),r.removeAction("exclude"),r.setSelection(null),r.draw(f,u))}))}var b={},h=Web.DataViewResources.Presenters.Charts,l=Web.DataViewResources.Mobile,g;$(document).on("resizing.app",function(){c(".app-chart-inner").children().hide()}).on("searching.app",function(n){var t=n.dataView._id;$("#"+t+'.ui-page .app-wrapper > [data-presenter="Charts"] .app-chart-inner, .app-echo[data-for="'+t+'"] .app-chart-inner').children().hide()}).on("vclick",".app-chart",function(i){function g(){delete e.ShowData;f.viewProp("chartsConfig",c);var t=u.closest(".app-chart-list").parent().data("pivots")["pivot"+d],n=u.closest(".app-chart").find(".app-chart-inner");n.empty();n.closest(".app-chart").removeClass("app-chart-has-data");t.ShowData=!1;w(t,n)}var u=$(i.target),nt=u.closest(".app-echo"),f=nt.length?t.find(nt.attr("data-for")):v(),s=u.closest(".app-chart").data("data-context");if(f&&s){var d=s.Id,c=f.viewProp("chartsConfig"),e=c&&c[d],p=r.is(".app-has-sidebar-left")&&!r.is(".app-has-minisidebar-left"),b=y.width()/parseFloat(r.css("font-size")),tt=p&&b>=50||!p&&b>=40,it=p&&b>=85||!p&&b>=62,a=e.size?e.size:"small",o=[];return u.is(".app-btn-more")&&!t.touch.busy()?(t.touch.callWithFeedback(u.closest(".ui-btn"),function(){a!="large"||it||(a="medium");a!="medium"||tt||(a="small");var t=u.closest(".app-chart-list").parent().data("pivots")["pivot"+d];t.ChartType.match(/map|table/)||(e.ShowData?o.push({text:h.ShowChart,icon:"chart",callback:g}):o.push({text:h.ShowData,icon:"grid",callback:function(){e.ShowData=!0;f.viewProp("chartsConfig",c);var n=u.closest(".app-chart").find(".app-chart-inner");n.empty();k(t,n)}}));u.closest(".app-chart-list").find(".app-chart").length>1?(o.push({text:h.Sizes.Label}),o.push({text:h.Sizes.Small,icon:a=="small"?"check":"",callback:function(){delete e.size;e.resized=!0;f.viewProp("chartsConfig",c);n.presenter("show",{name:"Charts",id:f._id,container:u.closest(".app-wrapper")})}}),tt&&o.push({text:h.Sizes.Medium,icon:a=="medium"?"check":"",callback:function(){e.size="medium";e.resized=!0;f.viewProp("chartsConfig",c);n.presenter("show",{name:"Charts",id:f._id,container:u.closest(".app-wrapper")})}}),it&&o.push({text:h.Sizes.Large,icon:a=="large"?"check":"",callback:function(){e.size="large";e.resized=!0;f.viewProp("chartsConfig",c);n.presenter("show",{name:"Charts",id:f._id,container:u.closest(".app-wrapper")})}})):o.push({text:h.Sizes.Auto,icon:"check",callback:function(){}});o.push({text:l.Filter});s.ColumnFieldNames&&s.ColumnFieldNames.length&&o.push({text:f.findField(s.ColumnFieldNames[0]).HeaderText,icon:"material-icon-filter-list",callback:function(){n.configureFilter({field:s.ColumnFieldNames[0],scope:f._id,mode:"field"})}});s.RowFieldNames&&s.RowFieldNames.length&&o.push({text:f.findField(s.RowFieldNames[0]).HeaderText,icon:"material-icon-filter-list",callback:function(){n.configureFilter({field:s.RowFieldNames[0],scope:f._id,mode:"field"})}});n.listPopup({anchor:u.closest("a"),iconPos:"right",items:o})}),!1):u.closest(".app-chart-mini").length?(g(),!1):void 0}});g={area:function(n,t){u("corechart",function(){var i=f(n,t),r=new google.visualization.AreaChart($(t).get(0));s(n,t,r,i)})},areastacked:function(n,t){u("corechart",function(){var i=f(n,t,{isStacked:!0}),r=new google.visualization.AreaChart($(t).get(0));s(n,t,r,i)})},bar:function(n,t){u("corechart",function(){var i=f(n,t),r=new google.visualization.BarChart($(t).get(0));s(n,t,r,i)})},barstacked:function(n,t){u("corechart",function(){var i=f(n,t,{isStacked:!0}),r=new google.visualization.BarChart($(t).get(0));s(n,t,r,i)})},column:function(n,t){u("corechart",function(){var i=f(n,t),r=new google.visualization.ColumnChart($(t).get(0));s(n,t,r,i)})},columnstacked:function(n,t){u("corechart",function(){var i=f(n,t,{isStacked:!0}),r=new google.visualization.ColumnChart($(t).get(0));s(n,t,r,i)})},candlestick:function(n,t){u("corechart",function(){var i=f(n,t),r=new google.visualization.CandlestickChart($(t).get(0));s(n,t,r,i)})},donut:function(n,t){u("corechart",function(){var i=f(n,t,{pieHole:.4,backgroundColor:"transparent"}),r=new google.visualization.PieChart($(t).get(0));s(n,t,r,i)})},geo:function(n,t){u("geochart",function(){var i=f(n,t,{backgroundColor:"transparent"}),r=new google.visualization.GeoChart($(t).get(0));s(n,t,r,i)})},map:function(n,t){u("map",function(){var i=f(n,t,{showTip:!0}),r=new google.visualization.Map($(t).get(0));s(n,t,r,i)})},line:function(n,t){u("corechart",function(){var i=f(n,t,{showTip:!0}),r=new google.visualization.LineChart($(t).get(0));s(n,t,r,i)})},pie:function(n,t){u("corechart",function(){var i=f(n,t,{title:n.Title,backgroundColor:"transparent"}),r=new google.visualization.PieChart($(t).get(0));s(n,t,r,i)})},pie3d:function(n,t){u("corechart",function(){var i=f(n,t,{backgroundColor:"transparent",is3D:!0}),r=new google.visualization.PieChart($(t).get(0));s(n,t,r,i)})},scatter:function(n,t){u("corechart",function(){var i=f(n,t),r=new google.visualization.ScatterChart($(t).get(0));s(n,t,r,i)})},table:function(n,t){u("table",function(){var i=f(n,t),r=new google.visualization.Table($(t).get(0));s(n,t,r,i)})}};n.presenter("register",{name:"Charts",icon:function(){return"chart"},text:function(){return h.Text},supports:function(n){var u=!1;if($(n._fields).each(function(){if(this.Tag&&this.Tag.indexOf("pivot")!=-1)return u=!0,!1}),u)n.AutoPivots=null;else{if(n.AutoPivots&&$.isEmptyObject(n.AutoPivots))return!0;n.AutoPivots={};var t=1,g=n._fields[0].Label,i=[],e=0,a=0,s=["pie3d","column","donut","bar"],r=[],f=0,v=0,h=["line","column","area"],y=0,c=["columnstacked-top5","area-top7","column-top5","barstacked-top5"],w=[],l=n.groupExpression(),b=!1,o=function(){return s[a++%s.length]},k=function(){return h[v++%h.length]},d=function(){return c[y++%c.length]};$(n._fields).each(function(){var u=this;n.AutoPivots[u.Name]=[];(u.ItemsDataController||u.AliasName)&&i.push(u.Name);u.Type=="DateTime"&&r.push(u.Name);u.DataFormatString=="c"&&w.push(u.Name);l&&l[0]==(u.AliasName||u.Name)&&n.AutoPivots[u.Name].push("pivot"+t+++"-row1-top10-sortdescbyvalue-"+(u.Type=="String"?"pie-other":"column"))});$(i).each(function(){if(t>9||!r[f])return!1;var u=this,o=r[f];n.AutoPivots[i[e++%i.length]].push("pivot"+t+"-col1-sortdescbyvalue-"+d());n.AutoPivots[r[f++%r.length]].push("pivot"+t+++"-row1-date-all-hideblank")});e=0;f=0;$(n._fields).each(function(){var u,r,f,s;if(t>9)return!1;if(u=this,r=u.Name,u.IsPrimaryKey)return!0;(u.ItemsDataController||u.AliasName)&&n.AutoPivots[r].push("pivot"+t+++"-row1-top10-other-sortdescbyvalue-"+o());switch(u.Type){case"Int16":case"Int32":case"Int64":case"Single":case"Double":case"Decimal":if(i.length!=0&&!(u.ItemsDataController||u.AliasName)){if(f="sum",s=o(),r.match(/salary/i))f="avg";else if(r.match(/total/i))f="sum";else if(u.DataFormatString=="{0:c}"||r.match(/price|discount/i))for(f="avg";p(s);)s=o();p(s)&&(f="sum");n.AutoPivots[r].push("pivot"+t+"-val1-"+f+"-"+s);n.AutoPivots[i[e++%i.length]].push("pivot"+t+++"-row1-top7-other-sortdescbyvalue")}break;case"DateTime":r.match(/birth|hire/i)?n.AutoPivots[r].push("pivot"+t+++"-row1-month-all-pie3d"):n.AutoPivots[r].push("pivot"+t+++"-row1-"+k()+"-date-all-hideblank");break;case"String":b||r.match(/country/i)&&n.AutoPivots[r].push("pivot"+t+++"-row1-geo")}});t>1&&(u=!0)}return u},show:function(r){function c(n){var t,i,r,e,o;v();t=a("app-listview app-grid").appendTo(f);n?(e=$('<li data-icon="filter" class="ui-last-child"><a href="#app-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(t).find("a"),o=String.format(h.DataWarning,__settings.maxPivotRowCount),e.attr("title",l.Filter).find("p").text(o)):(i=$('<li data-icon="refresh"><a href="#app-refresh" class="ui-btn ui-icon-refresh ui-btn-icon-left"><p/><\/a><\/li>').appendTo(t).find("a"),i.attr("title",Web.DataViewResources.Pager.Refresh).find("p").text(Web.DataViewResources.Data.NoRecords),u._filter&&u._filter.length&&!u.filterIsExternal()&&(r=$('<li data-icon="filter" class="ui-last-child"><a href="#app-clear-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(t).find("a"),r.attr("title",l.ClearFilter).find("p").text(l.ClearFilter)));t.listview()}function v(){f.find(".app-chart").each(function(){$(this).removeData()});f.empty()}function b(n){for(pivot in n)$(n[pivot].Data).each(function(){for(var t=this,n=0;n<t.length;)t[n]=y(t[n]),n++}),n[pivot].Title=y(n[pivot].Title),n[pivot].ChartData=JSON.parse(JSON.stringify(n[pivot].Data)),$(n[pivot].ChartData).each(function(){for(var i=this,t=this,n=0,n=0;n<t.length;n++)t[n]==null&&(t[n]=0)})}function y(n){if(!n||!isNaN(n)||isFinite(n))return n;var t=n.match(/\$(\S+)/g);return $(t).each(function(){var r=this.replace(/\d*/g,""),t=r.replace(/[$\d]*/g,""),i=h.ChartLabels[t];i?(t.match(/Quarter|Week/)&&(i=i.substring(0,1)),n=n.replace(r,i)):t=="CurrentViewLabel"&&(n=n.replace(r,u._view.Label));t=="Other"&&(n.isOther=!0)}),n}function p(){n.registerAPI("Charts",d)}function d(){var y,l,r,t,d,it=[],et=0,p=f.closest(".app-wrapper"),rt,a=0,tt=1,g,ot=f.find(".app-chart"),ut,ft,nt=!1,ht,b;ot.length>0&&(ht=p.scrollTop(),$(ot).each(function(){var n=$(this);if(n.position().top>0)return s[n.data("data-context").Id].lastScrollPosition=!0,!1}));v();$('<div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div>').appendTo(f);g=f.find(".app-chart");$(g[0]).offset().left<$(g[1]).offset().left&&tt++;$(g[1]).offset().left<$(g[2]).offset().left&&tt++;g.remove();f.empty();for(d in o)if(t=o[d],t.ChartType&&t.RecordCount!=0)nt||(t.Properties.medium||t.Properties.large?nt=!0:s&&(config=s[t.Id],config&&config.size&&config.size.match(/medium|large/)&&(nt=!0))),a++;else continue;a==1&&(nt=!0);for(d in o)(t=o[d],placeholder=i("app-chart").data("data-context",t),inner=e("app-chart-inner").appendTo(placeholder),moreBtn=$('<a class="ui-btn"><span class="app-btn-more">&nbsp;<\/span><\/a>').appendTo(placeholder).attr("title",h.More),t.ChartType&&t.RecordCount!=0)&&(placeholder.appendTo(f),y||(r=p.height(),rt=p.find(".app-presenter-instruction:visible"),rt.length&&(r-=rt.outerHeight()),r=Math.floor(r),y=inner.width(),l=tt==3?a<=3?Math.min(r,y*1.33):Math.min(y*.66,Math.max(r/3,y*.5))-1:tt==2?a<=4?Math.max(r/2,y*.5):y*.66:r*.66,nt&&a<=3&&(l=r*.5),l>r&&(l=y*.66,l>r&&(l=r)),l=Math.floor(l)),b=l,config=s[t.Id],config||(config=s[t.Id]={}),config.size||(t.Properties.small!=null?delete config.size:t.Properties.medium!=null?config.size="medium":t.Properties.large!=null&&(config.size="large")),config.size&&(config.size=="medium"?(a>2&&(b=l*2+1),placeholder.addClass("app-chart-medium")):config.size=="large"&&(b=r,placeholder.addClass("app-chart-large"))),a==1&&(placeholder.addClass("app-chart-large"),b=r),config.resized?(ut=placeholder,delete config.resized):config.lastScrollPosition&&(ft=placeholder,delete config.lastScrollPosition),config.ShowData||t.ChartType=="table"?t.ShowData=!0:t.ShowData&&(t.ShowData=!1),b<150&&(b=150),it.push(inner.height(b)));if(i("app-clear-fix").appendTo(f),setTimeout(function(){var n;for(d in o)if(t=o[d],t.ChartType&&t.RecordCount!=0){for(n in t.Formats){var f=t.Formats[n],i=n.match(/(\w+)(\d+)/),e=i[1],r=u.findField(e);r.AliasName&&(delete t.Formats[n],t.Formats[r.AliasName+i[2]]=f)}t.ShowData?k(t,$(it[et++])):w(t,it[et++])}},10),a==0&&c(!1),f.closest(".app-echo").length==0&&i("app-promo-filler").appendTo(f),u.viewProp("chartsConfig",s),n.resetPageHeight(),n.syncEmbeddedViews(p),n.pointer("mouse")&&p.trigger("scroll"),a>1&&(ut||ft)){var st=ut||ft,ct=st.outerHeight(),lt=(p.height()-ct)/2,at=st.offset().top-p.offset().top-lt;n.scroll(p,at)}}var u=t.find(r.id),f=r.container.find(".app-chart-list"),o=r.container.data("pivots"),s=u.viewProp("chartsConfig")||{};if(f.length==0&&(f=i("app-chart-list").appendTo(r.container)),(r.reset||o&&u.dataSignature()!=r.container.data("signature"))&&(o=null),u._totalRowCount>__settings.maxPivotRowCount){c(!0);return}o&&o.length!=0?p():(f.find(".app-chart-inner").children().hide(),t.execute({controller:u._controller,command:"Pivot",pivotDefinitions:u.AutoPivots,view:u._viewId,_filter:u.combinedFilter(),sort:"",tags:u.get_tags(),success:function(n){o=n.Pivots;b(o);r.container.data("signature",u.dataSignature());r.container.data("pivots",o);p()},error:function(n){t.alert(String.format("{0}\n{1}",n.get_message(),n.get_stackTrace()))}}))},hide:function(){},dispose:function(n){n.container.removeData("pivots signature");n.container.find("app-chart").each(function(){$(this).removeData()})}})})(),function(){function wt(n){return n&&typeof n!="string"&&!(isNaN(+n)||n<new Date(1753,0)||n>new Date(9999,0))}function vt(n){i("app-clear-fix").appendTo(n)}function vu(){if(!wr){var n=new Date;wr=setTimeout(function(){gr=setInterval(ft,6e4)},(60-n.getSeconds())*1e3)}}function ft(t,i,r){var y,f;if(t||!$(".app-calendar.app-has-time-prompt").length){var u=t||new Date,o=it(u),s=$(".app-calendar-time"),e,h=s.find("div.app-current-time"),p=ot-ot/25,w=u.getTime(),l=u.getMinutes(),b=new Date(u.getFullYear(),u.getMonth(),u.getDate()).getTime(),k=w-b,c=s.find("li span"),a=u.getMinutes(),v=15e3/ot;return i&&l!=0&&(o=":"+l),i?i=="week"?($(".app-calendar").addClass("app-has-time-prompt"),e=s.closest(".ui-page").find(".app-calendar-weekview .current-time-line")):e=$(".app-calendar-dayview .current-time-line"):e=$(".app-calendar-weekview .current-time-line, .app-calendar-dayview .current-time-line"),y=k/864e5,f=p*y,i=="find"?ft():h.first().css("top")!=f+"px"&&n.callInAnimationFrame(function(){o!=""&&(c.removeClass("time-hidden"),a<v?c.filter('span[data-cal-hour="'+u.getHours()+'"]').addClass("time-hidden"):a>60-v&&c.filter('span[data-cal-hour="'+(u.getHours()+1)+'"]').addClass("time-hidden"),h.text(o));h.css("top",f);e.css("top",f).data("date",u);r&&r(f)}),f}}function it(n,t,i){if(!n)return"";var r=n.getHours(),u=n.getMinutes(),h=n.getSeconds(),o=f.PMDesignator,s=f.AMDesignator,e=r<12?i?"":s:i?o.substring(0,1):o;return r>12&&(s||o)&&(r=r-12),t&&r<10&&r!=0&&(r="0"+r),r==0&&(r=o||s?12:0),u<10&&(u="0"+u),!i&&e&&(e=" "+e),i&&u=="00"?String.format("{0}{1}",r,e):String.format("{0}:{1}{2}",r,u,e)}function nr(t,i,r){for(var f=n.settings("calendar.drag.precision")||15,e=f/60,o=e/2,s=60/f,u=0;u<s;u++)if(r<e*(u+1)-o)return t.setHours(i,f*u);return t.setHours(i,60)}function yt(n){return n.getDate()==at.getDate()&&n.getMonth()==su&&n.getFullYear()==ou}function tr(n,t){return n.getDate()==t.getDate()&&n.getMonth()==t.getMonth()&&n.getFullYear()==t.getFullYear()}function bt(n){var t;return n.each(function(){return t=$(this),firstLeft=t.position().left,firstLeft>0||firstLeft*-1<t.width()/2?!1:void 0}),t}function ri(n,t,i,r,u){var f=n.convertFieldValueToString(t,r),e=u&&n.convertFieldValueToString(t,u),o;if(o=r==null?String.format("{0}:<{1}",t.Name,e):u==null?String.format("{0}:>={1}",t.Name,f):String.format("{0}:$between${1}$and${2}",t.Name,f,e),r&&isNaN(r.getTime())||u&&isNaN(u.getTime()))return console&&console.log&&console.log("Error forming date filter: Date is NaN"),[];var h=t.Name,s=i?i.Name:"",c=n.get_filter().filter(function(n){return n.indexOf(h)!==0&&(!s||n.indexOf(s)!==0)});return newFilter=n._combinedFilter([o].concat(c))}function d(n){var r=n.attr("data-cal-year"),t=n.attr("data-cal-month"),i=n.attr("data-cal-day");return new Date(r,t?t:0,i?i:1)}function ui(n,t){var i=n.attr("data-cal-h"),r=n.attr("data-cal-m"),u=n.attr("data-cal-s"),f=n.attr("data-cal-ms");t.setHours(i,r,u,f)}function ci(n,t){n.attr("data-cal-h",t.getHours()).attr("data-cal-m",t.getMinutes()).attr("data-cal-s",t.getSeconds()).attr("data-cal-ms",t.getMilliseconds())}function ct(n,t){n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",t.getDate())}function yu(n){var t={hour:n.getHours(),minute:n.getMinutes(),ampm:""},i=!!f.AMDesignator.length;return i&&(t.ampm=t.hour>=12?f.PMDesignator:f.AMDesignator,t.hour>12&&(t.hour-=12),t.hour==0&&(t.hour=12)),t.hour=t.hour<10?" "+t.hour:t.hour.toString(),t.minute=t.minute<10?"0"+t.minute:t.minute.toString(),t}function iu(n,t,i){var e="",r=new Date(n,t,1),o=rt[r.getDay()],s=new Date(n,t+1,1),c=rt[s.getDay()],u="",h=0,l=0,f;for(c!=0&&s.setDate(s.getDate()+(6-c)+1),o!=0&&r.setDate(r.getDate()-o);l<42;)if(o=rt[r.getDay()],o==0&&(u&&(e+=u+"<\/tr>"),h++,u="<tr>"),u+="<td",f=r.getMonth(),f==t||i?(i&&f!=t?u+=t==11&&f==0||!(t==0&&f==11||f<t)?' class="app-next-month"':' class="app-prev-month"':ni.setHours(0,0,0,0)==r.setHours(0,0,0,0)&&(u+=' class="app-current-day"'),i&&(u+=String.format(' data-cal-year="{0}" data-cal-month="{1}" data-cal-day="{2}"',r.getFullYear(),r.getMonth(),r.getDate())),u+=String.format(">{0}",r.getDate())):u+=">&nbsp;",u+="<\/td>",r.setDate(r.getDate()+1),l++,!i&&r>=s)break;for(e+=u;h<6;)h++,e+="<tr><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><\/tr>";return e+""}function kt(n,t){c(".app-tabs .ui-btn").each(function(){var n=$(this);if(n.attr("data-text")==t.text())return n.trigger("vclick"),!1})}function dt(n,t){var r=n.find(".app-tabs a"),i;return r.each(function(){var n=$(this);if(n.attr("data-text")==t)return i=n,!1}),i}function rr(n){var s=n.get_hasParent(),h=n.get_filterFields(),o=[],i=[],r,u,f,e,t;return $(n._allFields).each(function(){var n=this,l,v;if(n.Tag)for(l=n.Tag.split(" "),v=l.length,t=0;t<v;t++){if(match=vr.exec(l[t]),match!=null){var y=match[1]?parseInt(match[1]):0,a=match[2],p=match[4],c=i[y];if(a=="disabled")break;c||(i[y]=c={});switch(a){case"date":c.date=n;break;default:c[a]=p||n}}vr.lastIndex=0}if((n.ItemsDataController||n.AliasName)&&n.ItemsStyle!="CheckBoxList"&&(s&&n.Name==h||(u?f||(f=n):u=n)),r||n.Type!="String"||(r=n),(n.Type=="DateTime"||n.Type=="Date")&&!n.tagged("calendar-disabled")){for(e||(e=n),t=0;o[t];)t++;o[t]={date:n,name:n.Label}}}),$.isEmptyObject(i)&&(i=o),$(i).each(function(){var t=this,i;!t.text&&r&&(t.text=r);!t.date&&e&&(t.date=e);t.name||(t.name=t.date.Label);u&&!t.color&&(t.color=r&&f&&r==u?f:u);i=t.color?n.viewProp("calendarColorMap-"+t.color.Name):null;t.colorMap=new ar(n,t,i)}),i}function pt(t,i){var u=v(),r=u&&u.calendar;if(r){t||(t=r.scrollable());var f=t.find('.app-presenter[data-presenter="calendar"]'),e=f.data("cal-header"),s=r.viewClassName(),o=f.find(s);i&&(r.preventNavigate=!0,r.getViewHandler().resize(o,e,null,!0));ei&&ei();r.updateHeader(e);r.loadData(o);g("refresh",{container:n.sidebar().find(".app-calendar-plugin")})}}function ru(t){var i=t&&t.get_viewType(t._id),r=n.sidebar();if(!t||i!="Grid"&&!$(".app-reading-pane-detail:not(.app-hidden)").length){eu(r);return}if(fu(t))i&&i=="Grid"&&(t.calendar&&t.calendar.loadData(t.calendar.getVisibleView()),t.calendarPlugin&&(__settings.bars.left.mini||n.pageInfo(t).page.is(".app-page-modal")?eu(r):t.calendarPlugin.attach(r)));else return}function uu(n,t){return(t-n)/36e5*(ot/25)}function fu(t){if(t.calendar)return!0;if(t._keyFields.length>1)return!1;var i=rr(t),r=n.sidebar();return $.isEmptyObject(i)?!1:(t.calendar=new fr(t,i),t.calendarPlugin||(t.calendarPlugin=new lr(t,i)),!0)}function ai(n,t,i,r){n.css({transform:"",opacity:1}).addClass("app-scale");setTimeout(function(){function u(){return clearTimeout(f),n.hide(),i&&i(),t.removeClass("app-scale").show().css({transform:"scale(0.75)",opacity:0}),setTimeout(function(){function n(){t.removeClass("app-scale");r&&r()}f=setTimeout(function(){t.off("transitionend",n)},500);t.addClass("app-scale").one("transitionend",n).css({transform:"scale(1)",opacity:1})}),!1}var f=setTimeout(function(){n.off("transitionend",u);u()},500);n.one("transitionend",u).css({transform:"scale(0.75)",opacity:0})})}function lt(n,t){return n.find(String.format('td[data-cal-month="{0}"][data-cal-day="{1}"]:not(.app-day-hidden)',t.getMonth(),t.getDate()))}function vi(n,t){return n.find(String.format('.app-scroll-column > div[data-cal-year="{0}"][data-cal-month="{1}"]',t.getFullYear(),t.getMonth()))}function pu(n,t){var i={NewValue:t};return n._dataView._validateFieldValueFormat(n,i,!0),i.NewValue}function eu(t){t||(t=n.sidebar());t.find(".app-calendar-plugin").addClass("app-hide-request")}for(var ir,li,ur,fr,er,or,sr,hr,cr,tt,g,lr,ar,ut=Web.DataViewResources,yi=ut.Pager,et=ut.HeaderFilter,nt=ut.Presenters.Calendar,gt=ut.Mobile,f=Sys.CultureInfo.CurrentCulture.dateTimeFormat,at=new Date,ni=new Date(at.getFullYear(),at.getMonth(),at.getDate()),ou=at.getFullYear(),su=at.getMonth(),vr=/calendar(\d+)?-([a-zA-Z]+)(:['"]?([a-zA-Z]+)['"]?)?(\d+)?/g,hu=/^(\d+), (\d+), (\d+)(, (.*))?$/,fi,yr,ei,pi,wi,oi,pr,wr,bi,br,kr,dr,gr,si=500,ki=100,ti=66,di=0,ot=1060,ht={year:2,month:2,week:7,day:1,agenda:1},gi={year:5,month:5,week:21,day:2,agenda:90},cu=30,hi=30,lu=23,nu=5,rt=[],ii=[],tu='<a class="ui-btn app-month-picker" title="{0}, {1}">{2}, {3}<\/a>',au='+{0} <span class="app-month-more">'+gt.More.toLowerCase()+"<\/span>",st=0;st<7;st++)rt[st]=(7+st-f.FirstDayOfWeek)%7,ii[st]=(st+f.FirstDayOfWeek)%7;ir=function(n){this.calendar=n;this.data={day:{},month:{},year:{},agenda:{}}};ir.prototype={select:function(n){var t=this.calendar.mode,u=new Date(n),i,r;if(t=="week")t="day";else if(t=="agenda")return this.data[t][n];return(r=this.data[t][u.getFullYear()],!r)?null:t=="year"?r:(i=r[u.getMonth()],!i)?null:t=="month"?i:i[u.getDate()]},insert:function(n,t){var a=new Date(n),v=this.dataView,y=this.calendar.activeCalendar.date,i=this.calendar.mode,l=i=="week"?7:1,f,c,h,o,e,r,u,s;if(i=="week")i="day";else if(i=="agenda"){n<0&&t.reverse();this.data[i][n]=t;return}switch(i){case"year":this.data[i][n.getFullYear()]={};break;case"month":r=this.data[i][n.getFullYear()];r||(r=this.data[i][n.getFullYear()]={});r[n.getMonth()]={};break;case"day":for(f=new Date(n),st=0;st<l;st++)r=this.data[i][f.getFullYear()],r||(r=this.data[i][f.getFullYear()]={}),u=r[f.getMonth()],u||(u=r[f.getMonth()]={}),u[f.getDate()]={rows:[],count:0},f.setDate(f.getDate()+1)}for(c in t)(h=t[c],o=hu.exec(h[0]),o)&&(e=new Date(o[1],parseInt(o[2])-1,o[3]||o[2]),r=this.data[i][e.getFullYear()],r||(r=this.data[i][e.getFullYear()]={}),u=r[e.getMonth()],u||(u=r[e.getMonth()]={}),s=u[e.getDate()],s||(s=u[e.getDate()]={rows:[],count:0}),i=="year"?s.count=h[1]:($(h[1]).each(function(){this.length==5&&s.rows.push(this)}),s.count+=h[2]))},clear:function(){this.data={day:{},month:{},year:{},agenda:{}}},clearAgenda:function(){this.data.agenda={}}};$(document).on("scrollstart.app",function(n){n.namespace=="app"&&(fi=!0)}).on("scroll.app scrollstop.app resized.app",function(n){var f;if(n.namespace=="app"){fi=!1;var e=$(n.relatedTarget),i=n.type=="resized",t=i?v():w(e.closest(".ui-page").attr("id")),r=t&&t.calendar,u,o=t&&t.extension().viewStyle(),s=p(e);t&&o=="calendar"&&r&&(f=r.mode.match(/day|week/),i&&(u=r.getVisibleView(),f&&u&&u.removeClass("app-has-current-day")),clearTimeout(yr),yr=setTimeout(function(){fi||!i&&f||pt(null,i)},200))}}).on("more.app",function(n){var y=$(n.target),u=y.closest(".app-echo"),r=u.length?t.find(u.attr("data-for")):v(),f=p(),e=f.find(".app-calendar"),w=n.type=="more",b=n.type=="viewselector",o;if(r&&e.length&&e.is(":visible")&&(o=r.extension().viewStyle(),o=="calendar")){var k=r.viewProp("calendarConfig"),i=k.mode,d=f.parent().find(".app-bar-calendar .app-tabs"),s={text:nt.Day,icon:i=="day"?"check":!1,callback:kt},h={text:nt.Week,icon:i=="week"?"check":!1,callback:kt},c={text:nt.Month,icon:i=="month"?"check":!1,callback:kt},l={text:nt.Year,icon:i=="year"?"check":!1,callback:kt},a={text:nt.Agenda,icon:i=="agenda"?"check":!1,callback:kt};w&&n.panel[0].id=="app-panel-view-options"?n.items.splice(n.items.length,0,{},s,h,c,l,a):b&&d.css("visibility")=="hidden"&&n.items.splice(0,0,s,h,c,l,a,{})}}).on("vclick contextmenu",".app-calendar,.app-bar-calendar",function(i){var r=$(i.target),ci=r.closest(".app-event"),ri=i.type,wt=r.closest(".app-echo"),w=wt.length?t.find(wt.attr("data-for")):v(),u=w.calendar,l=b(w),lt=l.find('.app-presenter[data-presenter="calendar"]'),o=r.closest(".ui-btn"),bt=r.parent(),ui=r.attr("data-cal-hour"),fi=n.lastTouch(),ei,st,ni,e,vi,ti,g,it,p,tt,ki,ct;if(ci.length&&(r=ci),w&&w.calendar){if(ri==="contextmenu"&&r.closest(".ui-page").is(".app-reading-pane-master")&&!c().is(".app-reading-pane-master"))return n.invokeInTargetPage(function(){r.trigger("contextmenu")}),!1;if(isLookup=w._lookupInfo,!(r.closest(".app-tabs ul").length>0)){if(o.length||(o=r.find(".ui-btn")),r.is("ul")&&!!bt.attr("data-cal-day"))r=bt;else if(bt.is(".app-event"))r=bt;else if(r.is(".app-tabs"))return!1;if(ri=="contextmenu"&&!r.is("td,.app-event")&&ui==null)return!1;if(ei=r.data("data-context"),r.is(".dv-load-at-top, .dv-load-at-bottom, .app-btn-next, .app-btn-prev")){var k=u.getBlocks(l),h,g,gt=wt.length?0:gi[u.mode],s=u.views[u.mode];if(r.is(".dv-load-at-top, .app-btn-prev")){k.length>gt&&(u.mode=="agenda"?s.removeData(l.find(".app-calendar-agendaview"),s.maxPage):k.slice(gt).remove());var ut=k.first(),a,oi=0,g=Number(ut.data("cal-year")),tt=ut.data("cal-month")!=null?Number(ut.data("cal-month")):1,di=l.scrollTop(),li=r.outerHeight(!0)-l.find(".app-presenter-instruction").outerHeight(!0),ai=[];for(h=d(ut),st=0;st<ht[u.mode];st++){switch(u.mode){case"month":h.setMonth(h.getMonth()-1,1);a=s.drawMonth(h);break;case"year":h.setFullYear(g-1);g=h.getFullYear();a=s.drawYear(h);li+=-6;break;case"agenda":r.text(et.Loading);s.loadData(l.find(".app-calendar-agendaview"),null,s.minPage-1)}a&&(a.insertBefore(ut),ut=a,ai.push(a))}s.resize(u.getVisibleView());$(ai).each(function(){oi+=$(this).outerHeight(!0)});oi&&n.scroll(l,Math.ceil(di+oi+li))}else{var at=k.last(),a,g=Number(at.data("cal-year")),tt=at.data("cal-month")!=null?Number(at.data("cal-month")):1,h=new Date(g,tt,1);for(k.length>gt&&(u.mode=="agenda"?s.removeData(l.find(".app-calendar-agendaview"),s.minPage):(k.slice(0,k.length-gt).remove(),ni=0,k.each(function(){ni+=$(this).height()}),n.scroll(l,ni-1))),st=0;st<ht[u.mode];st++){switch(u.mode){case"month":h.setMonth(h.getMonth()+1,1);a=s.drawMonth(h);break;case"year":h.setFullYear(g+1);g=h.getFullYear();a=s.drawYear(h);break;case"agenda":r.text(et.Loading);s.loadData(l.find(".app-calendar-agendaview"),null,s.maxPage+1)}a&&(a.insertAfter(at),at=a)}s.resize(u.getVisibleView())}return!1}if(ei)return u.selectEvent(ei,r,i),!1;if(r.is(".app-event-more")){if(!u.hasKeyFields())return!1;e=d(r.closest(".app-calendar-day"));vi=r.data("data-more-context");u.showEventList(e,vi,r,i)}else if(r.closest(".app-calendar-month-more").length){if(!u.hasKeyFields())return!1;var yi=r.closest(".app-calendar-month-more"),vt=r.closest("td"),tr=vt.find(".app-event"),pi=[],tt=r.closest(".app-calendar-month"),y=vt.attr("data-cal-day"),si=d(tt);si.setDate(y);tr.each(function(){var n=$(this),t=n.data("data-context");pi.push(t[0])});function wi(n){n=n.filter(function(n){return pi.indexOf(n[0])==-1});u.showEventList(si,n,r,i)}yi.addClass("ui-btn-active");n.callWithFeedback(vt,function(){yi.removeClass("ui-btn-active");var n=vt.data("data-more-context");n?wi(n):u.requestData({mode:"daylist",date:si,success:function(t){t.Pivots.pivot0&&t.Pivots.pivot0.Data[1]&&(n=t.Pivots.pivot0.Data[1][1],vt.data("data-more-context",n),wi(n))}})})}else{if(r.closest(".app-day-header").length)return r.is("ul")?void 0:(ti=lt.find(".app-calendar-dayview"),it=o.closest(".app-day-header"),n.callWithFeedback(o,function(){var i=o.closest("li"),n=d(i),f=n.getFullYear(),e=n.getMonth(),s=n.getDate(),t=u.getBlockByDate(ti,n,"day"),r=parseInt(ti.css("marginLeft"),10)-t.position().left;t.length&&u.views.day._scroll(ti,it,r*-1,null,!0)}),!1);if(r.closest(".app-week-header").length)return r.is("ul")?void 0:(n.callWithFeedback(o,function(){var n=dt(r.closest(".app-bar-calendar"),nt.Day),t=d(o.closest("li"));u.navigateDate=t;n&&n.trigger("vclick")}),!1);if(r.is(".ui-btn")||r.closest(".ui-btn").length){if(o.is(".app-calendar-today,.app-calendar-next,.app-calendar-prev"))return n.callWithFeedback(o,function(){if(l.length>0){var t=o.is(".app-calendar-next"),i=o.is(".app-calendar-prev"),n="today";t?n="next":i&&(n="prev");u.scrollView(n)}}),!1;if(o.is(".app-calendar-badge")){var yt=w.viewProp("calendarConfig"),ir=yt.mode,rr=l.parent().find(".app-bar-calendar .app-tabs");rr.css("visibility")=="hidden"?n.callWithFeedback(o,function(){n.listPopup({anchor:o,iconPos:"left",items:u.getSupportedViews(w).map(function(n){return{text:n.text,icon:ir==n.value?"check":!1,callback:kt}})})}):n.callWithFeedback(o,function(){n.listPopup({anchor:o,items:[{text:o.attr("data-cal-value"),callback:function(){}}]})})}else if(o.is(".app-calendar-month-header")){e=null;it=lt.data("cal-header");p=dt(it,nt.Month);switch(u.mode){case"year":g=r.closest(".app-calendar-year").attr("data-cal-year");tt=r.closest(".app-calendar-month").attr("data-cal-month");e=new Date(g,tt);break;case"agenda":e=d(o)}if(e)return u.navigateDate=e,n.callWithFeedback(o,function(){p&&p.trigger("vclick")}),!1}else if(o.parent().attr("data-cal-day")||r.is("h2")){if(u.mode=="month"){if(r.is("td"))return;var it=lt.data("cal-header"),tt=r.closest(".app-calendar-month"),p=dt(it,nt.Day);return e=d(tt),e.setDate(o.parent().attr("data-cal-day")),u.navigateDate=e,n.callWithFeedback(o,function(){p&&p.trigger("vclick")}),!1}u.mode!="agenda"||wt.length||(e=d(r.closest("li")),e&&(it=lt.data("cal-header"),p=dt(it,nt.Day),u.navigateDate=e,n.callWithFeedback(o,function(){p&&p.trigger("vclick")})))}}else if(r.is("td")||r.is("div")&&ui!=null){if(u.mode=="year"){if(r.height()<20&&n.pointer("mouse"))r.closest(".app-calendar-month").find(".app-calendar-month-header").trigger("vclick");else{if(y=parseInt(r.text(),10),!y)return;var g=r.closest(".app-calendar-year").attr("data-cal-year"),tt=r.closest(".app-calendar-month").attr("data-cal-month"),it=lt.data("cal-header"),p=dt(it,nt.Day);u.navigateDate=new Date(g,tt,y);r.addClass("ui-btn-active");n.callWithFeedback(r,function(){p&&p.trigger("vclick");r.removeClass("ui-btn-active")})}return!1}yt=u.activeCalendar;e=null;var fi=n.lastTouch(),hi=u.getActionsByName("New"),rt,ii=!!yt.end,bi=u.mode=="month",pt;if(!hi.length)return!1;if(bi){if(y=r.attr("data-cal-day"),tt=r.closest("div.app-calendar-month"),!y)return!1;e=d(tt);e.setDate(y);ii&&(rt=new Date(e),rt.setMinutes(rt.getMinutes()+60))}else{y=r.closest("div.app-calendar-day");var ur=y.find(".app-calendar-eventlist"),fr=fi.y-r.offset().top,ni=r.height(),er=fr/ni;e=d(y);nr(e,ui,er);ii&&(rt=new Date(e),rt.setMinutes(rt.getMinutes()+60));pt=u.drawEvent([null,e,rt,null," "],null).removeClass("app-event-color-0").addClass("app-event-new");ii&&pt.height(ot/25);ki=ft(e,"find");pt.css("top",ki+22).appendTo(ur)}return e?(hi.forEach(function(n){var i=n.callback,r={action:{action:n,argument:n.argument,dataViewId:w._id,row:null}};n.CommandName=n.command;n.callback=function(){t.newValues=[{name:yt.date.Name,value:e}];ii&&t.newValues.push({name:yt.end.Name,value:rt});i(r)}}),ct={iconPos:"left",items:hi,title:String.localeFormat("{0:"+f.LongDatePattern+"} {0:"+f.ShortTimePattern+"}",e),afterclose:function(){pt&&pt.remove()}},bi?ct.anchor=r:(ct.x=fi.x,ct.y=fi.y,ct.arrow="b,t,l,r"),n.listPopup(ct),!1):void 0}}if(ri==="contextmenu")return!1}}}).on("clear.dataview.app",function(n){var t=n.dataView,i=t.calendar;i&&$("#"+t._id).find(".app-calendar-selected").removeClass("app-calendar-selected")}).on("reset.dataview.app",function(t){var i=t.dataView,r,u,f,e;if(i&&(r=i.calendar,u=i.calendarPlugin,r&&(r.clear(),r.activeCalendar.colorMap.clearFilter()),u)){if(f=i&&i.get_viewType(i._id),e=i.get_master(),e&&!i.get_selectedKey().length)return;f&&f=="Grid"&&(u.filtering||(u.clearCache(),n.stickyHeaderBar().hide()))}}).on("pageready.app",function(n){ru(n.dataView)}).on("sidebarstatechanged.app",function(){var i=n.contextDataView();i&&($("#"+i._id).is(".app-reading-pane-detail")&&(i=t.find(i._parentDataViewId)),ru(i))});li={options:{dataView:!0},start:function(n){var t,i;if(n.dir="horizontal",t=n.dataView.calendar,i=t.getViewHandler(),this._calendar=t,this._handler=i,i._scroll){var r=t.getVisibleView(),u=r.closest(".app-presenter"),f=u.data("cal-header").find(".app-"+t.mode+"-header");this._calView=r;this._calHeader=f;this._startMarginLeft=parseInt(r.css("margin-left"),10)}this._startX=n.x;this.scrollingAnimationFrame=null},move:function(n){var t=this;if(t._startMarginLeft!=null){var u=n.target,i=n.x-t._startX,r=t._startMarginLeft+i;t.scrollingAnimationCallback=function(){t._handler._scroll(t._calView,t._calHeader,-r,null);t.scrollingAnimationCallback!=null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))};t.scrollingAnimationFrame==null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))}},end:function(){this.scrollingAnimationCallback=null},taphold:function(n){var t=$(document.elementFromPoint(n.x,n.y));t.trigger("contextmenu")},cancel:function(){this.scrollingAnimationCallback=null}};t.dragMan.calendar=li;t.dragMan["calendar-bar-week"]=li;t.dragMan["calendar-bar-day"]=li;ur={options:{dataView:!0},start:function(t){var s;t.dir="all";var h=t.dataView,r=t.target,u=h.calendar,c=u.scrollable(),i=r.closest(".app-event"),l=r.is(".app-event-handle"),f=i.data("data-context"),o=i.position();f&&(this._element=i,this._oldHeight=i.height(!0),this._oldTop=o.top,this._context=f,this._startX=t.x,this._startY=t.y,this._mode="move",this._hasMoved=!1,this._hasScrolled=!1,u.mode.match(/day|week/)?(s=c.find(".app-presenter-instruction"),this._diffY=s.height()-o.top,l&&(this._mode="resize",this._diffY-=r.position().top)):this._placeholder=e("",'style="display:none"').insertAfter(i));n.stickyHeaderBar().hide().addClass("app-disabled")},move:function(t){var nt=this,tt=t.dataView,f=tt&&tt.calendar,dt=t.target,e=$(t.dropTarget),gt=this._context[1],i=f.scrollable(),o=this._element,h,et,ct,p,k,v,g;this._hasMoved||(this._hasMoved=!0,this._element.addClass("app-event-preview"));switch(f.mode){case"day":case"week":if(e=e.closest(".app-calendar-day,.current-time-line"),e.length){canDrag=!0;var r=e.is(".current-time-line")?e.data("date"):d(e),at=t.y-this._startY-this._diffY,vt=ot/25,s=at/vt,rt=i.offset();if(!wi){var y=t.x-rt.left-60,ut=i.width()-y-60,yt=y<30||ut<30;y<30?f.scrollView("prev"):ut<30&&f.scrollView("next");yt&&(this._hasScrolled=!0,wi=setTimeout(function(){wi=null},1e3))}if(pi||(pi=setTimeout(function(){pi=null;var f=i.scrollTop(),u=t.y-rt.top,e=i.height()-u,r;if(u<20){if(r=20-u,f<r)return;nt._diffY+=r;n.scroll(i,i.scrollTop()-r)}else if(e<20){if(r=20+e,f>=i[0].scrollHeight-i.height()-r)return;nt._diffY-=r;n.scroll(i,i.scrollTop()+r)}},20)),s>23.75?s=23.75:s<0&&(s=0),h=Math.floor(s),et=s-h,h!=null&&(nr(r,h,et),!this._previewDate||r.getTime()!=this._previewDate.getTime())){var pt=f.mode=="week"?"week":"find",wt=ft(r,pt)+22,bt=f.getVisibleView(i),st=f.getBlockByDate(bt,r);if(st.length){var u=this._context[1],ht=this._context[2],c=new Date(u),l,a;c.setMinutes(c.getMinutes()+30);this._mode=="resize"?(r.setFullYear(u.getFullYear(),u.getMonth(),u.getDate()),r<c&&(r=c),l=it(u,!1)+" - "+it(r,!1),a=it(u,!1)+" - "+it(r,!1),o.css("height",uu(u.getTime(),r.getTime()))):(l=it(r,!1,!0),a=it(r),ht&&(ct=ht.getTime()-u.getTime(),p=new Date(r.getTime()+ct),l+=" - "+it(p,!1),a+=" - "+it(p,!1)),o.css("top",wt),o.appendTo(st.find(".app-calendar-eventlist")));o.find(".app-event-time").text(l);o.find(".app-event-time-long").text(a);this._previewDate=r}}}break;case"month":var w=e.closest("td"),kt=w.closest(".app-calendar-month"),b=d(kt),lt=w.attr("data-cal-day");lt&&(b.setDate(lt),k=w.find("ul"),k.length&&(!this._previewDate||b.getTime()!=this._previewDate.getTime())&&(this._previewDate=b,o.appendTo(k)));v=t.y-i.position().top;g=i.height()-v;bi||(bi=setTimeout(function(){bi=null;var t=i.scrollTop();n.desktop()&&(v<20?n.scroll(i,i.scrollTop()-(20-v)):g<20&&n.scroll(i,i.scrollTop()+(20+g)))},20));break;case"year":case"agenda":return}},end:function(n){var tt=n.target,f=n.dataView,o=f&&f.calendar,it=o.scrollable(),y,k,c,p,l,g,u,nt;if(f._keyFields.length){var b=o&&o.activeCalendar,a=this._context,r=a[1],i,v=a[2],e,s=$(n.dropTarget);switch(o.mode){case"day":case"week":if(s=s.closest(".app-calendar-day,.current-time-line"),s.length){i=s.is(".current-time-line")?s.data("date"):d(s);var rt=n.y-this._startY-this._diffY,ut=ot/25,h=rt/ut;h>23.75?h=23.75:h<0&&(h=0);y=Math.floor(h);k=h-y;nr(i,y,k);this._mode=="resize"&&(i.setFullYear(r.getFullYear(),r.getMonth(),r.getDate()),e=i,i=r,c=new Date(r),c.setMinutes(c.getMinutes()+30),e<c&&(e=c))}break;case"month":p=$(n.dropTarget).closest("td");l=p.closest(".app-calendar-month");l.length&&(i=new Date(r),i.setYear(l.attr("data-cal-year")),i.setMonth(l.attr("data-cal-month")),i.setDate(p.attr("data-cal-day")),i.getDate()==r.getDate()&&i.getMonth()==r.getMonth()&&(i=null));this._placeholder.remove();break;case"year":case"agenda":return}i&&(g=f._keyFields[0].Name,u=[{field:g,value:a[0]},{field:b.date.Name,oldValue:r,newValue:i}],(v||e)&&(e||(nt=v.getTime()-r.getTime(),e=new Date(i.getTime()+nt)),u.push({field:b.end.Name,oldValue:v,newValue:e})),o.preventNavigate=!0,t.execute({command:"Update",controller:f._controller,view:f._viewId,values:u,success:function(n){n.errors.length>0&&t.alert(n.errors[0]);o.lastScrollTop=it.scrollTop();var e=$(".app-reading-pane-detail:not(.app-hidden)"),c=e.attr("id"),l=[],a,r,s,h,i;if(e.length&&tt.closest(".app-reading-pane-master").length&&(r=w(c),a=r.data(),a[u[0].field]===u[0].value)){for(i=1;i<u.length;i++)l.push({name:u[i].field,value:u[i].newValue});if(t.input.execute({dataView:r,container:e.find('[data-input-container="'+c+'"]'),values:l}),r.editing())for(i=1;i<u.length;i++)s=u[i],h=r.findField(s.field),h&&(r._unchangedRow[h.Index]=s.newValue)}f.sync()},error:function(n){t.alert(String.format("{0}",n.get_message()))}}));$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(ft,ki*2)}},cancel:function(t){var e=t.target,i=this._element,r=t.dataView.calendar,u,f;(this._hasMoved&&i.removeClass("app-event-preview"),r.mode!="month"&&Math.abs(t.x-this._startX)<5)||(r.mode.match(/day|week/)?(u=r.getBlockByDate(r.getVisibleView(),this._context[1]),u.length?i.appendTo(u.find("ul")):i.remove()):(this._hasMoved&&i.insertAfter(this._placeholder),this._placeholder.remove()),$(".app-calendar").removeClass("app-has-time-prompt"),setTimeout(ft,ki*2),f=this._oldHeight,i.css({height:f,top:this._oldTop}),n.stickyHeaderBar().removeClass("app-disabled"),r.preventNavigate=!0)},taphold:function(n){var t=$(document.elementFromPoint(n.x,n.y));t.trigger("contextmenu")}};t.dragMan["calendar-event"]=ur;t.dragMan["calendar-event-handle"]=ur;fr=function(n,t){var i=this,r=n.viewProp("calendarConfig")||{};i.dataView=n;r.mode||(r.mode=n.tagged("calendar-day")?"day":n.tagged("calendar-week")?"week":n.tagged("calendar-month")?"month":n.tagged("calendar-year")?"year":n.tagged("calendar-agenda")?"agenda":$(document).width()<768?"day":"week");i.mode=r.mode;i.calendars=t;r.activeCalendar&&$(t).each(function(){if(this.name==r.activeCalendar)return i.activeCalendar=this,!1});i.activeCalendar||(i.activeCalendar=t[Object.keys(t)[0]]);i.cache=new ir(i);i.views={day:new er(i),week:new or(i),month:new sr(i),year:new hr(i),agenda:new cr(i)};n.viewProp("calendarConfig",r)};fr.prototype={scrollable:function(){var t=this,n=t._scrollable;return n||(n=t._scrollable=$("#"+this.dataView._id+" .app-wrapper")),n},viewClassName:function(){return String.format(".app-calendar-{0}view",this.mode)},getSupportedViews:function(n){var t=[];return n.tagged("calendar-day-disabled")||t.push({value:"day",text:nt.Day}),n.tagged("calendar-week-disabled")||t.push({value:"week",text:nt.Week}),n.tagged("calendar-month-disabled")||t.push({value:"month",text:nt.Month}),n.tagged("calendar-year-disabled")||t.push({value:"year",text:nt.Year}),n.tagged("calendar-agenda-disabled")||t.push({value:"agenda",text:nt.Agenda}),t},show:function(t){var r=this,h=this.dataView,o=t.container,s=o.closest(".app-echo").length>0,c=o.find(".app-calendar"),l=o.closest(".app-wrapper"),k=this.calendars,y=h.viewProp("calendarConfig"),tt=this.activeCalendar.colorMap,e,a,p,w,f,v,b;if(!$.isEmptyObject(k)){if(!s&&this.lastScrollTop&&l.scrollTop()==0&&n.scroll(l,this.lastScrollTop),s?(this.mode=y.mode="agenda",this.echoMaxHeight=t.maxHeight,h.viewProp("calendarConfig",y)):y.mode&&(this.mode=y.mode),p=this.getViewHandler(),this.navigateDate||this.preventNavigate||(w=h.extension().commandRow(),w&&this.activeCalendar.date&&(this.enhancePrecision=!0,this.navigateDate=w[this.activeCalendar.date.Index]),this.navigateDate||(this.navigateDate=new Date)),c.length>0){if(f=o.find(".app-calendar > div:visible"),!s)if(e=o.data("cal-header"),p.showHeaderAndFooter(e,null),n.bar("show",e),tt.show(),f.is(r.viewClassName())){if(this.navigateDate&&!this.preventNavigate){if(a=this.getBlockByDate(f,this.navigateDate),a&&a.length&&!s){this.scroll({view:f,enhancePrecision:!0});return}this.animate=!1}}else f.hide()}else c=i("app-calendar",'data-draggable="calendar"').appendTo(o),s||(e=i("app-bar-calendar").appendTo(n.bar("create",{type:"header",page:o})),v=i("app-calendar-controls").appendTo(e),b=i("app-tabs").appendTo(v),i("app-calendar-badge ui-btn").appendTo(v),n.tabs("create",{container:b,tabs:r.getSupportedViews(h).map(function(n){return{text:n.text,value:n.value,active:n.value==r.mode}}),change:function(i){var f=r.mode,c=r.getMostVisibleBlock(l,f),u=c&&d(c),o=!1,a=h.viewProp("calendarConfig"),v=h.calendarPlugin;if(a.mode=i.value,h.viewProp("calendarConfig",a),!r.navigateDate){if(r.lastDate)switch(f){case"year":r.lastDate.getFullYear()==u.getFullYear()&&(o=!0);break;case"month":r.lastDate.getFullYear()==u.getFullYear()&&r.lastDate.getMonth()==u.getMonth()&&(o=!0)}r.navigateDate=o?r.lastDate:u;r.enhancePrecision=!0}f.match(/week|day/)&&(r.lastDayScrollTop=l.scrollTop());t.container=t.container.closest(".app-wrapper");s||l.focus().find(".app-stub").addClass("app-hidden");r.navigateDate&&isNaN(r.navigateDate.getTime())&&(alert("navigate date is NaN"),r.navigateDate=new Date);n.presenter("show",t);r.updateHeader(e);g("refresh",{container:n.sidebar().find(".app-calendar-plugin")});setTimeout(function(){n.fetchOnDemand();pt(l)},200)},restoreScrolling:!1,stickyHeader:!0}),o.data("cal-header",e),u("ui-btn ui-btn-icon-notext ui-icon-carat-l ui-corner-all app-calendar-prev").attr("title",yi.Previous).appendTo(v),u("ui-btn ui-btn-icon-notext ui-icon-carat-r ui-corner-all app-calendar-next").attr("title",yi.Next).appendTo(v),u("ui-btn ui-btn-icon-notext ui-icon-calendar ui-corner-all app-calendar-today").attr("title",nt.Today).appendTo(v),vu());this.activeCalendar.end?c.addClass("app-calendar-has-end-time"):c.removeClass("app-calendar-has-end-time");var it=String.format("app-calendar-{0}view",this.mode),rt=String.format(".app-{0}-header",this.mode),f=c.find("."+it),ut=s?null:e.find(rt);this.navigateDate&&!this.preventNavigate&&(a=this.getBlockByDate(f,this.navigateDate));f.length>0&&(this.preventNavigate||this.navigateDate&&a&&a.length)?(f.is(":visible")||f.fadeIn("fast"),p.resize(f,ut,null)):f=p.draw(c,this.navigateDate);s||(n.bar("show",e),r.updateHeader(e));this.resetVars()}},scroll:function(n){n.view||(n.view=this.getVisibleView());n.preventNavigate==null&&(n.preventNavigate=this.preventNavigate);n.enhancePrecision==null&&(n.enhancePrecision=this.enhancePrecision);n.animate==null&&(n.animate=this.animate);n.date==null&&(n.date=this.navigateDate);this.getViewHandler().scroll(n);this.resetVars()},hide:function(t){var r=h(),e=r&&r.extension().viewStyle(),u=this.scrollable(),i,f;(u&&(this.lastScrollTop=u.scrollTop()),e!="calendar")&&(i=t.container.data("cal-header"),f=n.sidebar(),i&&n.bar("hide",i),g("refresh",{container:f.find(".app-calendar-plugin")}),this.activeCalendar.colorMap.hide())},dispose:function(t){var r=t.container.data("cal-header"),i=this.dataView,u;r&&(r.off(),n.tabs("destroy",{container:r}),n.bar("remove",r));t.container.removeData();clearInterval(gr);this.cache.clear(t.container);i.calendar.activeCalendar.colorMap.clearFilter();for(u in this.views)this.views[u].calendar=null;i.calendar=null;i.calendarPlugin.calendar=null;i.calendarPlugin.dataView=null;i.calendarPlugin=null;this.dataView=null;this._scrollable=null},selectEvent:function(i,r,u){function w(t){var i=n.pageInfo(f._id);s||(i.echoChanged=!0);c=="vclick"&&k?(t&&(r.removeClass("app-calendar-selected"),f.extension().clearSelection()),n.refreshEchoToolbarWithDelay(f,e)):c=="contextmenu"?(n.contextScope(f._id),n.rowContext(r,{x:l.x,y:l.y,arrow:!1}),n.contextScope(null),n.refreshEchoToolbarWithDelay(f,e)):(n.contextScope(f._id),n.executeInContext(),n.contextScope(null))}function b(t){function i(n){var t=n.data("data-context");if(t&&t[h.Index]==p)return n.addClass("app-calendar-selected"),!1}f.extension().tap({row:t},v?"select":"none");a.find(".app-calendar-selected").removeClass("app-calendar-selected");e.find(".app-calendar-selected").removeClass("app-calendar-selected");s?a.find(o.viewClassName()+" .app-event").each(function(){i($(this))}):r.closest(".app-event, .app-calendar-month-more").addClass("app-calendar-selected");e.length&&e.find(".app-event").each(function(){i($(this))});v||(w(!1),n.refreshEchoToolbarWithDelay(f,e))}var c=u.type,k=u.ctrlKey,l=n.lastTouch(),a=this.scrollable(),o=this,f=o.dataView,v=f._lookupInfo,s=r.closest(".app-echo").length;if(this.hasKeyFields()){var h=this.dataView._keyFields[0],y=this.getCurrentKey(),p=this.mode!=="agenda"&&!s?i[0]:i[h.Index],e=$("#"+f._id+"_echo");f._keyFields.length==1&&(n.clearHtmlSelection(),y!=null&&p==y?w(!0):o.mode=="agenda"?b(i):t.execute({controller:f._controller,view:f._viewId,filter:[{field:h.Name,operator:"=",value:i[0]}],includeRawResponse:!0,sort:"",success:function(n){b(n.rawResponse.Rows[0])},error:function(n){t.alert(String.format("{0}",n.get_message()))}}),r.addClass("ui-btn-active"),n.callWithFeedback(r,function(){r.removeClass("ui-btn-active")}))}},showEventList:function(t,i,r,u){var e=this,s=e.getCurrentKey(),o=[];i.forEach(function(n){var t=n[0],i=n[1],f=n[2],h=n[4];o.push({text:e.getEventTitle(i,f,h,""),color:e.activeCalendar.colorMap.color(n[3]),visible:t==s?!0:!1,callback:function(){e.selectEvent(n,r,u)}})});n.listPopup({title:String.localeFormat("{0:"+f.LongDatePattern+"}",t),anchor:r,iconPos:"left",items:o})},getViews:function(){return $("#"+this.dataView._id).find('.app-wrapper .app-presenter[data-presenter="calendar"] > div.app-calendar > div')},getVisibleView:function(){return this.scrollable().find('.app-presenter[data-presenter="calendar"] > div.app-calendar > div.app-calendar-'+this.mode+"view")},getViewHandler:function(){return this.views[this.mode]},resetVars:function(){this.preventNavigate=null;this.lastDate=this.navigateDate;this.navigateDate=null;this.enhancePrecision=null;this.animate=null},clear:function(n){var t=this.getVisibleView(),i;this.cache.clear();for(i in this.views)this.views[i].clear(i==this.mode?n:!1);t&&t.length&&(this.loadData(t),this.dataView.calendarPlugin&&this.dataView.calendarPlugin.clearCache())},drawDayColumns:function(n,t,i){for(var u,f,e="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),o=0;o<t;o++)u='<div data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="app-calendar-day',yt(r)&&(u+=" current-day-column"),rt[r.getDay()]==6&&(u+=" endofweek"),u+='">',f="",i&&(f+=this.drawTimeColumn(n)),f+='<div data-cal-hour="0"><\/div><div data-cal-hour="0"><\/div><div data-cal-hour="1"><\/div><div data-cal-hour="2"><\/div><div data-cal-hour="3"><\/div><div data-cal-hour="4"><\/div><div data-cal-hour="5"><\/div><div data-cal-hour="6"><\/div><div data-cal-hour="7"><\/div><div data-cal-hour="8"><\/div><div data-cal-hour="9"><\/div><div data-cal-hour="10"><\/div><div data-cal-hour="11"><\/div><div data-cal-hour="12"><\/div><div data-cal-hour="13"><\/div><div data-cal-hour="14"><\/div><div data-cal-hour="15"><\/div><div data-cal-hour="16"><\/div><div data-cal-hour="17"><\/div><div data-cal-hour="18"><\/div><div data-cal-hour="19"><\/div><div data-cal-hour="20"><\/div><div data-cal-hour="21"><\/div><div data-cal-hour="22"><\/div><div data-cal-hour="23"><\/div><div data-cal-hour="0"><\/div><ul class="app-calendar-eventlist"><\/ul><div class="app-clear-fix"><\/div>',u+=f+"<\/div>",e+=u,r.setDate(r.getDate()+1);return e},drawDayHeaders:function(n,t){for(var r="",i=new Date(n.getFullYear(),n.getMonth(),n.getDate()),u=0;u<t;u++){var e=rt[i.getDay()],o=f.DayNames[i.getDay()],s=f.AbbreviatedDayNames[i.getDay()];r+='<li  data-cal-year="'+i.getFullYear()+'" data-cal-month="'+i.getMonth()+'" data-cal-day="'+i.getDate()+'" class="';e==0&&(r+=" first-day-of-week");e==6&&(r+=" last-day-of-week");r+='"><a class="ui-btn" title="'+o+'"><span class="letter-day">'+s.substring(0,1)+'<\/span><span class="abbr-day">'+s+'<\/span><span class="full-day">'+o+"<\/span>&nbsp;<div";yt(i)&&(r+=' class="app-current-day"');r+=">"+i.getDate()+"<\/div><\/a><\/li>";i.setDate(i.getDate()+1)}return r},drawTimeColumn:function(){for(var i,r,u='<div class="app-calendar-time"><ul>',t,e=!!f.AMDesignator.length,n=0;n<=24;n++)e?n==12?t=nt.Noon:(i=n%12,r=n<12?f.AMDesignator:f.PMDesignator,(n==0||n==24)&&(i=12,r=f.AMDesignator),t=String.format("{0} {1}",i,r)):t=n==24?0:n,u+='<li><span data-cal-hour="'+n+'">'+t+"<\/span><\/li>";return u+'<\/ul><div class="app-current-time"><\/div><\/div>'},getBlocks:function(){return this.getViewHandler().getBlocks()},getMostVisibleBlock:function(n){var t,r,i,u;n||(n=this.scrollable());r=n.height()/2;i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":if(i.each(function(){var n=$(this);if(t||(t=n),n.position().left>n.width()/2)return!1;t=n}),this.mode=="week")while(t&&t.length&&t.position().left+t.width()<=ti)u=t.next(),t=u;break;case"year":case"month":case"agenda":i.each(function(){var n=$(this);return t=n,n.offset().top+n.height()>r?!1:void 0})}return t},getFirstVisibleBlock:function(t){var u,f;t||(t=this.scrollable());var e=n.stickyHeaderBar().outerHeight()+t.offset().top,r=$(this.getBlocks(t)),i=r.eq(0),o=i.width(),s=this.getVisibleView(),h=parseInt(s.css("marginLeft"),10);switch(this.mode){case"day":case"week":u=Math.floor(-h/o);i=r.eq(u);i&&i.length&&i.position().left<0&&(f=r.eq(u+1),f.length&&(i=f));break;case"month":case"year":case"agenda":r.each(function(){var n=$(this);if(n.offset().top>e)return!1;i=n})}return i},getLastVisibleBlock:function(n){var t,r=n.height()+n.position().top,u=n.width(),i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":i.each(function(){var n=$(this);if(t||(t=n),n.position().left>=u)return!1;t=n});break;case"month":case"year":case"agenda":i.each(function(){var n=$(this);if(t||(t=n),n.offset().top>r)return!1;t=n})}return t},getBlockByDate:function(n,t){var i=t.getFullYear(),r=t.getMonth(),u=t.getDate();if(!n||!n.length)return null;switch(this.mode){case"year":return n.find(String.format('.app-calendar-year[data-cal-year="{0}"]',i));case"month":return n.find(String.format('.app-calendar-month[data-cal-year="{0}"][data-cal-month="{1}"]',i,r));case"week":case"day":return n.find(String.format('.app-calendar-day[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',i,r,u));case"agenda":return n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] ul',i,r,u))}},resizeScroller:function(){return},updateHeader:function(t){var h,lt,at;if(t){var w=this,a=w.scrollable(),bt=w.mode,v=t.find(".app-tabs"),kt=t.find(".app-calendar-today"),y,b=w.getFirstVisibleBlock(a),tt,k,g;if(b){k=t[0].getBoundingClientRect();tt=kt[0].getBoundingClientRect();g=k.right-tt.left+20;v.css({minWidth:0,marginLeft:g,marginRight:0,width:k.width-2*g});n.tabs("fit",{page:c(a)});y=!v.find(".app-tab-more").length;v.css("visibility",y?"":"hidden");var p=t.find(".app-calendar-badge").toggleClass("app-has-droparrow",!y),u=d(b),i=u.getFullYearText(),it=u.getMonth(),vt=u.getDay(),e=u.getDate(),o=f.MonthNames[it],s=f.AbbreviatedMonthNames[it],dt=y?g:tt.left-k.left-20,yt=1,r=[];if(vt.toString()!="NaN"){switch(bt){case"year":r=["<b>"+i+"<\/b>&nbsp;"];h=b.find("h1");h.is("app-in-header")||(a.find(".app-calendar-yearview .app-calendar-year h1.app-in-header").removeClass("app-in-header"),h.addClass("app-in-header"));break;case"month":r=[String.format("<b>{0}<\/b> {1}",o,i),String.format("<b>{0}<\/b> {1}",s,i),String.format("<b>{0}<\/b>",o),String.format("<b>{0}<\/b>",s)];h=b.find("h1.app-calendar-month-header");h.is("app-in-header")||(a.find(".app-calendar-monthview .app-calendar-month h1.app-calendar-month-header.app-in-header").removeClass("app-in-header"),h.addClass("app-in-header"));break;case"week":var rt=w.getLastVisibleBlock(a),ut=rt?d(rt):new Date,ft=ut.getFullYearText(),et=ut.getMonth(),l=ut.getDate(),nt=it==et,ot=i==ft,st=f.MonthNames[et],ht=f.AbbreviatedMonthNames[et];if(!rt)return;r.push(String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",o,e,ot?"":", "+i,nt?"":st+" ",l,ft),String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",s,e,ot?"":", "+i,nt?"":ht+" ",l,ft));ot?r.push(String.format("<b>{0} {1}<\/b> - {2}{3}",o,e,nt?"":st+" ",l),String.format("<b>{0} {1}<\/b> - {2}{3}",s,e,nt?"":ht+" ",l),String.format("<b>{0} {1}<\/b>, {2}",o,e,i),String.format("<b>{0} {1}<\/b>, {2}",s,e,i)):r.push(String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",o,e,i,st,l),String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",s,e,i,ht,l),String.format("<b>{0} {1}<\/b>, {2}",o,e,i),String.format("<b>{0} {1}<\/b>, {2}",s,e,i));break;case"agenda":case"day":var gt=f.DayNames[ii[vt]],ni=new RegExp(gt+"(.?) ","i"),ct=String.format("{0:"+f.MonthDayPattern+"}",u),ti=new RegExp(ct,"i"),pt=String.localeFormat("{0:"+f.LongDatePattern+"}",u).replace(ti,"<b>"+ct+"<\/b>"),wt=pt.replace(ni,"");r=[pt,wt,wt.replace(f.MonthGenitiveNames[u.getMonth()],f.AbbreviatedMonthGenitiveNames[u.getMonth()])];u.getFullYear()==(new Date).getFullYear()&&r.push("<b>"+ct+"<\/b>",String.format("<b> {0:"+f.MonthDayPattern.replace(/M+/,"MMM")+"}<\/b>",u));r.push(u.toLocaleDateString())}for(r[0]&&(lt=r[0].replace(/<\/?b>|&nbsp;/g,""),p.html(r[0]).attr("title",lt).attr("data-cal-value",lt));p[0].clientWidth>dt;){if(at=r[yt],!at)break;p.html(at);yt++}}y&&p[0].getBoundingClientRect().right>v.find("ul").offset().left-8&&(v.css("visibility","hidden"),p.addClass("app-has-droparrow"))}}},scrollView:function(t){var f=this.scrollable(),o=this.dataView,r=this.getVisibleView(),i,e=t=="next"?1:-1,u;i=t!="today"?this.getViewHandler().getNextDate(r,e):new Date;u=this.getBlockByDate(r,i);u.length?this.scroll({date:i,animate:!0,view:r}):(this.navigateDate=i,n.presenter("show",{id:this.dataView._id,name:"calendar",container:f}))},loadData:function(n){var t=this,f=t.dataView.extension().viewStyle();if(this.mode=="agenda"&&t.activeCalendar.colorMap.load(!0),n.is(":visible")&&this.mode!="agenda"&&f=="calendar"){var i=n.closest(".app-wrapper"),r=t.getFirstVisibleBlock(i),u=t.getLastVisibleBlock(i);r.length&&u.length&&t.loadDataInBlock(n,r,u)}},loadDataInBlock:function(n,t,i){function s(){e?r.loadDataInBlock(n,e,i):r.activeCalendar.colorMap.load(!0)}var r=this,e=t.next(":not(.current-time-line)"),o=r.mode,u,f;if(t[0]!=i[0]&&e.length||(e=null),!this.loadingData&&r.mode!="agenda")if(t.hasClass("data-loaded"))s();else{if(!r.blockIsVisible(n,t)){s();return}u=d(t);f=this.cache.select(u);f?($.isEmptyObject(f)||this.getViewHandler().addData(n,u,f),this.loadingData=!1,t.addClass("data-loaded"),s()):this.requestData({mode:o,date:u,success:function(i){r.cache.insert(u,i.Pivots.pivot0.Data.slice(1));callback=function(){if(r.blockIsVisible(n,t)){switch(o){case"day":t.find("td > ul").empty();break;case"week":t.find("td > ul").empty();break;case"month":t.find("td > ul").empty();break;case"year":t.find("td.app-has-data").removeClass("app-has-data");break;case"agenda":return}t.addClass("data-loaded");f=r.cache.select(u);$.isEmptyObject(f)||r.views[o].addData(n,u,f);s()}ei=null};fi&&!o.match(/day|week/)?ei=callback:callback()}})}},requestData:function(n){var r=this,i=r.activeCalendar,f={controller:r.dataView._controller,command:n.mode=="agenda"?"Select":"Pivot",view:r.dataView._viewId,sort:i.date.Name,tags:r.dataView.get_tags(),fieldFilter:[i.date.Name],success:function(t){r.loadingData=!1;n.success(t)},error:function(n){r.loadingData=!1;t.alert(String.format("{0}",n.get_message()))}};if(i.text&&(f.fieldFilter.push(i.text.Name),i.text.AliasIndex!=0&&f.fieldFilter.push(r.dataView._allFields[i.text.AliasIndex].Name)),i.color&&(f.fieldFilter.push(i.color.Name),i.color.AliasIndex!=0&&f.fieldFilter.push(r.dataView._allFields[i.color.AliasIndex].Name)),i.end&&f.fieldFilter.push(i.end.Name),n.mode){i=r.activeCalendar;var s=n.date,u=new Date(s),o={},e=o[i.date.Name]=["calendar-date","pivot-val2-count","pivot-row1-year","pivot-row2-month-raw","pivot-row3-day"],h=o[i.text.Name],c=i.color?o[i.color.Name]:null;i.end&&(o[i.end.Name]=["calendar-end"]);h||(h=o[i.text.Name]=["calendar-text"]);i.color&&!c&&(c=o[i.color.Name]=["calendar-color"]);switch(n.mode){case"daylist":u.setDate(u.getDate()+1);e.push("pivot-val1-calendar-first100");break;case"day":u.setDate(u.getDate()+1);e.push("pivot-row4-halfhour");e.push("pivot-val1-calendar");break;case"week":u.setDate(u.getDate()+7);e.push("pivot-row3-day","pivot-row4-halfhour");e.push("pivot-val1-calendar");break;case"month":u.setMonth(u.getMonth()+1);e.push("pivot-row3-day");e.push("pivot-val1-calendar-first5");break;case"year":u.setYear(u.getFullYear()+1);e.push("pivot-row3-day")}u.setSeconds(-1);f.pivotDefinitions=o;f._filter=ri(r.dataView,i.date,null,s,u)}else n.pivots&&n.date&&n.end&&(f.pivotDefinitions=n.pivots,f._filter=ri(r.dataView,i.date,null,n.date,n.end));r.loadingData=!0;t.execute(f)},blockIsVisible:function(n,t){var i;if(!n.is(":visible"))return!1;if(i=n.closest(".app-wrapper"),this.mode.match(/month|year/)){var r=i.offset().top,f=r+i.height(),u=t.offset().top,e=u+t.height(),s=u<=f&&u>=r,h=e>=r&&e<=f,c=u<=r&&e>=f;return s||h||c}if(this.mode.match(/day|week/)){var l=i.width(),o=t.position().left,a=o+t.width();return a>=0&&o<=l}return!0},hasKeyFields:function(){return this.dataView._keyFields.length>0},getCurrentKey:function(){if(!this.hasKeyFields())return null;var t=this.dataView._keyFields[0],n=this.dataView.extension().commandRow();return n?n[t.Index]:null},getEventTitle:function(n,t,i,r){var u=it(n,!0);return t&&(u+="-"+it(t,!0)),u+="\n"+(i?i:ut.Data.NullValueInForms),this.activeCalendar.color&&r!=""&&(u+="\n"+(r?r:ut.Data.NullValueInForms)),u},getActionsByName:function(t){var u=this,i=[],r=[];return n.navContext(i),i.forEach(function(n){n.command===t&&(t!=="New"||n.argument!==u.dataView._viewId)&&r.push(n)}),r},drawDayData:function(n,t,i,r){var f=this,u=i.rows;u&&u.forEach(function(t){var i=f.drawEvent(t,r);i.appendTo(n)});this.resizeDayData(n.find("li"))},drawEvent:function(n,t){var u=this,a=n[0],f=n[1],r=n[2],o=n[3],e=n[4],h=it(f,!1,!0),c=it(f);r&&(h+="-"+it(r,!1,!0),c+=" - "+it(r));var l=String.format('<div class="app-event-data"><span class="app-event-time">{0}<\/span> {1} <div class="app-event-time-long">{2}<\/div><\/div>',h,e?e:ut.Data.NullValueInForms,c),i=s("app-event").data("data-context",n),v=u.getEventTitle(f,r,e,o),y=u.activeCalendar.colorMap.className(o);return this.dataView.get_isTagged("calendar-drag-disabled")||(i.attr("data-draggable","calendar-event"),u.activeCalendar.end&&(l+='<div class="app-event-handle ui-icon-dots" data-draggable="calendar-event-handle"><\/div>')),t&&t==a&&i.addClass("app-calendar-selected"),r&&i.addClass("app-event-has-end-time"),i.addClass(y),i.html(l),i.attr("title",v),i},resizeDayData:function(n){var e=[],t=[],h=ot/25,o=n.first().closest(".app-calendar-day").width()-(this.mode=="day"?150:10),c=this.mode=="day"?10:4,i,u,f,r;n.each(function(){var i=$(this);if(i.is(".app-event-more")){i.remove();return}var r=i.data("data-context"),t=r[1],n=r[2];!n||n.getTime()<t.getTime()?(n=new Date(t),n.setMinutes(n.getMinutes()+cu)):n.getDate()!=t.getDate()&&(n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59));e.push({element:i,data:r,start:t.getTime(),end:n.getTime(),depth:1,width:0})});e.sort(function(n,t){return n.start!=t.start?n.start>t.start?1:-1:n.end!=t.end?n.end<t.end?1:-1:0});u=[];r=0;e.forEach(function(n){function e(){n.depth=t.length+1;n.depth>r&&(r=n.depth);t.push(n);u.push(n)}for(i=t.pop();i;)if(i.end<=n.start)i=t.pop(),i||(u.forEach(function(n){n.width=r}),r=0,u=[]);else{t.push(i);break}t.length>=c?f?(n.collapsed=!0,f.collapsedEvents.push(n.data)):(f=n,f.collapsedEvents=[n.data],e()):(f=null,e())});u.forEach(function(n){n.width=r});e.forEach(function(n){var i,r;if(n.collapsed)n.element.hide();else{var t=n.element,u=n.data[1],e=n.data[2],c=h*(u.getHours()+u.getMinutes()/60)+22,l=uu(n.start,n.end),f=o/n.width,a=o*(n.depth-1)/n.width;n.depth!=n.width&&(f*=1.3);n.collapsedEvents&&n.collapsedEvents.length>1&&(t.hide(),i="+"+n.collapsedEvents.length+" "+ut.Mobile.More,t=s("app-event app-event-more ui-icon-dots").appendTo(t.closest("ul")).html(i).attr("title",i).data("data-more-context",n.collapsedEvents));r={top:c,"z-index":n.depth+2,marginLeft:a+"px",width:f-3+"px"};e&&(r.height=l);t.css(r)}})}};er=function(n){this.calendar=n};er.prototype={draw:function(n,t){var f,l;n.find(".app-calendar-dayview").remove();var r=i("app-calendar-dayview").appendTo(n),h=r.closest(".app-echo").length>0,c=r.closest(".app-presenter"),a=r.closest(".app-wrapper"),o=c.data("cal-header"),s=h?1:ht.day*7,u=new Date(t.getFullYear(),t.getMonth(),t.getDate()),e='<div class="app-calendar-day-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>';return u.setDate(u.getDate()-rt[u.getDay()]),o.find(".app-day-header").remove(),f=i("app-day-header app-calendar-header",'data-draggable="calendar-bar-day"').appendTo(o),l=$("<ul> "+this.calendar.drawDayHeaders(u,s)+" <\/ul>").appendTo(f),vt(f),e+=this.calendar.drawDayColumns(u,s,!0),e+="<\/div>",r.html(e).find(".app-calendar-day").hide(),this.resize(r,f,null),this.scroll({view:r,date:t,enhancePrecision:!0}),r},showHeaderAndFooter:function(n){n.find(".app-day-header").show();n.find(".app-week-header").hide();n.find(".app-month-header").hide();this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},resize:function(n,t){t.is(".app-day-header")||(t=t.find(".app-day-header"));var r=n.closest(".app-echo").length>0,y=n.find(".app-calendar-day-grid"),u=n.find(".app-calendar-day"),i=t.find("li"),p=this.calendar.scrollable(),f=p.outerWidth(),w=Math.floor(f/7),b=u.length*f,s=this.calendar.navigateDate&&!this.calendar.preventNavigate,e,o,h,c,l,a;if(s||(e=bt(u),o=r?null:bt(i),h=e.position().left,c=r?0:o.position().left,l=parseInt(n.css("marginLeft"),10)*-1,a=r?0:parseInt(t.css("marginLeft"),10)*-1),y.width(b),t.width(i.width()*i.length),i.closest("ul").css("visibility",""),i.width(w),u.width(f).fadeIn("fast"),n.height(ot),!r)if(s)this.scroll({view:n,date:this.calendar.navigateDate});else{var k=e.position().left,d=o.position().left,g=h-k,v=Math.floor(c-d);v!=0&&t.css("marginLeft",a*-1+v);this._scroll(n,t,l-g,null)}ft();this.resizeData(n)},scroll:function(t){var e=this,r=e.calendar,o=r.dataView.extension().commandRow(),a=r.scrollable(),u=t.view,v=t.animate,y=u.closest(".app-presenter"),p=y.data("cal-header").find(".app-day-header"),i=t.date,s=r.getBlockByDate(u,i),h,c,f,l;s.length&&(h=parseInt(u.css("marginLeft"),10),c=s.position().left,e._scroll(u,p,c-h,null,v));t.enhancePrecision&&(o?(l=o[r.activeCalendar.date.Index],f=ft(l,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||ft():ft(i,"find"),n.scroll(a,f))},_scroll:function(t,i,r,u,f){var s;n.animate()||(f=!1);var c=parseInt(t.css("marginLeft"),10),o=r*-1,e=this,h=t.find(".app-calendar-day-grid");if(t.removeClass("app-has-current-day"),di++,f==!0){t.animate({marginLeft:o},si,function(){e._scroll(t,i,r,null)});return}t.css("marginLeft",o);s=this.updateDayHeader(t,i);clearTimeout(oi);oi=setTimeout(function(){var n=t.find(".app-calendar-day"),u=bt(n),a=n.width(),f=r%a,l,y=ht.day*7,p=gi.day*7,g,nt,ut,v,tt,w,it,b,k;if(di==1&&f!=0?(o>c?(f=f*-1,u=u.prev(),u.is(".current-time-line")&&(u=u.prev())):(f=a-f,u=u.next(),u.is(".current-time-line")&&(u=u.next())),s=e.updateDayHeader(t,i,u)):f=f>a/2?a-f:f*-1,nt=o-f,ut=nt*-1,r<a)v=n.first(),g=v.position().left,l=d(v),l.setDate(l.getDate()-y),$(e.calendar.drawDayColumns(l,y,!0)).width(a).prependTo(h),$(e.calendar.drawDayHeaders(l,y)).width(a/7).prependTo(i.find("ul")),n=t.find(".app-calendar-day"),n.length>p&&(n.slice(p,n.length).remove(),i.find("li").slice(p,n.length).remove()),t.css("marginLeft",(v.position().left-g)*-1),i.css("marginLeft",s.position().left*-1);else if(r>n.width()*(n.length-2))v=n.last(),g=v.position().left,l=d(v),l.setDate(l.getDate()+1),$(e.calendar.drawDayColumns(l,y,!0)).width(a).appendTo(h),$(e.calendar.drawDayHeaders(l,y)).width(a/7).appendTo(i.find("ul")),w=n.length+y,it=0,tt=0,w>p&&(b=n.slice(0,w-p),k=i.find("li").slice(0,w-p),it=b.width()*b.length,tt=k.width()*k.length,b.remove(),k.remove()),t.css("marginLeft",parseInt(t.css("marginLeft"),10)+it-f),i.css("marginLeft",parseInt(i.css("marginLeft"),10)+tt);else{function rt(){e.calendar.updateHeader(i.closest(".app-bar-calendar"))}f!=0?t.animate({marginLeft:nt},{duration:si,done:rt}):rt()}u.is(".current-day-column")&&t.addClass("app-has-current-day");pt();di=0},250)},updateDayHeader:function(n,t,i){var c=n.find(".app-calendar-day"),l=i&&i.length?i:bt(c),r=d(l),e=bt(t.find("ul li")),u=d(e),f=e,o,s,h;return t.find("li .visible-day").removeClass("visible-day"),o=t.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] > a > div',r.getFullYear(),r.getMonth(),r.getDate())),o.addClass("visible-day"),r.setDate(r.getDate()-rt[r.getDay()]),u.setDate(u.getDate()-rt[u.getDay()]),u.getTime()!=r.getTime()&&(f=t.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',r.getFullYear(),r.getMonth(),r.getDate())),f.length&&(s=parseInt(t.css("marginLeft"),10),h=s-f.position().left,t.css("marginLeft",h))),this.calendar.updateHeader(t.closest(".app-bar-calendar")),f},addData:function(n,t,i){var f=this.calendar.getBlockByDate(n,t,"day"),r=f.find("ul.app-calendar-eventlist"),e=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),o=u?u[e.Index]:null;r.empty();typeof i!="boolean"&&this.calendar.drawDayData(r,t,i,o)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-dayview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},getNextDate:function(n,t){var r=this.calendar.getMostVisibleBlock(),i=d(r);return i.setDate(i.getDate()+t),i},getBlocks:function(){return this.calendar.scrollable().find(".app-calendar-dayview > .app-calendar-day-grid > .app-calendar-day")}};or=function(n){this.calendar=n};or.prototype={draw:function(n,t){var e,v,f,c;t.setDate(t.getDate()-rt[t.getDay()]);n.find(".app-calendar-weekview").remove();var r=i("app-calendar-weekview").appendTo(n),o=this.calendar,l=r.closest(".app-echo").length>0,s=l?7:ht.week,a=r.closest(".app-presenter"),y=r.closest(".app-wrapper"),h=a.data("cal-header"),u=new Date(t.getTime());return u.setDate(u.getDate()-s),h.find(".app-week-header").remove(),e=i("app-week-header app-calendar-header",'data-draggable="calendar-bar-week"').appendTo(h),v=$("<ul>"+o.drawDayHeaders(u,s*3)+"<\/ul>").appendTo(e),vt(e),f='<div class="app-calendar-week-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>',f+=o.drawTimeColumn(u),f+=o.drawDayColumns(u,s*3,!1),f+="<\/div>",r.html(f),c=r.find(".app-calendar-week-grid").hide(),this.resize(r,e,null),this.scroll({view:r,date:t,enhancePrecision:!0}),this.validateCurrentDay(r,c),ft(),r},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").show();n.find(".app-month-header").hide();this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},_timelineDot:function(n,t){var o=this.calendar.scrollable(),u=n.find(".app-calendar-week-grid"),f,i=u.find(".current-time-line .dot"),e,r;t?(r=i.show().width(),f=u.find(".current-day-column"),f.length&&(e=f.offset().left-o.offset().left-r/2+parseInt(u.css("margin-left")),e+r<o.width()-r*3?setTimeout(function(){i.css("marginLeft",e).show()}):i.hide())):i.hide()},resize:function(n,t){t.is(".app-week-header")||(t=t.find(".app-week-header"));var r=n.closest(".app-echo").length>0,s=n.find(".app-calendar-week-grid"),h=n.find(".app-calendar-week-grid > div:not(.current-time-line):not(.app-calendar-time) > div"),i=t.find("li"),c=this.calendar.scrollable(),l=c[0].scrollWidth-ti,u=Math.floor(l/7),a=u*(i.length+1)+ti,f=bt(i),v=r?0:f.position().left,e=r?0:parseInt(t.css("marginLeft"),10)*-1;if(i.width(u),i.closest("ul").css("visibility",""),h.width(u),s.width(a).fadeIn("fast"),n.height(ot),!r){var y=f.position().left,o=v-y,p=e-o;this._timelineDot(n,!0);this._scroll(n,t,e-o,null);this.resizeData(n)}ft()},scroll:function(t){var h,c,f,l;t.date.setDate(t.date.getDate()-rt[t.date.getDay()]);var e=this,r=e.calendar,u=t.view,a=t.animate,i=t.date,o=r.dataView.extension().commandRow(),v=u.closest(".app-presenter"),y=r.scrollable(),p=v.data("cal-header").find(".app-week-header"),s=r.getBlockByDate(u,i);s.length&&(h=parseInt(u.css("marginLeft"),10),c=s.position().left-ti,e._scroll(u,p,c-h,null,a));t.enhancePrecision&&(o?(l=o[r.activeCalendar.date.Index],f=ft(l,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||ft():ft(i,"find"),n.scroll(y,f))},_scroll:function(t,i,r,u,f){function it(){h.updateHeader(nt);p||(r<ft?et():y.position().left<ut?ot():e.validateCurrentDay(t,s));pt(g);e._timelineDot(t,!0)}function a(n,t,i){var r=i.getDate();n.attr("data-cal-year",i.getFullYear()).attr("data-cal-month",i.getMonth()).attr("data-cal-day",r).data("calendar-colors",t.data("calendar-colors")).find("ul").empty().append(t.find("ul li"));n[0].className=t[0].className}function rt(n,t){var i=t.getDate();n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",i);n.data("calendar-colors",null);n.find("ul").empty().removeClass("data-loaded");n[0].className="app-calendar-day";yt(t)&&n.addClass("current-day-column")}function et(){p=!0;var y=o.first(),g=s.find(".current-time-line"),u=d(y),v=!1;u.setDate(u.getDate()-w);var b=i.find("li"),f=o.slice(0,7),c=o.slice(7,14),k=o.slice(14,21),n=new Date(u);return b.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);yt(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=d(c.first()),k.each(function(t){a($(this),c.eq(t),n);n.setDate(n.getDate()+1)}),n=d(f.first()),c.each(function(t){a($(this),f.eq(t),n);n.setDate(n.getDate()+1)}),n=u,f.each(function(){rt($(this),n);var i=h.cache.select(n);i&&(e.addData(t,n,i),v=!0);n.setDate(n.getDate()+1)}),e.validateCurrentDay(t,s),v&&e.resizeData(t),r-=l,r>0&&(r=0),t.css("marginLeft",r),i.css("marginLeft",r),l}function ot(){p=!0;var y=o.first(),g=s.find(".current-time-line"),f=d(y),v=!1;f.setDate(f.getDate()+w);var b=i.find("li"),k=o.slice(0,7),c=o.slice(7,14),u=o.slice(14,21),n=new Date(f);return b.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);yt(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=d(c.first()),k.each(function(t){a($(this),c.eq(t),n);n.setDate(n.getDate()+1)}),n=d(u.first()),c.each(function(t){a($(this),u.eq(t),n);n.setDate(n.getDate()+1)}),n=d(u.last()),n.setDate(n.getDate()+1),u.each(function(){rt($(this),n);var i=h.cache.select(n);i&&(e.addData(t,n,i),v=!0);n.setDate(n.getDate()+1)}),e.validateCurrentDay(t,s),r-=l,v&&e.resizeData(t),r>0&&(r*=-1),t.css("marginLeft",r),i.css("marginLeft",r),l}var v,b,k;n.animate()||(f=!1);var e=this,h=e.calendar,g=h.scrollable(),ut=g.width(),s=t.find(".app-calendar-week-grid"),o=s.find(".app-calendar-day"),nt=i.closest(".app-bar-calendar"),y=o.last(),c=y.width(),st=y.position().left-ti+c,p=!1,tt=i.find("li:first-of-type"),ct=d(tt),ft=tt.width()+2,lt=gi.week,w=ht.week,l=c*w;e._timelineDot(t,!1);h.updateHeader(nt);f==!0?(v=r%c,b=r*-1+(v>c/2?v-c:v),i.animate({marginLeft:b},si),t.animate({marginLeft:b},si,function(){setTimeout(function(){it()})})):(k=r*-1,i.css("marginLeft",k),t.css("marginLeft",k),clearTimeout(oi),oi=setTimeout(it,250))},addData:function(n,t,i){var f=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),e=u?u[f.Index]:null,o=this.calendar.getBlockByDate(n,t,"day"),r=o.find("ul.app-calendar-eventlist");r.empty();r.data("calendar-event-count",i.count||0);this.calendar.drawDayData(r,t,i,e)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-weekview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},validateCurrentDay:function(n,t){n.is(".app-has-current-day")?t.find(".current-day-column").length||n.removeClass("app-has-current-day"):t.find(".current-day-column").length&&n.addClass("app-has-current-day")},getNextDate:function(n,t){var u=this.calendar.getMostVisibleBlock(),i=d(u),r=rt[i.getDay()];return r==0?i.setDate(i.getDate()+t*7):i.setDate(i.getDate()+(t==-1?r*-1:7-r)),i},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-weekview > .app-calendar-week-grid > .app-calendar-day")}};sr=function(n){this.calendar=n};sr.prototype={draw:function(t,r){var h,k,w,b;t.find(".app-calendar-monthview").remove();var e=i("app-calendar-monthview").hide().appendTo(t),l=e.closest(".app-echo").length>0,tt=e.closest(".app-presenter"),v=tt.data("cal-header"),y=l?0:ht.month,it=r.getMonth(),s=new Date(r.getFullYear(),it,1),p,o;for(s.setMonth(s.getMonth()-y),p=s.getMonth(),v.find(".app-month-header").remove(),h=i("app-month-header app-calendar-header"),k=a().appendTo(h),o=0;o<7;o++){var c=ii[o],d=f.DayNames[c],g=f.AbbreviatedDayNames[c],nt=$('<li><span class="letter-day">'+g.substring(0,1)+'<\/span><span class="abbr-day">'+g+'<\/span><span class="full-day">'+d+"<\/span><\/li").attr("title",d);(c==0||c==6)&&nt.addClass("app-calendar-weekend");nt.appendTo(k)}for(vt(h),h.appendTo(v),n.bar("show",v),e.fadeIn("fast"),w=i("app-calendar-load-at-top").appendTo(e),u("dv-load-at-top ui-btn").appendTo(w).text(et.Loading),l&&w.hide(),o=y*-1;o<=y;o++)this.drawMonth(s).appendTo(e),s.setMonth(p+1),p=s.getMonth();return this.resize(e),b=i("app-calendar-load-at-bottom").appendTo(e),u("dv-load-at-bottom ui-btn").appendTo(b).text(et.Loading),l&&b.hide(),this.scroll({date:r,view:e}),e},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").show()},resize:function(n,t,i,r){var o=n.closest(".app-wrapper"),u=n.find(".app-calendar-month"),f=u.find("table"),e=o.height()-u.first().find(".app-calendar-month-header").outerHeight();r&&u.removeClass("data-loaded");f.height(e);f.each(function(){var t=$(this),n=t.find("tr");n.height(e/n.length)});this.calendar.navigateDate&&!this.calendar.preventNavigate&&this.scroll({view:n,date:this.calendar.navigateDate})},scroll:function(t){var s=this,r=s.calendar,u=r.getBlockByDate(t.view,t.date);if(u){var i=r.scrollable(),c=t.view.closest("div.app-presenter"),f=u.find(".app-calendar-month-header"),h=i.find(".app-presenter-instruction"),e=f.offset().top-i.offset().top+f.outerHeight(!0)-h.outerHeight(!0)+i.scrollTop(),o=function(){n.fetchOnDemand();pt(i)};t.animate?n.animatedScroll(i,e,o):(n.scroll(i,e),o())}},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-monthview"),t;i.length&&(t=i.find("div.app-calendar-month.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},drawMonth:function(n){var v=n.getMonth(),p=f.MonthNames[v],y=i("app-calendar-month").attr("data-cal-year",n.getFullYear()).attr("data-cal-month",v),w=o("h1","app-calendar-month-header").appendTo(y),d=o("table").appendTo(y),l,r;v==0?w.text(String.format("{0} {1}",p,n.getFullYearText())):w.text(p);var t=new Date(n.getFullYear(),n.getMonth(),1),h=rt[t.getDay()],c=new Date(n.getFullYear(),n.getMonth()+1,1),b=rt[c.getDay()],k;for(b!=0&&c.setDate(c.getDate()+(6-b)+1),h!=0&&t.setDate(t.getDate()-h);t<c;){if(l=t.getDay(),h=rt[l],h==0&&(k=o("tr").appendTo(d)),r=o("td").appendTo(k),(l==0||l==6)&&r.addClass("app-calendar-weekend"),t.getMonth()==n.getMonth()){r.html("&nbsp;");r.attr("data-cal-day",t.getDate());var g=u("ui-btn").appendTo(r),nt=e().text(t.getDate()).appendTo(g),tt=a().appendTo(r),it=s("app-calendar-month-more").appendTo(tt);ni.setHours(0,0,0,0)==t.setHours(0,0,0,0)&&nt.addClass("app-current-day")}else r.html("&nbsp;");t.setDate(t.getDate()+1)}return y},addData:function(n,t,i){var e=this.calendar,c=e.getBlockByDate(n,t,"month"),nt=e.dataView,st=nt._keyFields[0],ht=e.activeCalendar,r=e.dataView.extension().commandRow(),p=r?r[st.Index]:null,l=r?r[ht.date.Index]:null,tt,a,ct=c.find("td").first(),lt=c.find("td > a").first(),rt=c.find("ul"),w,ot;rt.hide();tt=ct.outerHeight()-lt.height();rt.show();for(w in i){var b=i[w],k=b.count,o=null,v=c.find('td[data-cal-day="'+w+'"] ul'),f=0,y,h=s("app-calendar-month-more");for(a=!1,v.empty().data("calendar-event-count",k);f<5;){if(r=b.rows[f],!r)break;t=r[1];var at=r[0],d=r[2],ft=r[3],g=r[4],et=it(t,!1,!0);d&&(et+="-"+it(d,!1,!0));var vt=String.format('<span class="app-event-time">{0}<\/span> {1}',et,g?g:ut.Data.NullValueInForms),u=s("app-event").data("data-context",r),yt=e.getEventTitle(t,d,g,ft),pt=e.activeCalendar.colorMap.className(ft);if(nt.get_isTagged("calendar-drag-disabled")||u.attr("data-draggable","calendar-event"),o||(o=t),p&&p==at&&(u.addClass("app-calendar-selected"),y=u),u.addClass(pt),u.html(vt),u.attr("title",yt),u.appendTo(v),f++,v.height()>tt&&k!=1){u.remove();a=!0;f--;break}}(a||f<b.count)&&(h.appendTo(v),a&&(ot=h.prev(),ot.length&&(h.prev().remove(),f--)),h.html(String.format(au,k-f)),p&&l&&l.getDate()==o.getDate()&&l.getMonth()==o.getMonth()&&l.getFullYear()==o.getFullYear()&&(y&&(!y||y.is(":visible"))||h.addClass("app-calendar-selected")))}},getNextDate:function(n,t){var r=this.calendar,f=r.getMostVisibleBlock(),i=d(f),n,u;return i.setMonth(i.getMonth()+t,1),n=r.getVisibleView(),u=r.getBlockByDate(n,i),u.length||(t==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),i},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-monthview > .app-calendar-month")}};hr=function(n){this.calendar=n};hr.prototype={draw:function(n,t){var f,o;n.find(".app-calendar-yearview").remove();var r=i("app-calendar-yearview").hide().appendTo(n),e=r.closest(".app-echo").length>0,s=e?0:ht.year,h=t.getFullYear(),c=i("app-calendar-load-at-top").appendTo(r);for(u("dv-load-at-top ui-btn").appendTo(c).text(et.Loading),e&&c.hide(),f=h-s;f<=h+s;f++)this.drawYear(new Date(f,0)).appendTo(r);return r.fadeIn("fast"),o=i("app-calendar-load-at-bottom").appendTo(r),u("dv-load-at-bottom ui-btn").appendTo(o).text(et.Loading),e&&o.hide(),this.scroll({view:r,date:t}),r},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide()},drawYear:function(n){for(var h,i,r,e,o,s=n.getFullYear(),u='<div class="app-calendar-year" data-cal-year="'+s+'"><h1>'+n.getFullYearText()+"<\/h1>",t=0;t<=11;t++){for(h=f.AbbreviatedMonthNames[t].toUpperCase(),i='<div class="app-calendar-month" data-cal-month="'+t+'"><div class="app-calendar-month-title"><a class="ui-btn app-calendar-month-header">'+h+"<\/a><\/div><table><thead>",r=0;r<7;r++)i+="<th>"+f.ShortestDayNames[ii[r]].substr(0,1)+"<\/th>";i+="<\/thead><tbody>";i+=iu(s,t);u+=i+"<\/tbody><\/table><\/div>"}return u+='<div class="app-clear-fix"><\/div><\/div>',e=$(u),o=this.calendar.cache.select(n),o&&this.addData(null,n,o,e.addClass("data-loaded")),e},addData:function(n,t,i,r){var f=this.calendar,e=r||f.getBlockByDate(n,t,"year"),u,o,s;e.find("td.app-has-data").removeClass("app-has-data").attr("title",null);for(u in i)o=i[u],s=e.find('div[data-cal-month="'+u+'"]'),s.find("td").each(function(){var t=$(this),i=t.text(),n;i.trim().length&&(n=o[i],n&&n.count&&t.addClass("app-has-data").attr("title",String.format("{0} ({1})",f.activeCalendar.date.Label,n.count)))})},scroll:function(t){function o(){n.fetchOnDemand();u.updateHeader(l);pt(i)}var s=this,h=t.date,u=s.calendar,i=u.scrollable(),c=t.view.closest("div.app-presenter"),l=c.data("cal-header"),r=u.getBlockByDate(t.view,t.date),e,f;r&&(r=r.find('div.app-calendar-month[data-cal-month="'+h.getMonth()+'"]'),e=i.find(".app-presenter-instruction"),f=r.offset().top+i.scrollTop()-i.offset().top-e.outerHeight(),t.animate?n.animatedScroll(i,f,o):(n.scroll(i,f),o()))},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-yearview"),t;i.length&&(t=i.find("div.app-calendar-year.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-has-data").removeClass("app-has-data").attr("title",null))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},getNextDate:function(n,t){var r=this.calendar,f=r.getMostVisibleBlock(),i=d(f),n,u;return i.setYear(i.getFullYear()+t),n=r.getVisibleView(),u=r.getBlockByDate(n,i),u.length||(t==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),i},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-yearview > .app-calendar-year")}};cr=function(n){this.calendar=n};cr.prototype={draw:function(n,t){var r=n.find(".app-calendar-agendaview");r.length||(r=i("app-calendar-agendaview").appendTo(n));var f=this,s=this.calendar,b=s.activeCalendar,k=s.dataView,v=r.closest(".app-echo").length>0,h=new Date(t),o=r.find(".app-calendar-agenda-list"),p=o.length&&r.is(".data-loaded"),w=r.closest(".app-wrapper"),y=w.find(".app-presenter-instruction"),c=r.find(".app-calendar-load-at-top"),l=r.find(".app-calendar-load-at-bottom");return v?r.height(s.echoMaxHeight):y.css("visibility","hidden"),p||(o.length||(o=a("app-calendar-agenda-list").hide().appendTo(r)),v||(c.length||(c=i("app-calendar-load-at-top").hide().prependTo(r),u("dv-load-at-top ui-btn").text(et.Loading).appendTo(c)),l.length||(l=i("app-calendar-load-at-bottom").hide().appendTo(r),u("dv-load-at-bottom ui-bt").text(et.Loading).appendTo(l)))),s.cache.clearAgenda(),f.minPage=0,f.maxPage=0,f.todayLoaded=!1,f.lastDate=h,f.loadData(r,h,0,function(n,i){f.loadData(r,h,-1,function(u,s){var a;o.empty();var it={"0":n["0"],"-1":u["-1"]},w=f.drawData(r,h,it),b=f.calendar.cache.select(1),k=f.calendar.cache.select(-2);if(o.show(),r.fadeIn("fast").css("height",""),v){var d=w[0],rt=w[1],g=i+s,nt=d+rt,p=s-d+1,tt=p+nt-1;nt!=g&&(a=footer.find(".dv-action-see-all"),a.empty(),footer.show(),e("app-btn-see-all").appendTo(a).text(gt.SeeAll).attr("title",gt.SeeAll),e("app-info").appendTo(a).attr({"data-start-index":p,"data-end-index":tt}).html(String.format(yi.ShowingItems,p,tt,g)))}else y.css("visibility",""),b&&b.length==0||l.show(),k&&k.length==0||c.show(),f.scroll({view:r,date:t})})}),r},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide()},getNextDate:function(n,t){var r=this.calendar.scrollable(),o=r.scrollTop(),u=this.calendar.getFirstVisibleBlock(r),s=n.find(".app-calendar-agenda-list li:not(.app-calendar-month-header)").first(),f,e,i;return d(u).getTime()==d(s).getTime()?(f=n.find(".dv-load-at-top"),f.is(":visible")&&f.trigger("vclick")):t==1&&o+r.height()>r[0].scrollHeight-20&&(e=n.find(".dv-load-at-bottom"),e.is(":visible")&&e.trigger("vclick")),i=t==1?u.next():u.prev(),i.is(".app-calendar-month-header")&&(i=t==1?i.next():i.prev()),i.length?d(i):d(u)},scroll:function(t){var o=this.calendar,u=t.view||o.getVisibleView(),f=t.date,e,s;if(!u.hasClass("data-loaded")){this.draw(u.closest(".app-calendar"),f);return}var r=o.scrollable(),c=u.closest(".app-presenter"),v=c.data("cal-header"),i=o.getBlockByDate(u,f),h=this.getBlocks().first(),l=d(h),a=r.find(".app-presenter-instruction");if(i.length)i=i.closest(".app-agenda-day-list");else for(i=h;i.length&&d(i)<=f;)i=i.next(),i.is(".app-calendar-month-header")&&(i=i.next());i.length&&(e=0,s=function(){n.fetchOnDemand();pt(r)},tr(f,l)||(e=r.scrollTop()+i.offset().top-r.offset().top-a.height()),t.animate?n.animatedScroll(r,e,s):(n.scroll(r,e),s()))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},clear:function(n){n||(n=this.calendar.getViews().filter(".app-calendar-agendaview"));n.removeClass("data-loaded");n.find(".app-calendar-load-at-top, .app-calendar-load-at-bottom").hide();this.todayLoaded=!1;this.calendar.cache.clearAgenda()},loadData:function(n,i,r,u){var l;i||(i=this.lastDate);var e=this,f=e.calendar,s=f.activeCalendar,h=f.dataView,y=n.closest(".app-echo").length>0,p=n.find(".app-calendar-agenda-list"),c=r<0,v=s.date.Name+(c?" desc":" asc"),o={},a=r>=0?r:Math.abs(r)-1;r>e.maxPage?e.maxPage=r:r<e.minPage&&(e.minPage=r);l=f.cache.select(r);l?(o[r]=l,u?u(o):e.drawData(n,i,o)):(f.loadingData=!0,t.execute({controller:h._controller,view:h._viewId,command:"Select",_filter:c?ri(h,s.date,s.end,null,i):ri(h,s.date,s.end,i,null),sort:v,pageSize:hi*2,pageIndex:a/2,requiresRowCount:!0,tags:h.get_tags(),includeRawResponse:!0,success:function(t){var l,v,s,h;(f.loadingData=!1,l=t.rawResponse.Rows,v=t.totalRowCount<=(a+1)*hi*2,f.mode=="agenda")&&(s=l.splice(0,hi),h=l,c?(s.reverse(),h.reverse(),f.cache.insert(r,s),f.cache.insert(r-1,h),v&&f.cache.insert(r-2,[])):(f.cache.insert(r,s),f.cache.insert(r+1,h),v&&f.cache.insert(r+2,[])),o[r]=s,u?u(o,t.totalRowCount):e.drawData(n,i,o,t.totalRowCount))},error:function(n){f.loadingData=!1;t.alert(String.format("{0}",n.get_message()))}}))},drawData:function(t,r,u){function ni(n,t){var b=d&&n[d.Index],u=n[oi],f=n[kt],o=dt!==undefined&&n[dt],p=vt!==undefined&&n[vt],k=h.colorMap.className(p),w=y.getDayList(l,u,t?"prepend":"append"),r=s().attr("data-cal-page",ct),g=e("app-event-time").appendTo(r),c=it(u),v=i("app-event").text(f?f:ut.Data.NullValueInForms).data("data-context",n).appendTo(r);return v.attr("title",a.getEventTitle(u,o,f,p)).addClass(k),ft&&ft==b&&v.addClass("app-calendar-selected"),o&&(c+=" - "+it(o)),g.text(c),i("app-event-time").text(c).appendTo(v),t?r.prependTo(w):r.appendTo(w),r}var y=this,a=y.calendar,l=t.find(".app-calendar-agenda-list"),fi=a.scrollable(),ei=t.closest(".app-echo").length>0,h=a.activeCalendar,bt=a.dataView,oi=h.date.Index,kt=h.text.Index,vt=h.color&&h.color.Index,dt=h.end&&h.end.Index,d=a.dataView._keyFields[0],gt=a.dataView.extension().commandRow(),ft=gt?gt[d.Index]:null,et=a.getMostVisibleBlock(),si=et?et.position().top:0,p,yt,ht,tt,pt,wt,ct,rt,lt,v,w,ii;if(h.text.AliasName&&h.text.AliasName.length&&(p=bt.findField(h.text.AliasName),p&&(kt=p.Index)),h.color&&h.color.AliasName&&h.color.AliasName.length&&(p=bt.findField(h.color.AliasName),p&&(vt=p.Index)),ei){for(var w=y.calendar.cache.select(0),v=y.calendar.cache.select(-1),ci=v.length&&v[0][d.Name],b=0,g=0,k=!0,ot=!0,ti=a.echoMaxHeight,li=w.length+v.length,nt=0,c,st;(l.outerHeight(!0)<ti||nt<3)&&nt<li;){if(w.length<=b&&(k=!1),v.length<=g){if(w.length<=b)break;k=!0;ot=!1}yt=k&&!ot?w[b++]:v[g++];yt?(nt++,ni(yt,!k)):(k?b--:g--,k=!1);ot&&(ot=!1)}for(y.validateToday(l,l.children(),r),c=l.find(".app-agenda-day-list:first"),st=c.attr("data-cal-year"),c.length&&st!=(new Date).getFullYear().toString()&&o("h1").appendTo($('<li class="app-calendar-month-header" data-cal-year="'+st+'" data-cal-month="'+c.attr("data-cal-month")+'"/>').insertBefore(c)).text(st),c=l.find("li.app-agenda-day-list").first(),ht=!1,tt=c.find("li").first();l.outerHeight(!0)>ti&&nt>3;)pt=tt.find(".app-event").data("data-context"),wt=pt&&pt[d.Index],ft&&(wt==ft||wt==ci)?ht=!0:(tt.remove(),nt--,c.find("li").length==0&&(c.remove(),ht?b--:g--)),ht?(c=l.find("li.app-agenda-day-list").last(),tt=c.find("li").last()):(c=l.find("li.app-agenda-day-list").first(),tt=c.find("li").first());return[g,b]}for(ct in u)if(rt=u[ct],lt=ct<0,rt.length<hi&&(v=t.find(".app-calendar-load-at-top"),w=t.find(".app-calendar-load-at-bottom"),lt?v.hide():w.hide()),rt.length>0)for(ii in rt)ni(rt[ii],lt);var ri=a.getBlocks(),ui=[],ai=at.getFullYear();ri.each(function(){var u=$(this),i=u.attr("data-cal-year"),r=u.attr("data-cal-month"),e=i+"-"+r,n;if(ui[e])return!0;for(monthHeader=t.find(String.format('li.app-calendar-month-header[data-cal-year="{0}"][data-cal-month="{1}"]',i,r)),monthHeader.length||(monthHeader=$(String.format('<li class="app-calendar-month-header ui-btn" data-cal-year="{0}" data-cal-month="{1}"><h1>{2}<\/h1><\/li>',i,r,f.MonthNames[r])).insertBefore(u),i!=ai&&monthHeader.find("h1").text(f.MonthNames[r]+" "+i)),n=u.prev();n.length;){if(n.attr("data-cal-year")!=i||n.attr("data-cal-month")!=r){monthHeader.insertBefore(n.next());break}n=n.prev()}ui[e]=!0});y.validateToday(l,ri,r);t.addClass("data-loaded");et&&lt&&n.scroll(fi,et.position().top-si)},validateToday:function(n,t,i){var u,y,h;if(!this.todayLoaded){var c=t.first(),p=c.length?d(c):i,l=t.last(),w=l.length?d(l):i,b=p<ni&&ni<w,r,o;if(b||yt(i)){if(this.todayLoaded=!0,u=this.getDayList(n,ni,"search"),u.find(".app-time-line-container").length)return;var k=u.parents("li[data-cal-year]"),a=new Date,f=s("app-time-line-container").appendTo(u),v=this.calendar,g=v.dataView.findField(v.activeCalendar.date.Name).Index;for(e("app-event-time").text(it(a)).appendTo(f),timeLine=$('<div class="current-time-line"><div class="dot">&nbsp;<\/div><\/div>').appendTo(f),k.addClass("app-has-current-day"),r=f.prev();r.length;){if(y=r.find(".app-event"),h=y.data("data-context"),h&&h[g]>a)o=r;else break;r=r.prev()}o&&f.insertBefore(o)}}},removeData:function(n,t){n.find('.app-calendar-agenda-list li[data-cal-page="'+t+'"]').remove();t==this.maxPage?(n.find(".app-calendar-load-at-bottom .ui-btn").addClass("dv-load-at-bottom").text(et.Loading).show(),this.maxPage--):t==this.minPage&&(n.find(".app-calendar-load-at-top .ui-btn").addClass("dv-load-at-top").text(et.Loading).show(),this.minPage++);this.removeEmptyRows(n)},getDayList:function(n,t,r){var h=this.calendar.getBlockByDate(n,t),e,w,v,c;if(!h.length){var u=s("app-agenda-day-list").attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",t.getDate()),y=f.AbbreviatedDayNames[t.getDay()],b=$(String.format('<h2 class="ui-btn"><span class="app-calendar-daynumbig">{2}<\/span><span class="app-calendar-dayname">{0}<\/span> <span class="app-calendar-monthname">{1}<\/span> <span class="app-calendar-daynum">{2}<\/span><\/h2>',y,f.AbbreviatedMonthNames[t.getMonth()],t.getDate())).appendTo(u).attr("title",String.format("{0:"+f.LongDatePattern+"}",t)),p=i("app-calendar-day").appendTo(u),o=new Date,l=new Date;if(o.setDate(o.getDate()-1),l.setDate(o.getDate()+1),yt(t)?u.addClass("app-calendar-agenda-today"):tr(t,o)?u.addClass("app-calendar-agenda-yesterday"):tr(t,l)&&u.addClass("app-calendar-agenda-tomorrow"),r=="prepend")u.prependTo(n);else if(r=="append")u.appendTo(n);else{for(e=n.find("li[data-cal-year]:first"),c=!1;e.length;){if(v=d(e),t<v){u.insertBefore(e);c=!0;break}w=e;e=e.next()}c||u.appendTo(n)}h=a().appendTo(p);vt(u)}return h},removeEmptyRows:function(n){n.find(".app-calendar-agenda-list > li").each(function(){var t=$(this),f=t.is(".app-calendar-month-header"),i=d(t),r,u;f?(r=n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day]',i.getFullYear(),i.getMonth())),r.length==0&&t.remove()):(u=t.find("ul .app-event"),u.length==0&&t.remove())})},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-agendaview > .app-calendar-agenda-list > li:not(.app-calendar-month-header)")}};n.presenter("register",{name:"calendar",icon:function(){return"calendar"},text:function(){return nt.Text},supports:fu,show:function(n){var i=t.find(n.id);i&&i.calendar&&i.calendar.show(n)},hide:function(n){var t=h();t&&t.calendar&&t.calendar.hide(n)},dispose:function(n){var t=h();t&&t.calendar&&(t.calendar.dispose(n),delete t.calendar)}});tt=n.CalendarInput=function(u,f){function nt(){var h,n,u;if(o.tagged("calendar-input-disabled"))return!1;if(h=a.closest(".app-wrapper"),n=r.find(".app-calendar-cover"),e.length||(e=f.container=i("app-calendar-plugin-container app-data-input-helper").hide().appendTo(r),i("ui-btn ui-btn-icon-notext app-calendar-btn-close material-icon").appendTo(e).attr("title",ut.ModalPopup.Close)),n.length||(n=i("app-calendar-cover",'style="display:none"').appendTo(r)),e.data("data-input",a),u=o.DataFormatString=="{0:t}"||o.DataFormatString=="{0:T}",f.showTime=!!(o.TimeFmtStr||u),f.hideDate=u,o.tagged("calendar-input-future")&&(f.limitStart=new Date,f.limitStart.setHours(0,0,0,0)),wt(f.date)||(s&&s.length&&(f.date=v.convertStringToFieldValue(o,s.val())),wt(f.date)||(f.date=new Date)),e.data("select-date",f.date),!e.is(".app-hidden")){f.onselect=function(n){var i,r;n.date.setSeconds(0,0);i=n.target.closest(".app-month-container");i.length&&(ct(i,n.date),i.find(".app-selected").removeClass("app-selected"),lt(e,n.date).addClass("app-selected"),l());e.data("select-date",n.date);e.find(".app-calendar-action-bar:visible").length||(r=n.dataView.findField(d),r&&(k(n.dataView,r,s,n.date),n.endField&&(!r.TimeFmtStr||n.oldTimeMode=="Minute"&&n.target.closest(".app-time-selector").length)&&setTimeout(function(){s.blur();t.input.execute({dataView:v,values:[{name:n.endField,value:n.date}]});setTimeout(function(){h.find(String.format('[data-field="{0}"]',n.endField)).first().trigger("vclick")},10)},250)),n.mode||e.find(".app-time-container:visible").length||(tt.ignoreShow=!0,it()))};f.onrefresh=function(n){n.monthContainer.find(".app-selected").removeClass("app-selected");var t=n.container.data("select-date")||n.date;wt(t)&&lt(n.monthContainer,t).addClass("app-selected")};f.attachCallbacks=!0;s&&s.attr("data-datepicker-attached",!0);r.on("mousedown",b);g("attach",rt(f))}}function w(t){if(!f.modal&&h&&!t)return $(".app-data-input").trigger("blur"),setTimeout(w,300,!0),!0;var d=r.find(".app-calendar-cover"),i,c,u=n.screen(),o=u.width,l=u.height,v=o<=480&&l<=480||p,s=h||v,g=n.toWidth("xs")>=o,nt=g&&o<l;f.date&&e.data("select-date",f.date);e.toggleClass("app-calendar-wide",!nt);e.toggleClass("app-calendar-comfortable",!nt&&!g);e.toggleClass("app-calendar-show-bar",s);var y=e.outerHeight(),k=e.outerWidth(),b=a.offset();return v||(c=b.left,c+k>=+o+u.left-1&&(c=o+u.left-k-10),h?(i=b.top-y,i<u.top&&(i=b.top+a.outerHeight(),i+y>l+u.top&&(v=s=!0))):(i=b.top+a.outerHeight()+12,i+y>l+u.top&&(i-=y+a.outerHeight()+14,i<u.top&&(v=s=h=!0,e.addClass("app-calendar-show-bar"))))),e.toggleClass("app-calendar-show-bar",s),s?(h||(tt.ignoreHide=!0,$(".app-data-input").trigger("blur")),d.show()):d.hide(),v&&(i=u.top+(l-y)/2,c=u.left+(o-k)/2),e.css({top:i,left:c}),p?e.fadeIn("fast"):e.show(),s}function b(n){var t=$(n.target);t.closest('.app-input-text, .app-calendar-plugin-container, [data-field="'+d+'"]').length||(r.off("mousedown",b),tt("hide",{container:e}))}function k(n,i,r,u){var o=wt(u),f,e;o||i.AllowNulls||(u=new Date);h||!r||r.parent().length==0?(t.input.execute({dataView:n,values:[{name:i.Name,value:u}]}),h||setTimeout(function(){tt.ignoreShow=!0;t.input.focus({dataView:n,fieldName:i.Name})},50)):(f=i.format(u),e=r.data("placeholder"),r.val(f),h||r.focus()[0].setSelectionRange(f.length,f.length),e&&e.css("display","none"),r.closest("[data-control]").find(".app-control-inner").text(f).removeData("last-smart-text"))}function it(){tt.ignoreHide?tt.ignoreHide=!1:(c(".app-control-inner .app-cursor").remove(),e.hide(),$(".app-calendar-cover").hide(),r.off("mousedown",b),s&&s.select())}function rt(n){var r,u,i,t,e;if(n.renderTime=!0,n.excludeKeyFieldsFromFilter=!0,n.queryData=function(n,t){return n&&n.tagged("calendar-input-data-none")?!1:n&&n.Name!=t||!n&&t?!1:!0},n.limitStart=!1,o)for(r=v.calendar&&v.calendar.calendars||rr(v),u=r.length,i=0;i<u;i++)t=r[i],t.end&&(o.Name==t.date.Name?f.endField=t.end.Name:o.Name==t.end.Name&&(f.startField=t.date.Name,e=v.editRow(),f.limitStart=new Date(e[t.date.Index]),f.limitStart.setHours(0,0,0,0)));return n}if(tt.ignoreShow)return tt.ignoreShow=!1,!1;f||(f={});f.container||(f.container=r.find(".app-calendar-plugin-container"));var s=f.input,e=f.container,a=f.inputContainer||e&&e.data("data-input")||s&&s.closest("[data-input]"),o=f.field=f.field||a&&t.input.elementToField(a),v=f.dataView=f.dataView||o&&o._dataView,d=o&&o.Name,p=n.kiosk("ontop"),h=n.pointer("touch")||p||f.modal;switch(u){case"setInput":k(f.dataView,o,s,f.date);break;case"clear":k(f.dataView,o,s);break;case"hide":case"escape":it();break;case"focus":w();break;case"activate":return h||y.width()<=640&&y.height()<=640?(nt(),w()):!1;case"attach":return nt();default:return g(u,rt(f))}};tt.ignoreHide=!1;$(document).on("focus",".app-data-input[data-datepicker-attached]",function(n){var t=$(n.target);setTimeout(function(){t.closest(".app-has-focus").length&&tt("focus",{input:t})},32)}).on("input",".app-data-input[data-datepicker-attached]",function(n){var f=$(n.target),i=t.input.eventToField(n),e,u,o=r.find(".app-calendar-plugin-container");i&&(e=i._dataView,u=pu(i,f.val()),wt(u)&&(o.data("select-date",u),tt("setDate",{input:f,date:u,dataView:e,container:o,showTime:!!i.TimeFmtStr})))}).on("remove.input.app",".app-data-input[data-datepicker-attached]",function(){tt("hide")});g=function(r,e){function ni(){return v.calendar?v.calendar.activeCalendar:rr(v)[0]}function ti(n){return[f.MonthNames[n.getMonth()]+" "+n.getFullYearText(),f.AbbreviatedMonthNames[n.getMonth()]+" "+n.getFullYearText()]}function pt(){var n=d(l);return y.closest(".app-calendar-show-time").length&&ui(w,n),n}function fi(n,t,r){var o,u,c,s,e,h;for(n.empty(),o="<table><thead>",r&&(u=i().appendTo(n),c=ti(t),u.text(c[0]),u[0].scrollWidth>u.innerWidth()&&u.text(c[1])),s=0;s<7;s++){var l=ii[s],a=f.ShortestDayNames[l],v=f.DayNames[l];o+='<th title="'+v+'">'+a+"<\/th>"}o+="<\/thead><tbody>"+iu(t.getFullYear(),t.getMonth(),!0)+"<\/tbody><\/table>";e=$(o).appendTo(n);n.is(".app-first-month")||e.find("td.app-prev-month").addClass("app-day-hidden");n.is(".app-last-month")||e.find("td.app-next-month").addClass("app-day-hidden");e.find("tr").filter(function(){return!$(this).find("td:not(.app-day-hidden), th").length}).addClass("app-week-hidden");h=e.find("td.app-current-day");h.length&&h.html('<span class="app-current-day">'+h.text()+"<\/span>");ct(n,t)}function bt(n,t,i){var r=/(\d+), (\d+)/;$(i).each(function(){var f=this[1],i=this[0],u;if(f&&f!=0&&(i.indexOf(", ")<0&&(i=i+", "+i),u=r.exec(i),u)){var e=parseInt(u[1],10)-1,o=u[2],s=new Date(t.getFullYear(),e,o),h=lt(n,s);h.addClass("app-has-data").attr("title",String.format("{0} ({1})",p.Label,f))}})}function kt(n,t,i){var h=new Date(t),r,p,e,w;ci(n,h);var c=n.find(".app-hour-selector").hide(),l=n.find(".app-minute-selector").hide(),b=l.find("li"),o=yu(h),a=n.find(".app-time-hour"),v=n.find(".app-time-minute"),k=n.find(".app-time-ampm"),s=n.find(".app-time-hand").removeClass("app-inner-ring app-dot"),u=0,y=f.AMDesignator=="";a.text(o.hour);v.text(o.minute);n.find(".app-cal-selected").removeClass("app-cal-selected");switch(i){case"Hour":a.addClass("app-cal-selected");c.show();r=t.getHours();y?r<12&&s.addClass("app-inner-ring"):r>=12&&(r-=12);u=r*30;p=c.find("li");p.eq(r).addClass("app-cal-selected");break;case"Minute":v.addClass("app-cal-selected");l.show();e=t.getMinutes();u=e*6;e%5!=0?s.addClass("app-dot"):b.eq(e/5).addClass("app-cal-selected")}u>360&&(u-=360);s.css("transform","rotate("+u+"deg)");y||(w=k.find("span"),w.eq(o.ampm==f.AMDesignator?0:1).addClass("app-cal-selected"))}function ft(){function oi(n,t){return o.is(":visible")?c().attr("id")!==li?!0:e.queryData&&!e.queryData(n,t)?!0:!1:!0}var hi=l.find(".app-scroll-inner"),tt=l.find(".app-scroll-column > div"),r=d(tt.eq(g)),ut=pt(),ci=s.getMonth(),u=y.find(".app-calendar-plugin-header div"),ni=a.find(".app-scroll-inner"),i=new Date(s),ti=e.reloadData,at,ii,ft,yt,h,wt,nt;isNaN(r.getTime())&&(r=new Date(s),r.setMonth(r.getMonth()-g,1));switch(b){case"":u.html(String.format(tu,f.MonthNames[s.getMonth()],s.getFullYearText(),f.MonthNames[s.getMonth()],s.getFullYearText()));at=u.find("a");ii=at.first().outerWidth()+at.eq(2).outerWidth();ii>u.innerWidth()-60&&u.html(String.format(tu,f.MonthNames[i.getMonth()],s.getFullYearText(),f.AbbreviatedMonthNames[i.getMonth()],s.getFullYearText()));(s.getFullYear()!=r.getFullYear()||s.getMonth()!=r.getMonth())&&(ti=!0,i.setMonth(i.getMonth()-g,1),tt.each(function(){var n=$(this);fi(n,i,!n.is(".app-first-month"));i.setMonth(i.getMonth()+1)}));ot||e.limitEnd?tt.each(function(){var t=$(this),n=d(t);t.find("td").filter(function(){var t=new Date(n),i=$(this);return(t.setMonth(i.closest("[data-cal-month]").attr("data-cal-month"),i.attr("data-cal-day")),i.is(".app-prev-month")?t.setMonth(n.getMonth()-1):i.is(".app-next-month")&&t.setMonth(n.getMonth()+1),ot&&t<ot)?!0:e.limitEnd&&t>e.limitEnd?!0:!1}).addClass("app-day-unselectable")}):tt.find(".app-day-unselectable").removeClass("app-day-unselectable");function ui(){hi.css("marginLeft","")}k&&k!=""?ai(a,l,null,ui):ui();setTimeout(function(){var n=l.height();n>0&&(l.height(n),a.height(n))});break;case"selectmonth":u.html(String.format('<a class="ui-btn app-year-picker">{0}<\/a>',i.getFullYearText()));i.setFullYear(i.getFullYear()-1);h=Math.floor(l.height()/3)-10;ft=function(){a.find(".app-scroll-column").each(function(){var t=$(this).empty(),n,r;for(ct(t,i),n=0;n<12;n++)r=$(String.format('<div class="app-select-month ui-btn" data-cal-month="{0}" title="{2}">{1}<\/div>',n,f.AbbreviatedMonthNames[n],f.MonthNames[n])).css({height:h,lineHeight:h+"px"}).appendTo(t),ut.getMonth()==n&&ut.getFullYear()==i.getFullYear()&&r.addClass("app-selected");vt(t);i.setFullYear(i.getFullYear()+1)});ni.css("marginLeft","")};k&&k!=""?k=="selectyear"?ai(a,a,ft):ft():ai(l,a,ft);break;case"selectyear":yt=i.getFullYearText();i.setFullYear(i.getFullYear()-12);h=Math.floor(l.height()/3)-10;wt=function(){a.find(".app-scroll-column").each(function(){var n=$(this).empty(),r,t;for(ct(n,i),t=0;t<12;t++)r=$(String.format('<div class="app-select-year ui-btn" data-cal-year="{0}">{1}<\/div>',i.getFullYear(),i.getFullYearText())).css({height:h,lineHeight:h+"px"}).appendTo(n),i.getFullYear()==ut.getFullYear()&&r.addClass("app-selected"),i.setFullYear(i.getFullYear()+1);vt(n)});ni.css("marginLeft",-y.width())};u.html(String.format('<a class="ui-btn app-year-range">{0} - {1}<\/span>',yt,yt+11));k!="selectyear"?ai(a,a,wt):wt()}st&&kt(w,s,it);var ei=o.data("calendar-onrefresh"),li=c().attr("id"),dt=p&&p.Name;if(ei&&ei({container:o,monthContainer:l,selectorContainer:a,timeContainer:w,dataView:v,mode:b,date:ut,startField:e.startField,endField:e.endField}),ti&&!e.hideDate&&!v._survey&&p.AllowQBE&&!(v._keyFields.length===1&&v._keyFields[0].Name==="sys_pk_")&&(e.container.is(".ui-panel-inner")||n.settings("dates.calendar.countEvents")||p.tagged("calendar-count-events"))){var ht=new Date(s.getFullYear(),s.getMonth()),si=String.format("{0}-{1}",ht.getFullYear(),ci),lt=et[p.Name],gt=l.find(".app-scroll-column").eq(1);gt.find(".app-has-data").removeClass("app-has-data").attr("title","");lt||(lt=et[p.Name]={});nt=lt[si];nt?bt(gt,ht,nt):(clearTimeout(pr),pr=setTimeout(function(){if(!oi(p,dt)){var f=[dt],n=new Date(ht),r=rt[n.getDay()],i,u={},e=v._keyFields.map(function(n){return n.Name});r!=0&&n.setDate(n.getDate()-r);i=new Date(n);i.setDate(i.getDate()+7+35*g);i.setSeconds(-1);u[p.Name]=["pivot-row1-month-raw","pivot-row2-day"];t.execute({controller:v._controller,command:"Pivot",view:v._viewId,_filter:ri(v,p,null,n,i,e),fieldFilter:f,sort:"",pivotDefinitions:u,tags:v.get_tags(),success:function(n){var t=n.Pivots.pivot0;t&&(nt=lt[si]=n.Pivots.pivot0.Data.slice(1),v.session("calendar-input-cache",et),oi(p,dt)||bt(gt,ht,nt))},error:function(n){t.alert(String.format("{0}",n.get_message()))}})}},300))}return y}function ei(){var et=!y.length,d,ot,tt,t,rt,k;if(et){y=i("app-calendar-plugin").prependTo(o);d=$('<div class="app-calendar-plugin-header"><div>&nbsp;<\/div><\/div>').appendTo(y);ot=new Date(s);u("app-calendar-plugin-loadleft ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-l").attr("title",ut.Pager.Previous).prependTo(d);u("app-calendar-plugin-loadright ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-r").attr("title",ut.Pager.Next).appendTo(d);l=i("app-month-container",'data-draggable="calendar-mini"').appendTo(y);var c=i("app-scroll-inner").appendTo(l),lt=i("app-scroll-column").appendTo(c),at=i("app-scroll-column").appendTo(c),yt=i("app-scroll-column").appendTo(c);if(a=i("app-date-selector-container",'data-draggable="calendar-mini" style="display:none"').appendTo(y),$('<div class="app-scroll-inner"><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><\/div>').appendTo(a),e.renderTime){w=$('<div class="app-time-container"><div class="app-time-header"><span class="app-time-hour app-cal-selected">12<\/span>:<span class="app-time-minute">00<\/span> <span class="app-time-ampm"><\/span><\/div> <div class="app-time-selector" data-draggable="calendar-mini-hand"><div class="app-hour-selector"><ul class="app-hour-list">'+(f.AMDesignator==""?"<li>00<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li><li>12<\/li><li>13<\/li><li>14<\/li><li>15<\/li><li>16<\/li><li>17<\/li><li>18<\/li><li>19<\/li><li>20<\/li><li>21<\/li><li>22<\/li><li>23<\/li>":"<li>12<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li>")+'<\/ul><\/div><div class="app-minute-selector" style="display: none"><ul class="app-minute-list"><li>00<\/li><li>05<\/li><li>10<\/li><li>15<\/li><li>20<\/li><li>25<\/li><li>30<\/li><li>35<\/li><li>40<\/li><li>45<\/li><li>50<\/li><li>55<\/li><\/ul><\/div><span class="app-time-hand app-transition"><span><\/span><\/span><\/div><\/div>').appendTo(o);var pt=w.find(".app-time-selector"),ht=w.find(".app-time-ampm"),r=pt.height()/2,v=r*.815,wt=f.AMDesignator==""?r*.55:v,bt=w.find(".app-hour-list li"),kt=w.find(".app-minute-list li"),ni=f.AMDesignator?12:24,h;for(t=0;t<ni;t++)h=t*30/57.2958-Math.PI/2,tt=t>=12?v:wt,bt.eq(t).css({top:r+tt*Math.sin(h),left:r+tt*Math.cos(h)});for(t=0;t<12;t++)h=t*30/57.2958-Math.PI/2,kt.eq(t).css({top:r+v*Math.sin(h),left:r+v*Math.cos(h)});f.AMDesignator?ht.html("<span>"+f.AMDesignator+"<\/span><br/><span>"+f.PMDesignator+"<\/span>"):ht.hide()}e.hideActionBar||(rt=['<a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-ok">'+ut.ModalPopup.OkButton+"<\/a>",'<a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-cancel">'+ut.ModalPopup.CancelButton+"<\/a>",'<a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-clear"><\/a>'],n.settings("ui.actions.reverse")==!0&&rt.reverse(),dt=$('<div class="app-calendar-action-bar">'+rt.join("")+"<\/div>").appendTo(o));s.setMonth(s.getMonth()-g,1);k=function(n){for(var r,t=0;t<g;t++)r=i().appendTo(n),t==0&&r.addClass("app-first-month"),t==g-1&&r.addClass("app-last-month"),s.setMonth(s.getMonth()+1)};k(lt);k(at);k(yt);vt(c);s=ot}return o.find(".app-calendar-btn-clear").text(p.AllowNulls?gt.LookupClearAction:nt.Today),st?o.addClass("app-calendar-show-time"):o.removeClass("app-calendar-show-time"),e.hideDate?o.addClass("app-calendar-hide-date"):o.removeClass("app-calendar-hide-date"),ct(l,s),ci(w,s),(e.attachCallbacks||et)&&(e.onrefresh&&o.data("calendar-onrefresh",e.onrefresh),e.onselect&&o.data("calendar-onselect",e.onselect),o.data("calendar-show-months",g),b="",o.data("calendar-mode",b),it="Hour",o.data("calendar-time-mode",it)),e.reloadData=!0,ft(),y}function oi(){var n=e.date,t;if(b==""?(t=vi(l,n),ct(l,n)):b=="selectmonth"?(t=a.find('.app-scroll-column[data-cal-year="'+n.getFullYear()+'"]'),ct(a,n)):b=="selectyear"&&(t=a.find('.app-scroll-column .app-select-year[data-cal-year="'+n.getFullYear()+'"]').parent(),ct(a,n)),t.length&&b==k){var r=t.closest(".app-scroll-inner"),u=t.position().left,i=parseInt(r.css("marginLeft"),10),f=i-u;Math.abs(f-i)<5?ft():r.stop().animate({marginLeft:i-u},ft)}else ft()}function si(){var u=e.event,i=e.target,r=o.data("calendar-onselect"),n=e.date,t=i&&i.closest("td");t&&t.length&&(n=b==""?d(l):d(a),t&&n.setFullYear(parseInt(t.attr("data-cal-year"),10),parseInt(t.attr("data-cal-month"),10),parseInt(t.attr("data-cal-day"),10)),y.closest(".app-calendar-show-time").length&&ui(w,n));r?r({container:y,monthContainer:l,selectorContainer:a,target:i,event:u,dataView:v,mode:b,timeMode:it,oldTimeMode:ht,showTime:st,date:n,startField:e.startField,endField:e.endField}):i.closest(".app-month-container").length&&(l.find(".app-selected").removeClass("app-selected"),lt(l,n).addClass("app-selected"));e.date=s=n;kt(w,n,it)}function hi(){v.session("calendar-input-cache",null);et={};e.reloadData=!0;ft()}function li(){v.session("calendar-input-cache",null);y.removeData();et=null;o.remove()}var o=e.container,tt;o.is(".app-calendar-plugin")&&(o=o.parent());var y=o.find(".app-calendar-plugin"),l=y.find(".app-month-container"),a=y.find(".app-date-selector-container"),w=o.find(".app-time-container"),dt=o.find(".app-calendar-action-bar"),k=o.data("calendar-mode"),b=e.mode!=undefined?e.mode:k||"",ht=o.data("calendar-time-mode"),it=e.timeMode||ht||"Hour",g=o.data("calendar-show-months")||e.months||1,v=e.dataView||h(),et=v.session("calendar-input-cache")||{},at=o.data("calendar-field"),p=e.field||at||ni().date,yt=o.data("calendar-limit-start"),ot=e.limitStart===undefined?yt:e.limitStart,st=e.showTime,s=new Date(e.date);s&&wt(s)||(s=d(l),st&&ui(w,s));b!=k&&o.data("calendar-mode",b);it!=ht&&o.data("calendar-time-mode",it);yt!=ot&&o.data("calendar-limit-start",ot);at!=p&&o.data("calendar-field",p);e.months&&o.data("calendar-show-months",e.months);switch(r){case"attach":tt=ei();break;case"destroy":tt=li();break;case"refresh":tt=ft();break;case"setDate":tt=oi();break;case"getDate":tt=pt();break;case"click":tt=si();break;case"clearCache":tt=hi();break;default:t.alert('Attempted to run CalendarControl("'+r+'").')}return tt};lr=function(n,t){this.dataView=n;this.calendar=n.calendar;this.calendars=t};lr.prototype={attach:function(t){var r=this.dataView,o=this,v,i,s,h;if(this.calendar||(this.calendar=this.dataView.calendar),!r.get_isTagged("calendar-mini-disabled")){r.get_isTagged("calendar-mini-twomonths")&&(this.showMonths=2);var f=this.calendar?this.calendar.navigateDate||this.calendar.lastDate:null,c=r.calendar.activeCalendar||r.calendar.calendars[Object.keys(r.calendar.calendars)[0]],l=c.date,a=r.extension().commandRow();if(f=a?new Date(a[l.Index]):null,(!f||isNaN(f.getTime()))&&(f=new Date),v=t.find(".app-calendar-plugin").length>0,i=g("attach",{dataView:this.dataView,container:t.find(".ui-panel-inner"),date:f,months:this.showMonths,mode:"",hideActionBar:!0,onselect:function(t){var f=t.target,a=t.container,e=t.dataView,ut=t.mode,r=t.date,p=f.closest("table"),s=f.closest("tr"),w=a.find("tr.app-selected"),k=a.find("td.app-selected"),v=s.hasClass("app-selected"),it=f.hasClass("app-selected"),y=b(e),d=y.find(".app-calendar"),h="",tt=d.length&&d.is(":visible"),c=e.calendar,u=f,i,l;if(tt){switch(c.mode){case"year":i="Month";u=p.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7});break;case"month":v?(i="Week",u=s):(i="Month",u=p.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}));break;case"week":v?i="Day":(i="Week",u=s);break;case"day":it?(i="Week",u=s):i="Day";break;case"agenda":i="Agenda";c.animate=!0;c.enhancePrecision=!0}i=="Week"&&r.setDate(r.getDate()-rt[r.getDay()])}else!k.length||f.is(".app-selected")?w.length&&v?h="=":(r.setDate(r.getDate()-rt[r.getDay()]),l=new Date(r),l.setDate(r.getDate()+7),l.setSeconds(-1),h="$between$",u=s):h="=";w.add(k).removeClass("app-selected");u.addClass("ui-btn-active app-selected");setTimeout(function(){if(u.removeClass("ui-btn-active"),tt){if(e.calendar.navigateDate=new Date(r),i.toLowerCase()==c.mode)n.presenter("show",{id:e._id,name:"calendar",container:y});else{var t=dt(y.parent().find(".app-bar-header .app-bar-calendar"),nt[i]);t&&t.trigger("vclick")}g("refresh",{container:a,dataView:e})}else o.filter(h,r,l)},ki)},onrefresh:function(n){var u=n.container,t=n.monthContainer,f=t.find(".app-scroll-column > div"),y=n.selectorContainer,i=n.dataView,p=n.mode,w=n.date,e=u.find(".app-calendar-plugin-fieldselector"),r=o.getActiveCalendar().date,a=r.Label,s=e.find(".app-icon"),h=i._filter,c=b(i),l=c.find(".app-calendar"),v=l.length&&l.is(":visible"),k=i.calendar;e.find(".text").text(a);clearTimeout(dr);dr=setTimeout(function(){var l,a,e,n;if(s.css("opacity","0"),o.filtered=!1,v){if(u.is(":visible")){if(f.find(".app-selected").removeClass("app-selected"),l=i.calendar,a=l.getMostVisibleBlock(c),!a)return;if(e=d(a),n=vi(t,e),!n||!n.length)return;switch(l.mode){case"year":case"month":n.find("table tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}).addClass("app-selected");break;case"week":lt(n,e).parent().addClass("app-selected");break;case"day":lt(n,e).addClass("app-selected")}}}else f.find(".app-selected").removeClass("app-selected"),h.length&&$(h).each(function(){var h=this,u,l,n;if(h.startsWith(r.Name)){if(u=/(\w+):(=|\$between\$)(%js%"(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z?)")/.exec(h),!u)return!1;s.css("opacity","1");o.filtered=!0;var f=i.convertStringToFieldValue(r,u[3]),a=vi(t,f),e=new Date(f),c=u[2]=="=";return(e.setDate(f.getDate()+(c?1:7)),e.setSeconds(-1),l=vi(t,e),!a.length&&!l.length)?!0:(n=lt(t,f).add(lt(t,e)),n&&n.length&&(c?n.addClass("app-selected"):n.parent().addClass("app-selected")),!1)}})},450)}}),i.addClass("app-show-request").removeClass("app-hide-request"),!v){$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-calendar-plugin-fieldselector"><span class="app-icon material-icon" style="opacity:0">filter_list<\/span><span class="text">'+l.Label+"<\/span><\/a>").appendTo(i);s=$('<div class="app-calendar-color-legend"><p class="app-item-desc app-item-desc-before"><\/p><ol><\/ol><\/div>').attr("data-calendar-for",c.name).appendTo(i).hide();h=u("ui-btn ui-btn-icon-none app-has-droparrow app-legend-toggle").appendTo(s);k("app-item-desc app-item-desc-after").appendTo(s);e("app-see-more").text(ut.Mobile.More).appendTo(h);e("app-see-less").text(nt.Less).appendTo(h);i.on("show.sidebar.app",function(){var n=i.find(".app-month-container");n.length&&n.find(".app-scroll-inner").css("marginLeft","")})}return i}},refresh:function(){g("refresh",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},getActiveCalendar:function(){return this.calendar?this.calendar.activeCalendar:this.calendars[Object.keys(this.calendars)[0]]},clearCache:function(){g("clearCache",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},filterWithoutField:function(n){var t=this.getActiveCalendar().date.Name;return n.filter(function(n){return!n.startsWith(t)}).join("")},filter:function(t,i,r){var f=this,u=f.dataView,e=f.getActiveCalendar().date,o;u.extension()._instructed=!1;f.filtering=!0;switch(t){case"=":u.applyFieldFilter(e.Index,"=",[i]);break;case"$between$":u.applyFieldFilter(e.Index,"$between",[i,r]);break;case"clear":u.removeFromFilter(e);u.sync()}f.filtering=!1;o=g("refresh",{container:n.sidebar().find(".ui-panel-inner"),dataView:this.dataView})}};$(document).on("vclick",".app-calendar-color-legend",function(t){var f=$(t.target),ut=n.sidebar(),g,it,s,c,y,rt;if(f.is(".app-calendar-color-legend ol li, .app-calendar-color-legend ol li span")){t=f.is(".app-event")?f:f.find(".app-event");var et=h(),u=et.calendar,l=u.activeCalendar.colorMap,ot=l.getVisibleColors().map(function(n){return l.color(n).toString()}),p=t.attr("class").match(/app-event-color-(\w+)/),w=r.attr("class").match(/app-event-filter-color-(\w+)/),b=!0;if(p){var k=p[1],d="app-event-filter-color-"+k,st=r.is("."+d);if(w&&(g=w[1],b=ot.indexOf(g)!=-1),l.clearFilter(),!st&&b){r.addClass("app-event-filter "+d);var i=u.scrollable(),e=u.getFirstVisibleBlock(i),ht=u.getLastVisibleBlock(i),nt=i.position().top,ct=nt+i.height(),o,a,v=!1,tt=!1;do it=(u.mode==="agenda"?e.parent():e).find(".app-event.app-event-color-"+k),it.each(function(){var n=$(this),t=n.offset().top;if(t<nt)(u.mode=="month"||!o||o.offset().top<t)&&(o=n);else return t+n.height()>ct?(a=n,v=!0,!1):(tt=!0,v=!0,!1)}),e=e.next();while(!v&&e!=ht&&e.length);if(!tt&&(a||o)){s=a||o;switch(u.mode){case"day":case"week":y=s.data("data-context");y&&(rt=y[1],c=ft(rt,"find"));break;case"month":case"agenda":c=i.scrollTop()+s.offset().top-i.position().top+(s.height()-i.height())/2}c!=null&&n.animatedScroll(i,c)}}}return!1}if(f.is(".app-legend-toggle, .app-see-more, .app-see-less"))return n.callWithFeedback(f,function(){ut.find(".app-calendar-color-legend").toggleClass("app-see-all")}),!1}).on("vclick",".app-calendar-plugin-fieldselector",function(t){var k=$(t.target),o=k,l=o.closest(".app-calendar-plugin-fieldselector"),i=h(),r=i.calendarPlugin,s=o.closest(".app-calendar-plugin"),it=s.data("calendar-mode"),a=s.find(".app-month-container"),rt=s.find(".app-date-selector-container"),ut=o.closest("table"),e=[],b,c;r.filtered&&e.push({text:gt.ClearFilter,icon:"material-icon-clear",callback:function(){r.filter("clear")}},{});$(r.calendars).each(function(){var n=this,t=n.date,u=r.getActiveCalendar().date;e.push({text:t.Label,icon:t==u?"check":"",callback:function(){if(i.calendar.preventNavigate=!0,u!=t){i.removeFromFilter(u);r.calendar.activeCalendar.colorMap.clearFilter();r.calendar.activeCalendar=n;var f=i.viewProp("calendarConfig");f.activeCalendar=n.name;i.viewProp("calendarConfig",f);r.calendar.clear(!0);i.sync()}}})});e.push({},{text:nt.Today,icon:"material-icon-event",callback:function(){g("setDate",{container:a.closest(".ui-panel-inner"),date:new Date,dataView:i,reloadData:!0})}});var v=p(".app-wrapper"),y=v.find(".app-calendar"),tt=y.length&&y.is(":visible"),u,w=nt.Sync;return tt?(b=i.calendar.getMostVisibleBlock(v),u=d(b)):(c=i.extension().commandRow(),c&&(u=new Date(c[r.getActiveCalendar().date.Index]))),u&&!isNaN(u.getTime())&&(w=String.format("{0} {1}",f.MonthNames[u.getMonth()],u.getFullYearText()),e.push({text:w,icon:"recycle",callback:function(){g("setDate",{container:a.closest(".ui-panel-inner"),date:u,dataView:i})}})),n.callWithFeedback(l,function(){n.listPopup({anchor:l,iconPos:"left",items:e})}),!1}).on("touchmove",".app-calendar-plugin, .app-calendar-plugin-container",function(n){if($(n.target).closest("[data-draggable]").length==0)return n.preventDefault(),!1}).on("vclick mousedown",".app-calendar-plugin, .app-calendar-plugin-container",function(t){var p,o,nt,s,lt,w;if(t.preventDefault(),t.type=="mousedown")return!1;var it=$(t.target),i=it,e=h(),u=i.closest(".app-calendar-plugin").parent();u.length||(u=i.closest(".app-calendar-plugin-container"));var v=u.data("calendar-mode"),rt=u.find(".app-month-container"),at=u.find(".app-date-selector-container"),y=u.find(".app-time-container"),ut=i.closest("table"),ft=u.data("calendar-show-months"),b=y.find(".app-time-selector"),c=b.find(".app-time-hand"),r;if(r=v==""?ut.length?d(ut.parent()):d(rt):d(at),y.length&&ui(y,r),i.is("span.app-current-day")&&(it=i=i.closest("td")),i.is("td")){if(i.is(".app-day-unselectable"))return;if(rt.is(":animated"))return;g("click",{container:u,dataView:e,target:i,event:t})}else if(i.is(".app-calendar-plugin-loadleft,.app-calendar-plugin-loadright"))p=i.is(".app-calendar-plugin-loadleft"),v==""?(p?r.setMonth(r.getMonth()-ft,1):r.setMonth(r.getMonth()+ft,1),n.callWithFeedback(i,function(){g("setDate",{container:u,date:r,dataView:e})})):v=="selectmonth"?n.callWithFeedback(i,function(){r.setFullYear(r.getFullYear()+(p?-1:1));g("setDate",{container:u,date:r,dataView:e})}):v=="selectyear"&&n.callWithFeedback(i,function(){r.setFullYear(r.getFullYear()+(p?-12:12));g("setDate",{container:u,date:r,dataView:e})});else if(i.is(".app-month-picker"))n.callWithFeedback(i,function(){g("setDate",{container:u,date:r,mode:"selectmonth",dataView:e})});else if(i.is(".app-year-picker"))v!="selectyear"?(r.setFullYear(r.getFullYear()-5),n.callWithFeedback(i,function(){g("setDate",{container:u,date:r,mode:"selectyear",dataView:e})})):i.removeClass("ui-btn-active");else if(i.is(".app-select-month"))n.callWithFeedback(i,function(){r.setMonth(parseInt(i.attr("data-cal-month"),10));g("setDate",{container:u,date:r,mode:"",reloadData:!0,dataView:e})});else if(i.is(".app-select-year"))n.callWithFeedback(i,function(){r.setFullYear(parseInt(i.attr("data-cal-year"),10));g("setDate",{container:u,date:r,mode:"selectmonth",dataView:e})});else if(i.is(".app-time-hour"))n.callWithFeedback(i),c.removeClass("app-transition"),g("refresh",{container:u,timeMode:"Hour",showTime:!0,dataView:e}),setTimeout(function(){c.addClass("app-transition")}),l();else if(i.is(".app-time-minute"))n.callWithFeedback(i),c.removeClass("app-transition"),g("refresh",{container:u,timeMode:"Minute",showTime:!0,dataView:e}),setTimeout(function(){c.addClass("app-transition")}),l();else if(i.closest(".app-time-ampm").length)r=u.data("select-date")||r,o=r.getHours(),r.setHours(o+(o<12?12:-12)),ci(y,r),n.callWithFeedback(i),g("click",{container:u,dataView:e,target:i,event:t,date:r,showTime:!0}),l();else if(i.closest(".app-time-selector").length){r=u.data("select-date")||r;var et=f.AMDesignator=="",ot=b.offset(),vt=u.data("calendar-time-mode"),k=b.height()/2,st=n.lastTouch()||{x:t.pageX,y:t.pageY},ht=st.x-(k+ot.left),ct=st.y-(k+ot.top),yt=et?Math.sqrt(Math.pow(ht,2)+Math.pow(ct,2)):0,a=Math.atan2(ct,ht)+Math.PI/2;if(a<0&&(a+=Math.PI*2),a/=Math.PI*2,isNaN(a)){console.log("angle is NaN");return}l();switch(vt){case"Hour":o=Math.round(a*12);et?(nt=yt>k/1.5,nt&&(o+=12),o==24?o=12:o!=12||nt||(o=0)):(o==12&&(o=0),r.getHours()>=12&&(o+=12));r.setHours(o);ci(y,r);g("click",{container:u,dataView:e,target:i,event:t,date:r,showTime:!0,getDateFromInput:!0});c.one("transitionend",function(){c.removeClass("app-transition");g("click",{container:u,dataView:e,target:i,event:t,date:r,showTime:!0,timeMode:"Minute",getDateFromInput:!0});c.addClass("app-transition")});break;case"Minute":s=Math.round(a*60)%60;lt=Math.abs(r.getMinutes()-s);lt>=5&&(w=s%5,w>2?s+=5-w:s-=w);s>=60&&(s=0);r.setMinutes(s);g("click",{container:u,dataView:e,target:i,event:t,date:r,showTime:!0,getDateFromInput:!0})}}else i.is(".app-calendar-btn-ok")?(r=u.data("select-date"),n.callWithFeedback(i,function(){tt("setInput",{dataView:e,container:u,date:r,modal:!0});tt("hide",{container:u})})):i.is(".app-calendar-btn-cancel")?n.callWithFeedback(i,function(){tt("hide",{container:u})}):i.is(".app-calendar-btn-clear")?n.callWithFeedback(i,function(){tt("clear",{dataView:e,container:u,modal:!0});tt("hide",{container:u})}):i.is(".app-calendar-btn-close")&&n.callWithFeedback(i,function(){tt("hide",{container:u})});return!1}).on("touchstart mousedown pointerdown",".app-calendar-cover",function(n){return n.preventDefault(),tt("hide"),!1}).on("beforeactivatedatetime.input.app beforeactivatedate.input.app","[data-input]",function(n){if(n.namespace=="app.input"){var i={inputContainer:$(n.target)};i.field=t.input.elementToField(i.inputContainer);i.date=n.value.inputValueRaw;i.dataView=i.field._dataView;tt("activate",i)&&n.preventDefault()}}).on("beforefocus.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){var i={input:n.inputElement};i.inputContainer=$(n.target);i.field=t.input.elementToField(i.inputContainer);i.dataView=i.field._dataView;tt("attach",i)}).on("cancel.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){$(".app-data-input-helper").is(":visible")&&($(".app-data-input-helper").hide(),n.preventDefault())}).on("help.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){return n.inputElement.blur(),t.input.focus({lastFocused:!0}),!1});t.dragMan["calendar-mini"]={start:function(n){n.dir=n.target.closest(".ui-panel").length?"horizontal":"all";this._startX=n.x;this._maxMargin=-n.target.width()*2;this._inner=n.target.find(".app-scroll-inner").stop();this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10);this._cancelMarginLeft=this._originalMarginLeft;this._startTime=+new Date},move:function(n){var t=this._originalMarginLeft+n.x-this._startX;t<0&&t>this._maxMargin?this._inner.css("marginLeft",t):(this._startX=n.x,this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10))},end:function(n){var u=new Date-this._startTime<200,f,e,i,r;if(u&&Math.abs(this._startX-n.x)<10){this._inner.css("margin-left",this._originalMarginLeft);return}var o=n.target.closest(".app-calendar-plugin"),t=o.parent(),s=t.data("calendar-mode"),h=t.hasClass("app-calendar-show-time");columns=this._inner.find(".app-scroll-column");columnIndex=0;u?n.swipeRight||(columnIndex=2):(f=columns.first().width(),e=-parseInt(this._inner.css("marginLeft"),10),columnIndex=Math.round(e/f));i=columns.eq(columnIndex);r=d(s==""?i.children(":first"):i);h&&ui(t.find(".app-time-container"),r);g("setDate",{container:t,date:r})},cancel:function(){this._inner.animate({marginLeft:this._cancelMarginLeft})}};t.dragMan["calendar-mini-hand"]={start:function(n){n.dir="all";this._startX=n.x;this._startY=n.y;n._timeSelector=n.target.closest(".app-time-selector");n._outerContainer=n._timeSelector.closest(".app-calendar-plugin-container");n._hand=n._timeSelector.find(".app-time-hand").removeClass("app-transition");n._timeSelectorPos=n._timeSelector.offset();n._timeMode=n._outerContainer.data("calendar-time-mode");n._height=n._timeSelector.height()/2;n._is24hour=f.AMDesignator=="";n._date=n._outerContainer.data("select-date");n._isPM=!n._is24hour&&n._date.getHours()>=12},move:function(n){var f=n.x-(n._height+n._timeSelectorPos.left),e=n.y-(n._height+n._timeSelectorPos.top),o=n._is24hour?Math.sqrt(Math.pow(f,2)+Math.pow(e,2)):0,i=Math.atan2(e,f)+Math.PI/2,t,u,r;i<0&&(i+=Math.PI*2);i/=Math.PI*2;switch(n._timeMode){case"Hour":t=Math.round(i*12);n._is24hour?(u=o>n._height/1.5,u&&(t+=12),t==24?t=12:t!=12||u||(t=0)):(t==12&&(t=0),n._isPM&&(t+=12));n._date.setHours(t);break;case"Minute":r=Math.round(i*60);r==60&&(r=0);n._date.setMinutes(r)}g("click",{container:n._outerContainer,date:n._date,target:n.target,showTime:!0})},end:function(n){n._hand.addClass("app-transition");l()},cancel:function(n){n._hand.addClass("app-transition")}};ar=function(n,t,i){var r,u,f,e;i||(i={"null":0});r=this;u=t.color;r.dataView=n;r.calendar=t;r.count=0;u&&(f=$.Event("getcolormap.calendar.app",{dataView:n,colorField:u,colorMap:i}),$(document).trigger(f),i=f.colorMap);for(e in i)i.hasOwnProperty(e)&&typeof i[e]=="number"&&r.count++;r.map=i};ar.prototype={color:function(n){var t=this,i=this.map[n];return typeof i=="undefined"&&(i=this.map[n]=1+this.count%lu,this.count++,t.calendar.color&&(clearTimeout(kr),kr=setTimeout(function(){t.dataView.viewProp("calendarColorMap-"+t.calendar.color.Name,t.map);t.dataView.calendarPlugin.refresh(!1,!0)},1e3))),i},className:function(n){return"app-event-color-"+this.color(n)},load:function(t){var i=this;clearTimeout(br);br=setTimeout(function(){var c=n.sidebar(),r=c.find(".app-calendar-color-legend"),y=c.find("a.app-legend-toggle"),l=r.find("ol"),f=i.calendar,u=f?f.color:null,a,o,b,v;if(!f||!u||!c.is(":visible")){r.length&&i.hide();return}if(a=u.Label,o=0,t||l.is(":empty")||f.name!=r.attr("data-calendar-for")){var p=i.dataView.calendar.getFirstVisibleBlock(),h=i.getVisibleColors(),w=r.data("calendar-colors")||[];if(!p||!p.hasClass("data-loaded")&&i.dataView.calendar.mode!="agenda")return;if(h.length==w.length&&h.join("")==w.join(""))return;r.data("calendar-colors",h);l.empty();h.forEach(function(n){var r=i.className(n),f=n||ut.Data.NullValueInForms,t,h;u.Items&&u.Items.forEach(function(t){if(t[0]==n)return f=t[1],!1});r&&(t=s().text(f),h=e("app-event").addClass(r).appendTo(t),o++>=nu&&t.addClass("app-hidden"),t.appendTo(l));b=n});r.attr("data-calendar-for",f.name);u.AliasName&&u.AliasName.length&&(v=i.dataView.findField(u.AliasName),v&&(a=v.Label));r.find(".app-item-desc").text(a);o<=nu?y.addClass("app-hidden"):y.removeClass("app-hidden");o!=0&&f.color?r.removeClass("app-hidden"):r.addClass("app-hidden");i.show()}},450)},show:function(){var i=n.sidebar();if(i.is(":visible")&&this.dataView.calendar.mode!="year"){var t=i.find(".app-calendar-color-legend"),r=this.dataView.calendar.scrollable(),u=r.find(".app-calendar"),f=!t.is(":visible");!t.is(".app-hidden")&&u.is(":visible")&&t.find("ol li").length?f&&t.show():this.hide()}},hide:function(){var t=n.sidebar(),i=t.find(".app-calendar-color-legend");i.hide()},getVisibleColors:function(){var u=[],i=this.dataView.calendar,s=i.scrollable(),n=i.getFirstVisibleBlock(s),p=i.getLastVisibleBlock(s),f=i.mode=="agenda",h=i.activeCalendar.color,c=f?i.dataView.findField(h.AliasName||h.Name).Index:3,t,l,r,a,v,e,y,o;if(i.mode!="year")while(n&&n.length){if(t=n.data("calendar-colors"),!t&&(n.hasClass("data-loaded")||f)){if(t=[],l=d(n),f)a=n.parent().find(".app-event"),a.each(function(){var i=$(this).data("data-context"),n=i[c];t.indexOf(n)==-1&&t.push(n)});else{r=i.cache.select(l);for(v in r){e=r[v].rows||r.rows;for(y in e)o=e[y][c],t.indexOf(o)==-1&&t.push(o);if(i.mode.match(/day|week/))break}}n.data("calendar-colors",t)}if(t&&t.forEach(function(n){u.indexOf(n)==-1&&u.push(n)}),n[0]==p[0])break;n=n.next()}return u.sort()},clearFilter:function(){var n=["app-event-filter"],t=this.map;for(var i in t)n.push("app-event-filter-color-"+t[i]);r.removeClass(n.join(" "))}}}()})()