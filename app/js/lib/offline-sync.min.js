/*!
* Offline Sync 3.0
* Copyright 2018-2024 Code On Time LLC; Proprietary License; https://codeontime.com/documents/offlinesync-eula.pdf
*/
(function(){function o(n){if(arguments.length)n?ct||(ct=setInterval(o,50)):(clearInterval(ct),ct=null),gt=n;else{var t=gt;gt=null;typeof t=="function"&&t()}}function et(n,t){a.text=n+(t?String.format(" {0:p}",t):"");a()}function a(t){if(t===!0)clearInterval(a.interval),a.interval=setInterval(a,500);else if(t===!1)clearInterval(a.interval);else{var i,u;n.prevSyncDuration&&(u=n.prevSyncDuration,i=((new Date).getTime()-new Date(n.created).getTime())/n.prevSyncDuration,i>1&&(i=null));i?r.progress("show",{text:a.text,progress:i,estimate:u}):r.progress("text",{text:a.text})}}function vt(t,r,u){var o=arguments.length,e=n.blobs;return new Promise((n,s)=>{if(o===1)f.data.read(t).then(r=>{r.data?n(r.data):i.restful({url:t+"&t="+(new Date).getTime(),accept:"*/*",dataType:"response"}).then(i=>{var r;if(i.status===200){var u=i.headers.get("Content-Type"),e=i.headers.get("Content-Disposition"),h=i.headers.get("ETag"),o="file."+(u.split(";")[0]||"/dat").split(/\//)[1];e&&(r=e.match(/filename=(.+?)(;|$)/),r&&(o=r[1]));i.arrayBuffer().then(i=>{f.data.write(t,{name:o,type:u,size:i.byteLength,etag:h,data:i}).then(t=>{n(t.data)})}).catch(n=>{s(n)})}else s(i)}).catch(n=>{s(n)})});else{var h=e.indexOf(t);u&&h===-1&&e.push(t);f.data.read(t).then(i=>{var e=i.data;r?(e?e.new&&(r.new=!0):u&&(r.new=!0),f.data.write(t,r).then(t=>{n(t.data)})):f.data.delete(t).then(t=>{n(t.data)})})}})}function c(n,t){return n.match(si)||(ft[n]=t),t?i.host.data.write(n,t):i.host.data.delete(n)}function d(n){return c(n,null)}function b(n){var t=$.Deferred(),u=ft[n],r;return u?t.resolve(u):(r=at[n],r?r.push(t):(r=at[n]=[t],i.host.data.read(n).done(function(t){var i=at[n];delete at[n];ft[n]=t.data;i.forEach(function(n){n.resolve(t.data)})}))),t.promise()}function yt(n){var s=u.func(n.where.filter),i,f,e=n.from,r=n.limit||1,t=[],o=$.Deferred();for(r==="none"&&(r=e.length),i=0;i<e.length;i++)if(f=e[i],s.call(f,n.where.params)&&(t.push(f),t.length===r))break;return o.resolve(r===1?t.length?t[0]:null:t),o.promise()}function l(t){var r,u,s;if(t||(t={}),t.reconciled&&delete n.reconcile,r=t.changed,r){var h=$.Deferred(),a=[],v=[];for(u in r){var y=n.controllers.map[u],w=y.data,e=wt("d"),p=t.data[u];v.push(w);y.data=e;ft[e]=p;a.push(c(e,p))}return $.when.apply($,a).done(()=>{delete t.changed,l(t).then(()=>{h.resolve(n)}),v.forEach(n=>{d(n)})}),h.promise()}return t.reset?(s=$.Deferred(),i.userVar("prevSyncDuration",n.duration),c("OfflineSync.backup.json",n).then(()=>{d("OfflineSync.json").done(function(){f.data.clear("data").then(()=>{caches.delete("user").then(()=>{s.resolve()})})})}),s.promise()):(n.duration||(n.duration=(new Date).getTime()-new Date(n.created)),c("OfflineSync.json",n).then(()=>{o(null)}))}function s(t){return n?n.log.length+(t===!1?0:n.blobs.length):0}function hi(n){var i=s();return i?t.Pending+String.format(" ({0:n0})",i):n?t.Synced:""}function ci(n){var t=n.field;return t&&t._dataView||r.dataView()}function fr(n){var i=n.field,r=ci(n),u=n.controller||r._controller,t;return n.controller||(t=n.file||n.files,t.length&&(t=t[0]),n={field:i.Name,controller:u,file:t,keyField:r._keyFields[0].Name,key:n.key,handler:i.OnDemandHandler,apiVer:n.apiVer}),n}function li(n){var r,i=[],t;for(n.forEach(function(n,t){if(n.url){var f=lt.indexOf(n.url.substring(__baseUrl.length))>=0,u=n.children;u&&u.length&&(li(u)&&(f=!0),u.length||delete n.children);f?r=!0:i.push(t)}}),t=i.length-1;t>=0;t--)n.splice(i[t],1);return r}function pt(n){a(!1);r.progress("hide");n&&r.notify({text:n.message,duration:"long",force:!0})}function ai(t){n.controllers.push({name:t,meta:null,data:[],blobs:null})}function er(){for(var s=!1,f=0;f<n.controllers.length;f++){var t=n.controllers[f],r=t.meta!=null,u=typeof t.data=="string",o=t.blobs!=null;if(!r||!u||!o){r||u||o||(e={controller:t,pageIndex:0});r||ar();u||vi();r&&u&&!o&&pi();s=!0;break}}s||(a(!1),l().then(function(){i.storage.set("odpIsOffline",p());b("OfflineSync.backup.json").done(function(n){if(n!=null)try{n=JSON.parse(n);n.controllers.forEach(function(n){d(n.meta);d(n.data)});d("OfflineSync.backup.json")}catch(t){}});rr();ni("done")}))}function ni(t,i,u){function f(){r.progress("hide");ot.resolve()}s()&&ur();n.controllers.map={};n.controllers.forEach(function(t){n.controllers.map[t.name]=t});t?(g(t,u||"Done."),setTimeout(f,i||1500)):f()}function ti(n,t,u){r.progress("hide");i.alert(String.format("Error downloading {0} for {1}. {2}",t,n,u.toString())).then(lr)}function vi(){var n=e.controller,r=e.pageIndex,f=u._pageSize||100,s=n.name;et(String.format(t.DownloadingData,n.text||s),r?r*f/e.totalRowCount:0);i.execute({controller:s,view:"offline",pageSize:f,pageIndex:r,requiresRowCount:!r,odp:!1,background:!0,nativeDates:!1}).done(function(t){var h=t[s],i,u;r||(e.totalRowCount=e.rowCount=t.totalRowCount);n.data.push.apply(n.data,h);e.rowCount-=f;e.rowCount<=0?(i=wt("d"),u=n.data,e.data=u,c(i,u).then(function(){n.data=i;v(n)})):(e.pageIndex++,o(vi))}).fail(t=>ti(n.name,"data",t))}function or(n){var r=$.Deferred(),t=n.field,f,i;return t=u.controllers[n.controller]._map.fields[t],f=u.blobUrlFormatStrings(t.onDemandStyle),i=[],f.forEach(function(r,f){var e=String.format(r,t.onDemandHandler,n.key),o=$.Deferred();i.push(o.promise());u.convertBlob(f?u.toThumbnail(n,f):n,"arraybuffer",f).done(function(t,i){var r={url:e,data:t,path:e,type:i,size:t.byteLength};f||(r.sequence=ri(!1)-1,r.key=n.key,r.keyField=n.keyField,r.controller=n.controller,r.name=n.file.name,r.field=n.field,r.handler=n.handler,r.apiVer=n.apiVer);vt(e,r,!f).then(n=>{o.resolve(n)})})}),$.when.apply($,i).then(function(){r.resolve(n)}),r.promise()}function sr(n){et(String.format(t.DownloadingBlob,e.controller.name),e.blobCount++/e.totalBlobCount);var i=$.Deferred();return u.toDataUrl(n).done(function(){vt(n).then(n=>{i.resolve(n)})}),i.promise()}function yi(n){return n!=null&&!(typeof n=="string"&&n.match(/^null\|/))}function hr(n){var t;return n||(n=$.Deferred(),t=n.promise()),f.data.clear("blob").then(t=>{n.resolve(t)}),n.resolve(),t}function pi(){var t=e.controller,n=e.blobs,i=e.blobObjectIndex,r=e.data,f,c,s,y,h,l,a;if(n||(n=e.blobs=[],e.meta.fields.every(function(n){return n.isPrimaryKey&&(f=n.name),f==null}),f&&e.meta.fields.forEach(function(t){t.onDemand&&t.onDemandHandler&&n.push({field:t,pk:f})})),n.length){if(i==null){for(c=0,i=e.blobObjectIndex=0,s=0;s<r.length;s++)for(y=r[s],h=0;h<n.length;h++)l=n[h],yi(y[l.field.name])&&(c+=l.field.onDemandStyle!=="Link"?3:1);e.blobCount=0;e.totalBlobCount=c;t.blobs=!0}else i=++e.blobObjectIndex;i<r.length?(a=[],n.forEach(function(n){var t=n.field,e=t.onDemandHandler,f=r[i],o=f[n.pk];yi(f[t.name])&&u.blobUrlFormatStrings(t.onDemandStyle).forEach(function(n){a.push(sr(String.format(n,e,o)))})}),$.when.apply($,a).done(()=>{o(pi)}).fail(n=>ti(t,"blob",n))):v(t)}else t.blobs=!1,v(t)}function cr(){return(new Date).getTime()}function wt(t){return(t||"")+String.format("{0:d5}",n.fileCount++)+cr()+".json"}function lr(){b("OfflineSync.backup.json").done(function(t){if(t!=null)try{n=JSON.parse(t)}catch(r){n=null}n?l().then(function(){i.storage.set("odpIsOffline",p());ni("off",2e3,"Unable to synchronize with the cloud.")}):ir()})}function ii(t,i){var u=n.relationships,r=u[t];r||(r=u[t]=[]);r.indexOf(i)===-1&&r.push(i)}function ar(){var t=e.controller;i.restful({url:__servicePath+"/GetControllerList",method:"POST",dataType:"application/json",body:{controllers:[t.name]}}).then(i=>{var f,o;i=JSON.parse(i.d)[0];var s=e.meta=i.dataController,u=s.name,r=[];s.fields.forEach(function(n){var i=n.items,f=i&&i.dataController,t,o=n.dataView,e=n.type==="DataView"&&o&&o.controller;f&&(r.push(f),ii(f,u),t=i.targetController,t&&(r.push(t),ii(u,t)));e&&(r.push(e),ii(u,e))});r.length&&(f={},n.controllers.forEach(function(n){f[n.name]=!0}),r.forEach(function(n){f[n]||ai(n)}));o=wt("m");c(o,i).then(function(){t.meta=o;v(t)})}).catch(n=>ti(t.name,"metadata",n))}function wi(){var n=$('link[rel="manifest"');return n.length?n.attr("href"):null}function v(n){var e,f,u,s;ut?ut.length?(f=ut[0],u=i.resolveClientUrl("~/"+f.src),f.hash&&(u+="?h="+f.hash),et(String.format(t.DownloadingData,f.src)),ut.splice(0,1),caches.open("static").then(n=>{n.match(u).then(t=>{t?(h(!1),o(v)):(h(!0),fetch(u).then(t=>{h(!1),t.status===200?n.delete(u,{ignoreSearch:!0}).then(()=>{n.put(u,t.clone()).then(()=>{h(!1),o(v)})}):(h(!1),o(v))}).catch(n=>{h(!1),pt(n)}))})})):rt.length?(s=rt[0],et(String.format(t.DownloadingData,s)),rt.splice(0,1),h(!0),i.restful({url:__baseUrl+s,dataType:"response"}).then(n=>{n.status===200?caches.open("user").then(t=>{t.delete(n.url,{ignoreSearch:!0}).then(()=>{t.put(n.url,n.clone()).then(()=>{h(!1),o(v)})})}):(h(!1),o(v))}).catch(n=>{h(!1),pt(n)})):n&&(typeof n.data!="string"||typeof n.meta!="string")||o(er):(a(!0),e=wi(),e?fetch(e).then(n=>n.text()).then(n=>{n=JSON.parse(n),ut=n.offline_resources,o(v)}):r.notify({text:"Unable to sync. Missing manifest link.",duration:"long"}))}function ri(t){var i=r.settings("odp.transactions.scope")==="all"?0:n.sequence;return t!==!1&&n.sequence++,i}function vr(i){var f=i.dataView,v=i.changes,o=f.odp,y=f.get_view(),h=f.headerField(),w=f.row(),a={},e=o._log.slice(0),k={text:h&&w?h.text(w[h.Index]):null,source:y?y.Label:null,time:p(),log:e},d=ri(),b=$.Deferred();for(v&&e.splice(0,0,v);f.uploadNextBlob(f._lastArgs.Values,[]););return o._files.list.forEach(function(n){u.offline("saveBlob",n)}),u.offline("commitBlobs").then(function(i){if(i.forEach(function(n){a[n.controller]=!0}),e.forEach(function(n){a[n.controller]=!0;n.args.Sequence=d}),e.length){var u=wt("l");n.log.push(u);c(u,k)}l({data:o._data,changed:a}).then(function(){var i=s(!1),u=s()-i;(i===1||!i&&u===1)&&f._lastArgs.CommandName.match(/Insert|Update|Delete/)&&setTimeout(()=>{r.notify({text:t.OfflineState+"\n"+t.SyncLong,duration:"long",buttonEvent:"offlinesyncinfo.app",force:!0})},250);b.resolve(n)})}),b.promise()}function yr(){var n=$.Deferred();return s()?(g("circle"),setTimeout(function(){g("upload",t.Committing);kr().then(function(){ui(n)})},2e3)):n.resolve(),n.promise()}function pr(t){var i=$.Deferred(),e=t.Values,r=n.blobs,o,f=[],s=t.changeMap,h={};return r.length&&e&&(o=u.blobUrlFormatStrings(0),e.forEach(function(n){r.forEach(function(t,i){var e=$.Deferred();f.push(e.promise());vt(t).then(t=>{var v,f,l=n.Controller,a=n.Name,w=n.OldValue,y=n.NewValue;t&&t.controller===l&&t.keyField===a&&n.Modified&&w===t.key?(v=[],f=[],o.forEach(function(n){v.push(String.format(n,t.handler,t.key));f.push(String.format(n,t.handler,y))}),t.key=y,t.resolved=p(),t.url=f[0],t.path=t.url,s[l]=!0,r[i]=f[0],c(t.url,t).then(()=>{var n=[];v.forEach((t,i)=>{if(i>0){var r=$.Deferred(),u=f[i];n.push(r.promise());b(t).then(n=>{n.path=u,n.url=n.path,c(n.url,n).then(n=>{c(t,null).then(()=>{r.resolve(n)})})})}else c(t,null)});$.when.apply($,n).then(()=>{u.offline("query",{data:l}).then(function(n){var i={};i[a]=w;yt({from:n,where:{filter:"(params){return this."+a+"===params."+a+"}",params:i}}).then(function(i){i&&(i[t.field]=t.url?y.toString():null,h[l]=n);e.resolve()})})})})):e.resolve()})})})),f.length?$.when.apply($,f).then(()=>{l({data:h,changed:s}).then(function(){i.resolve()})}):i.resolve(),i.promise()}function wr(t){var e=$.Deferred(),r=[],o=[],s=t.Values,f=t.changeMap;for(var h in f)r.indexOf(h)===-1&&r.push(h);return s.forEach(function(t){var i=t.Controller,u;r.indexOf(i)===-1&&(r.push(i),f[i]=!0,u=n.relationships[i],u&&u.forEach(function(n){r.indexOf(n)===-1&&r.push(n);f[n]=!0}))}),r.forEach(function(t){var i=n.relationships[t];i&&i.forEach(function(n){r.indexOf(n)===-1&&o.push(n)})}),r=r.concat(o),u.getControllers(r).then(function(){var t=[];r.forEach(function(n){t.push(u.offline("query",{data:n}))});$.when.apply($,t).then(function(){for(var t={},h=arguments,c=[],o=0;o<h.length;o++)t[r[o]]=h[o]||[];s.forEach(function(i){var o=i.Name,r=i.Controller,e=n.relationships[r],s=$.Deferred();bi(r,o,i);e&&e.forEach(function(n){u.controllers[n].fields.forEach(function(t){var f=t.name,u=t.items;u&&u.dataController===r&&bi(n,f,i)})});c.push(s.promise());yt({from:t[r],where:{filter:"(fv){return this."+o+"==fv.OldValue}",params:i}}).then(function(n){if(n){n[o]=i.NewValue;var h=[];e&&e.forEach(function(n){u.controllers[n].fields.forEach(function(u){var o=u.name,s=u.items,e;s&&s.dataController===r&&(e=$.Deferred(),h.push(e.promise()),yt({from:t[n],where:{filter:"(fv){return this."+o+"==fv.OldValue}",params:i},limit:"none"}).then(function(t){t.forEach(function(t){t[o]=i.NewValue;f[n]=!0});e.resolve(t)}))})});$.when($,h).then(function(){s.resolve(n)})}else s.resolve(n)})});$.when.apply($,c).then(function(){var n=i.syncMap;Sys.Application.getComponents().forEach(function(t){var u=t._viewId,i=t._controller,r;i&&u&&i in f&&(r=n[i]||{},r[t._id+"_"+u]=!0,n[i]=r)});l({data:t,changed:f}).then(function(){e.resolve(t)})})})}),e.promise()}function bi(t,i,r){var f=r.OldValue,e=r.NewValue;n.log.forEach(function(n){var o=nt[n],r;o.log.forEach(function(n){if(n.controller===t){var o=n.args,a,s,h,v,c,l=f!=null?f.toString():f,y;o.Values.every(function(n){return n.Name===i&&("OldValue"in n&&n.OldValue==f&&(n.OldValue=e,r=!0),"NewValue"in n&&n.NewValue==f&&(n.NewValue=e,r=!0)),!r});h=o.SelectedValues;h&&(a=u.controllers[t],a._map.key[i]&&(a.key.forEach(function(n,t){n.name===i&&(s=t)}),s>=0&&h.every(function(n,t){return n=n.split(/,/g),n[s]===l&&(n[s]=e.toString(),h[t]=n.join(","),n=null),n})));l="%js%"+JSON.stringify(f);v=o.ExternalFilter;v&&v.forEach(function(n){n.Name===i&&n.Value===l&&(n.Value="%js%"+JSON.stringify(e))});c=o.Filter;c&&(y=c.indexOf(i+":="+l),y>=0&&(c[y]=i+":="+JSON.stringify(e)))}});r&&(o._changed=r)})}function ki(f){var e=f.uploadPendingBlobsDeferred,v=e,s=n.blobs,k=y.maxBlobs||1,h=[],c=f.blobInfo,w=[],b=[],a;return v||(e=$.Deferred()),s.length?(a=s[0],vt(a).then(v=>{if(v||b.push(0),v.sequence<=f.Sequence){var y=$.Deferred();h.push(y.promise());u.getControllers(v.controller).then(function(n){n=n[0];c||(c=f.blobInfo={index:0,count:s.length});w.push(String.format("{1} from {0}  to {2} ({3} of {4})",v.name,n._map.fields[v.field].label,n.label,++c.index,c.count));var t=new Blob([v.data],{name:v.name,type:v.type});i.uploadFileAjax({url:String.format("~/blob.ashx?{0}=u|{1}&_v={2}",v.handler,v.key,v.apiVer),files:t,keepThumbnails:!0,names:[v.name],progress:null}).then(function(){y.resolve({url:a,success:!0})}).fail(function(){y.resolve({url:a})})})}b.forEach(function(n){s.splice(n,1)});r.progress("text",{text:String.format(t.SyncUploadingFiles,w.join(", "))});h.length?$.when.apply($,h).then(function(){for(var y=arguments,r,u,c,w=[],a=[],i=0;i<y.length;i++)c=y[i],u=c.url,c.success?(v.committed=p(),delete v.sequence,r=s.indexOf(u),r!==-1&&s.splice(r,1)):(w.push(v.name||v.handler+v.key),a.push(u));a.length?(n.reconcile={errors:String.format(t.SyncUploadFailed,w.join(", ")),blobs:a},l().then(function(){e.resolve()})):l().then(function(){h.length>=k?(f.uploadPendingBlobsDeferred=e,o(()=>ki(f))):e.resolve()})}):e.resolve()})):e.resolve(),v?e:e.promise()}function br(t,i){var e=$.Deferred(),f=r.settings("odp.partialRefresh"),c=u.controllers,h=t.Index,o=[],s={};return n.refreshData||f===!1||t.Success==null?e.resolve():(f=f===!0?[]:f||[],i.forEach(function(n){var t=n.args.Controller;o.indexOf(t)<0&&o.push(t)}),u.getControllers(o).then(function(){var n=[];i.forEach(function(t,i){var o=t.args,u=o.Controller,a=c[u],l=a.key,r=[],e=s[u];(h===-1||i<h)&&o.CommandName!=="Delete"&&(!f.length||f.indexOf(u)>=0)&&(l.forEach(function(n){var t,i;o.Values.every(function(i){return i.Name===n.name&&(t=i),!t});i=t?t.Modified?t.NewValue:t.OldValue:null;r.push(i)}),e||(e=s[u]={map:{},list:[],key:l},n.push(u)),e.map[r.join(";")]||(e.map[r.join(";")]=!0,e.list.push(r.length>1?r:r[0])))});di(n,0,s,e)})),e.promise()}function di(t,r,f,e){var s=t[r++],h,c,y,v=[],a=[];s?(h=f[s],c=h.key,y=c.length>1,y?h.list.forEach(function(n){a.push("_match_:$all$");c.forEach(function(t,i){a.push(t.name+":="+JSON.stringify(n[i]))})}):(h.list.forEach(function(n,t){t&&v.push("$or$");v.push("%js%",JSON.stringify(n))}),a.push(c[0].name+":$in$"+v.join(""))),i.execute({controller:s,view:"offline",_filter:a,pageSize:h.list.length,pageIndex:0,requiresRowCount:!1,odp:!1,background:!0,nativeDates:!1}).done(function(c){function v(){o(()=>{di(t,r,f,e)})}var a=c[s];a.length?u.offline("query",{data:s}).then(function(t){var r=["(params){return "],e=h.key,c={},y={},p,o=i.syncMap[s],k=u.controllers[s]._map.fields,w,f,b=Sys.Application._components;e.forEach(function(n,t){t&&r.push("&&");r.push("this.",n.name,"===params.",n.name)});r=r.join("")+"}";a.length&&a.forEach(function(h){var g={},a,d;e.forEach(function(n){g[n.name]=h[n.name]});yt({from:t,where:{filter:r,params:g}}).then(function(r){var g,nt,tt;if(r)for(a in h)if(d=h[a],r[a]!=d){if(g=k[a],g&&g.onDemand&&(nt=u.blobUrlFormatStrings(0),tt=String.format(nt[0],g.onDemandHandler,h[e[0].name]),n.blobs.indexOf(tt)!==-1))continue;r[a]=d;p=!0}p?(c[s]=t,y[s]=!0,l({data:c,changed:y}).then(()=>{o||(o=i.syncMap[s]={});for(w in b)if(f=b[w],f._controller===s){o[f._id+"_"+f._viewId]=!0;break}v()})):v()})})}):e.resolve()}).fail(function(){e.resolve()})):e.resolve()}function gi(i,r,u,f){return i.changeMap={},$.when(!0).then(function(){return pr(i)}).then(function(){return wr(i)}).then(function(){return br(i,r)}).then(function(){function a(n){if(n>0){for(var t=0;t<n;t++)d(e[t]);e.splice(0,n);st.splice(0,n)}}var e=n.log,h=[],s,v;"Success"in i?(n.synced=p(),i.Success?e.length&&a(u[r.length-1].tx+1):(s=u[i.Index],v=s.index,a(s.tx-1),n.reconcile={errors:i.Errors,failedActionIndex:v}),e.forEach(function(n){var t=nt[n];t._changed&&(delete t._changed,h.push(c(n,t)))}),$.when.apply($,h).then(function(){l().then(function(){ki(i).then(function(){o(()=>{ui(f)})}).fail(function(){o(()=>{ui(f)})})})})):f.reject({message:t.InvalidResponse})})}function kr(){var t=$.Deferred(),i=[];return nt={},n.log.forEach(function(n){i.push(b(n).then(function(t){nt[n]=t}))}),$.when.apply($,i).done(function(){t.resolve()}),t.promise()}function ui(i){var r=n.reconcile;!s()||r?r?i.resolve():(g("done",t.Done),setTimeout(function(){i.resolve()},1500)):fi(i)}function nr(n){return n?p(n.time)+" "+(n.text||"")+(n.source?" - "+n.source:""):null}function fi(t,i,r,u){var s=y.maxCommitLogSize||10,f,e;arguments.length===1?(r=[],u={},st=[],o(()=>fi(t,0,r,u))):i<n.log.length&&r.length<s?(e=n.log[i],f=nt[e],i=st.length,i||(u.firstTransaction=f),f.log.forEach(function(n,t){u[r.length]={tx:i,index:t};r.push(n)}),st.push(f),o(()=>fi(t,i+1,r,u))):o(()=>dr(r,u,t))}function dr(n,r,u){var f=r.firstTransaction;f?(h(!0),et(nr(f)),i.restful({url:__servicePath+"/commit",method:"POST",cache:!1,dataType:"application/json",body:{log:n}}).then(t=>{h(!1),t=t.d||{},t.ExceptionType?u.reject({message:t.Message}):o(()=>gi(t,n,r,u))}).catch(n=>{h(!1),u.reject({message:t.UnableToProcess+" "+(navigator.onLine?n.code===400?t.ServerUnavailable:n.message:t.OfflineState)})})):gi({Success:!0,Values:[],Sequence:ri(!1)},n,r,u)}function tr(){function f(n){var f=u.errors,e=nr(n);typeof f!="string"&&(f=f.join("\n"));i.survey({text:t.Rec,text2:r.appName(),context:u,options:{modal:{max:"xs",fitContent:!0,always:!0},discardChangesPrompt:!1,materialIcon:"cloud_"+(s()?"upload":"done"),materialIcon:"cloud-sync"},questions:[{name:"tx",value:e||"***",text:t.Tx,options:{textStyle:"primary"},readOnly:!0},{name:"Status",value:t.RecRequired,text:"Status",options:{textStyle:"primary"},readOnly:!0},{name:"Error",value:"<b>"+i.htmlEncode(f)+"<\/b>",text:bt.Error,htmlEncode:!1,options:{textStyle:"primary"},readOnly:!0},{name:"Action",value:t.RecTxDelete,text:t.Action,options:{textStyle:"primary"},readOnly:!0}],submitText:bt.Apply,submit:"reconcile.app"})}var u=n.reconcile,e;u?(r.progress("hide"),u.failedActionIndex!=null?b(n.log[0]).then(function(n){f(n)}):f()):kt.refreshData?(r.busy(!0),e=wi()+"&ts="+p().replace(/\W/g,""),fetch(e).then(()=>{l({reset:!0}).then(function(){i.storage.set("odpIsOffline",null);ir()})}).catch(()=>{pt({message:t.ServerUnavailable+(navigator.onLine?"":" "+t.OfflineState)}),r.busy(!1)})):(r.progress("hide"),r.syncData(r.pageInfo()),ur(),r.notify({text:String.format(t.NotRefreshed+" "+t.LastRefresh,r.toSmartDate(new Date(n.created))),duration:"long"}))}function h(n){n&&r.notify(!1);r.busy({progress:n})}function ir(){location.replace(location.href)}function ei(){if(n.reconcile){tr();return}var u=Math.ceil(n.duration/1e3);u<60&&(u=u<60?t.DurationSec.replace(/NNNN/,u):t.DurationMin.replace(/NNNN/,Math.ceil(u/60)));i.survey({controller:"synchronize",text:t.Sync,text2:r.appName(),options:{modal:{max:"xs",fitContent:!0,always:!0},discardChangesPrompt:!1,materialIcon:"cloud_"+(s()?"upload":"done"),materialIconCloud:!0},questions:[{name:"lastSync",type:"datetime",value:new Date(n.synced||n.created),text:t.SyncLast,options:{textStyle:"primary"},readOnly:!0,visibleWhen:n.synced!=null},{name:"status",value:hi(!0),text:t.Status,options:{textStyle:"primary"},readOnly:!0},{name:"lastDownloaded",type:"datetime",value:new Date(n.created),text:t.RefreshLast,options:{textStyle:"primary"},readOnly:!0,visibleWhen:n.created!=null},{name:"duration",type:"Int32",value:u,text:t.Duration,options:{textStyle:"primary"},readOnly:!0},{name:"refreshData",text:t.RefreshData,type:"Boolean",value:n.refreshData==null||!s()?!0:n.refreshData===!0,items:{style:"CheckBox"},visibleWhen:s()}],submitText:s()?t.Sync:t.Refresh,submit:"synchronize.app"})}function g(n,i){r.progress("show",{text:i||t.Initializing,progress:n==="done"?1:null,content:`<i class="material-icon" style="font-size:144px;line-height:144px;left:50%;margin-left:-72px;opacity:.75;top:75%;margin-top:-72px;position:absolute;user-select:none">cloud${n?"_"+n:""}</i><div class= "app-screen-header"><span class="app-name">${ht.appName}</span><span>${t.Syncing}</span></div>`})}function rr(){n.controllers.forEach(function(n){k.indexOf(n.name)===-1&&k.push(n.name)})}function gr(){var t=i.storage.get("odpIsOffline");(!t||y.reset)&&u.offline("sync")&&g();n||b("OfflineSync.json").then(function(t){if(t)try{n=t;rr()}catch(r){}n?ni():(g("queue"),setTimeout(()=>{g("download"),n={user:i.userName(),controllers:[],relationships:{},log:[],blobs:[],fileCount:0,pk:{},sequence:1,created:p(),prevSyncDuration:i.userVar("prevSyncDuration")},n.refreshData=y.refreshData===!0,k.forEach(function(n){ai(n)}),i.storage.set("odpIsOffline",null),hr().then(v)},2e3))})}function p(n){return arguments.length?String.localeFormat("{0}",new Date(n)):(new Date).toISOString()}function ur(){r.refreshContext()}var i=$app,r=i.touch,u=i.odp,oi=Web.DataViewResources,t=oi.ODP,bt=oi.Mobile,e,w,y,k,ot=$.Deferred(),n=null,st,nt,tt=[],kt,ht,dt,it,ct,gt,f,lt,rt,ut,si=/\/blob(.ashx)?\?/,ft={},at={};f=i.host={data:{toStore:function(n){return n.match(si)?"blob":"data"},clear:function(n){return new Promise((t,i)=>{f.db().then(r=>{if(r.objectStoreNames.contains(n)){var u=r.transaction(n,"readwrite").objectStore(n);const f=u.clear();f.onerror=n=>{i(n)};f.onsuccess=()=>{t(u)}}else t({})})})},"delete":function(n){var t=$.Deferred();return f.db().then(i=>{const r=f.data.toStore(n),u=i.transaction(r,"readwrite").objectStore(r).delete(n);u.onerror=f._error;u.onsuccess=()=>{t.resolve(n)}}),t.promise()},write:function(n,t){var r=$.Deferred();return f.db().then(u=>{const o=f.data.toStore(n,t);var e=u.transaction(o,"readwrite").objectStore(o);const s=e.get(n);s.onerror=f._error;s.onsuccess=u=>{var o=u.target.result,s;if(o)o.data=t,o.modified=i.stringifyDate(new Date),s=e.put(o),s.onerror=f._error,s.onsuccess=()=>{r.resolve(o)};else{var h=i.stringifyDate(new Date),o={path:n,data:t,modified:h,created:h},c=e.add(o);c.onerror=f._error;c.onsuccess=()=>{r.resolve(o)}}}}),r.promise()},read:function(n){var t=$.Deferred();return f.db().then(i=>{const r=f.data.toStore(n);if(i.objectStoreNames.contains(r)){const u=i.transaction(r).objectStore(r).get(n);u.onerror=f._error;u.onsuccess=n=>{t.resolve(n.target.result||{})}}else t.resolve({})}),t.promise()}},_error:function(n){console.error(`Database error: ${n.target.error}`)},db:function(){return new Promise(n=>{if(f._db)n(f._db);else{var t=indexedDB.open("offline",2);t.onupgradeneeded=n=>{var t=n.target.result,i=t.createObjectStore("data",{keyPath:"path"}),r=t.createObjectStore("blob",{keyPath:"path"})};t.onsuccess=t=>{f._db=t.target.result,n(f._db)};t.onerror=f._error}})},guid:function(){return crypto.randomUUID?crypto.randomUUID():([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,n=>(n^crypto.getRandomValues(new Uint8Array(1))[0]&15>>n/4).toString(16))}};u.offline=function(t){var v=w.enabled!==!1&&y.enabled===!0&&k.length>0&&i.loggedIn(),r,o,h,f,p,d,c,l,a;if(arguments.length&&v){r=arguments[1];switch(t){case"icon":return navigator.onLine?s()?"material-icon-cloud-upload":"material-icon-cloud-done":"material-icon-cloud-off";case"tooltip":return hi(!0);case"status":return s()?"dirty":"synced";case"ensureData":return ot;case"query":return o=$.Deferred(),ot.done(function(){if("data"in r&&b(n.controllers.map[r.data].data).then(function(n){typeof n=="string"&&(n=JSON.parse(n));o.resolve(n)}),"controller"in r){var i=[],t=r.controller;Array.isArray(t)||(t=[t]);t.forEach(function(t){i.push(b(n.controllers.map[t].meta))});$.when.apply($,i).then(function(){for(var t=[],n=0;n<arguments.length;n++)t.push(arguments[n]);o.resolve(t)})}}),o;case"pk":return h=r.controller,f=n.pk[h],f==null&&(f=n.pk[h]=0),f--,n.pk[h]=f,f;case"forget":p=n.controllers.map[r.controller].data;ft[p]=null;break;case"saveBlob":return d=ci(r),c=fr(r),u.offline("sync",{controller:c.controller})?(l=or(c),tt.push(l),tt.push(u.updateBlob(d.odp,c)),l):!1;case"commitBlobs":return a=$.Deferred(),$.when.apply($,tt).then(function(){for(var t=[],i=arguments,n=1;n<i.length;n+=2)t.push(i[n]);a.resolve(t);tt=[]}).fail(function(){tt=[]}),a.promise();case"commit":return vr(r);case"sync":var g=!0,nt={},e=r&&r.controller;return e&&(e=r.controller,Array.isArray(e)||(e=[e]),k.forEach(function(n){nt[n]=!0}),e.forEach(function(n){nt[n]||(g=!1)})),g;case"toDataUrl":return!1}}else return v};$(document).on("beforetouchinit.app",function(){ht=__settings;w=ht.odp;w||(w=ht.odp={});y=w.sync;y||(y=w.sync={});k=y.controllers||[];lt=y.pages||[];rt=lt.slice(0);rt.push("pages/offline");var n=k.length>0;"enabled"in w||(w.enabled=n)}).on("menuinit.app",function(n){i.host&&lt&&(dt=n.menu,it=JSON.parse(JSON.stringify(dt)),li(it),i.online()||(n.nodes=it))}).on("context.app",function(n){var f,e;n.namespace==="app"&&i.loggedIn()&&(f=r.pageInfo(),(!f||!f.dataView||f.home)&&(!r.contextScope()||r.activePage().is(".app-reading-pane-master"))&&u.offline()&&(e={icon:u.offline("icon"),text:t.Sync,desc:t.OfflineState,toolbar:!1,sidebar:!1,system:!0,count:s(),callback:ei},n.context.splice(0,0,e,{})))}).on("offlinesyncinfo.app",function(){r.pageInfo().home?ei():i.alert(t.SaveAndSync)}).on("synchronize.app",function(t){kt=t.dataView.data();r.whenPageShown(function(){n.refreshData=kt.refreshData;t.namespace==="app"&&yr().then(tr).fail(pt)})}).on("reconcile.app",function(i){var u=i.survey.context;$app.touch.whenPageShown(()=>{u.failedActionIndex!=null&&(d(n.log[0]).then(()=>{n.log.splice(0,1)}),r.notify(t.RecTxDeleted)),u.blobs&&u.blobs.forEach(function(t){var i=n.blobs.indexOf(t);i!==-1&&n.blobs.splice(i,1)}),l({reconciled:!0}).then(()=>{ei()})})});$(document).on("starting.app",function(){u.offline()?gr():ot.resolve()});$(window).on("online offline",function(){it&&($(document).trigger($.Event("menuchanged.app",{nodes:i.online()?dt:it})),r.refresh())});$(document).on("logout.app",n=>{u.offline()&&(n.preventDefault(),r.busy(),i.confirm(t.LogoutWarning).then(()=>{r.notify(bt.Wait),r.busy(!0),i.userVar("prevSyncDuration",null),i.storage.set("odpIsOffline",null),f.data.clear("data").then(()=>f.data.clear("blob")).then(()=>caches.delete("user")).then(()=>o(n.callback))}))})})()