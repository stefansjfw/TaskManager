/*!
* Restful.js - RESTful Level 3 Client API
* Copyright 2022-2024 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function h(n){var t=n.match(/^(.+?)(\?|\#)/);return t?t[1]:n}function f(n,t){var r=n._links||n,i;return r&&(t&&(i=r.transit),i||(i=r.self)),i}function e(n,t,i,r){return{error:{errors:[{id:"00000000-0000-0000-0000-000000000001",reason:i,message:r.message||r}],code:n,message:t}}}var i=typeof $app=="undefined"?null:$app,s=window,n={},r={},o="",t,u;(i||(s.$app=i={}),u=i.restful,!u||u._unresolved)&&(u=i.restful=function(s){var y,b,p,g,k,d,l,v,w,c,a;if(s||(s={url:null,method:"GET",body:null}),y=s.config,n=y||n,!y||(t=y.baseUrl||t,Object.keys(s).length!==1)){if(!t&&(t=typeof __baseUrl=="undefined"?null:__baseUrl,!t))for(b=document.getElementsByTagName("script"),p=0;p<b.length;p++)if(g=b[p],k=(g.getAttribute("src")||"").match(/^(.+?)(\/v\d\/js|\/js\/sys)\/restful.*?\.js/),k){t=k[1];d=t.match(/^(\w+\:\/\/(.+?))\//);o=d?d[1]:t;break}return l=s.token||(s.token!==!1&&n.token?typeof n.token=="function"?n.token():n.token:null),v=typeof l=="string"?l:l&&typeof l=="object"?l.access_token:null,!v&&i.AccountManager&&(l=i.AccountManager.current(),l&&(v=l.access_token)),w=s.context,w&&(w._links&&(s.url=w._links.self||s.url),delete s.context),s.url&&s.url.href&&(s.method=s.url.method,s.url=s.url.href),c=s.url||(t?"~/v2":"/v2"),a=s.baseUrl||t,a&&(a.match(/\/$/)||(a+="/"),c.match(/^~\//)?c=a+c.substring(2):c.match(/^(http|\/)/)?c.match(/^\//)&&(c=(s.baseUrl||o)+c):c=a+c),new Promise((t,o)=>{function kt(n){s.token=n;u(s).then(n=>{t&&t(n)}).catch(d)}function d(n){o&&o(n.error||n)}function dt(n){var t,e,u,i,f;if(it==="GET")!s.cache||c in r||(r[c]={result:n,date:(new Date).getTime(),responseStatus:ft,contentType:k,contentDisposition:g,etag:p,isTextResponse:nt,isRawResponse:tt},r._changed=!0);else if(r._changed)for(t=c.match(/^http/i)?new URL(c):new URL(c,location.origin),t=new URL(t.pathname,t.origin),e=s.cacheTrimDepth||2;!t.pathname.match(/\/v2$/);){u=t.href;for(i in r)(i===u||i.startsWith(u+"?")||i.startsWith(u+"/"))&&delete r[i];if(!--e)break;if(f=t.pathname.lastIndexOf("/"),f===-1)break;t=new URL(t.pathname.substring(0,f),t.origin)}}function gt(){var t=s.cache,n=t&&r[c],i;if(n)if(i=typeof t=="number"?t:600,(new Date).getTime()-n.date>i*1e3)delete r[c];else return pt=!0,ft=n.responseStatus,k=n.contentType,g=g,p=n.etag,nt=n.isTextResponse,tt=n.isRawResponse,Promise.resolve(n.result);return fetch(c,bt)}var w=new Headers,it=s.method||"GET",y=s.hypermedia,a=s.body,wt=a&&a instanceof FormData,et,rt,lt,ot,b,st,at,ht,ut,vt,yt,ct,bt,ft,k,g,p,nt,tt,pt;if(typeof y=="string"&&y.length&&(rt=y.match(/^(.+?)(\s*(>>)\s*(.*))?$/),rt&&(y={name:rt[1],transition:!!rt[3],next:rt[4]})),v&&w.append("Authorization","Bearer "+v),w.append("Accept",s.accept||"application/json"),it==="GET"||wt||w.append("Content-Type",s.contentType||"application/json"),s.headers)for(lt in s.headers)w.append(lt,s.headers[lt]);if(s.schema&&(et="true"),s.schemaOnly&&(et="only"),et&&w.append("X-Restful-Schema",et),y===!1&&w.append("X-Restful-Hypermedia","false"),ot=s.query,p=s.etag,ot){if(at=c.match(/^http/i)?new URL(c):new URL(c,location.origin),!y)for(ht in ot)ut=ot[ht],ht==="fields"&&typeof ut=="object"&&(ut=JSON.stringify(ut).replace(/\:null/g,"").replace(/\"/g,"")),at.searchParams.set(ht,ut);c=at.toString()}if(a&&typeof a=="object"&&!wt){p===!0&&(st=a._links,p=st&&st.self&&st.self.etag);for(vt in a)yt=a[vt],yt instanceof Blob&&(b||(b=[]),b.push({f:vt,v:yt}));b&&(b.forEach(n=>delete a[n.f]),w.delete("Content-Type"));a=JSON.stringify(a)}typeof p=="string"&&w.append("If-Match",p);b&&(ct=new FormData,ct.set("",new Blob([a],{type:"application/json"}),""),b.forEach(n=>ct.set(n.f,n.v,n.v.name||"")),a=ct);bt={method:it,headers:w,body:it==="GET"?null:a,redirect:"follow"};tt=s.dataType==="response";gt().then(function(n){return pt?n:(ft=n.status,k=n.headers.get("Content-Type")||"",g=n.headers.get("Content-Disposition"),p=n.headers.get("ETag"),nt=!tt&&ft!==401&&k.match(/^(application\/(json|x-yaml|xml)|text\/(yaml|x-yaml|xml))/)!=null,tt?n:nt?n.text():n.arrayBuffer())}).then(r=>{var ot,a,v,rt,st,w,lt,et,o,ht,ct;if(ft===401)l&&l.refresh_token?i.refreshUserToken?i.refreshUserToken(l,()=>{kt(i.AccountManager.current())}):u({url:"/oauth2/v2/token",method:"POST",body:{grant_type:"refresh_token",client_id:n.clientId,refresh_token:l.refresh_token},token:!1}).then(t=>{var i,r;if(typeof n.token=="function"){if(i=n.token(),typeof i=="object")for(r in t)i[r]=t[r];n.token(i)}s.token=t;kt(t)}).catch(d):d(e(401,"Unauthorized","access_denied","Invalid access token or API key is specified."));else if(t)if(dt(r),tt)t(r);else if(nt&&k.match(/^application\/json/))if(r!=null&&r.length||(r="{}"),r=JSON.parse(r),r&&r.error)r.error._schema=r._schema,d(r.error);else{if(p&&r._links&&(ot=f(r),ot&&(ot.etag=p)),a=y&&y.name,a){var ut=r._links,b=y.transition,at=a.match(/^\./);if(at)if(v=r,a.substring(1).split(/\./g).forEach(n=>{v!=null&&n.length&&(v=v[n])}),b)r=typeof v=="string"?{href:v}:v;else{t(v);return}else ut?(rt=ut[a],rt?r=rt:ut["restful.js"]?(rt=r[a],rt&&(r=f(rt,b))):r=null,!r&&b&&(st=f(ut,b),r={href:h(st?st.href:c)+"/"+a})):r=null;if(r==null||b&&!r.href)d(e(400,"Bad Request","invalid_hypermedia","Hypermedia '"+a+"' not found in "+it+" "+c+" response."));else if(b){if(w=s.restore,w){for(o in w)w[o]==null?delete s[o]:s[o]=w[o];s.restore=w=null}lt=new RegExp(RegExp("^"+a+"\\s*>>"));for(o in s)if(o.match(lt)){if(s.restore=w={},["body","query","headers","files","etag","schema","schemaOnly","accept","contentType"].forEach(n=>{w[n]=s[n],delete s[n]}),et=s[o],et)for(o in et)s[o]=et[o];break}s.url=r;s.hypermedia=y.next;u(s).then(n=>{t(n)}).catch(d);return}}y===!0&&(r=r._links||{});t(r||{})}else nt||pt||(ht="file."+(k.split(";")[0]||"/dat").split(/\//)[1],g&&(ct=g.match(/filename=(.+?)(;|$)/),ct&&(ht=ct[1])),r=new Blob([r],{type:k}),r.name=ht),t(r)}).catch(n=>{d(e(400,"Bad Request","error",n))})})}})})()